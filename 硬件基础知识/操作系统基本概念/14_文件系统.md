---
title: 14_文件系统
tags: 
---

[toc]

#### 文件系统 (FS, File System)

文件系统是用于在存储介质上组织和存取数据的软件。它提供了数据分组的抽象机制（文件，目录等），以及在此抽象机制上的操作接口。文件系统有很多种，以适应不同的底层存储机制（如硬盘，光盘，网络等），达到不同的设计目标（如速度，灵活性，安全等）。

##### 磁盘文件系统 (Disk file system)

磁盘文件系统借助于磁盘的随机读写能力，提供方便而高效的文件服务。它通常把存储介质抽象为 _卷_（Volume），即逻辑磁盘，一个卷可能对应一个或多个物理磁盘或磁盘分区。常见的磁盘文件系统包括以下几种：

*   FAT(File Allocation Table) 家族是支持最广泛的文件系统。FAT 把卷的空间分为三个部分：_目录表_，_文件分配表_ 和 _数据区_ 。其中数据区被分为不同的 _簇_ (cluster)，每个簇包含 N （N 可以为 1, 2, 4, 8, 16, 32, 64, 128）个物理连续的扇区。文件内容存储在这些簇中，单个文件至少占用一个簇。文件分配表中为记录了每个簇的使用情况：未使用，文件末尾，同文件下个簇的编号。这样，文件内容所使用的簇就形成了一个单链表。磁盘上存有两份文件分配表，以便在数据损坏或硬件故障时进行恢复。目录表中记录每个文件/目录的名称，属性，存取日期等元数据，以及内容起始簇的编号等。FAT 中文件名最长为 8 个字符加上 3 个字符的扩展名（称为 8.3 文件名格式），Windows 95 以后对此进行了扩展，最多可达 255 个 UCS-2 字符。目前最常用的 FAT32 中单个文件不能超过 4 GB，单卷（逻辑磁盘）不能超过 2 TB(格式化为 4KB 扇区时为 16 TB)。

*   exFAT 是在 FAT32 的基础上，专门为闪存设备设计的文件系统，通常用于移动存储，移动设备或嵌入式系统。它放宽了 FAT32 对文件和卷尺寸的限制。exFAT 中只有一份文件分配表，它支持对连续的文件内容使用扩展（extend），而忽略文件分配表中的数据，从而减少了文件修改时对闪存的写入量。Windows 10 仅允许 32 GB 以上的分区格式化为 exFAT, 更小的分区会被推荐使用 FAT32 格式。

*   NTFS (New Technology File System) 是 Windows 的默认文件系统，在 macOS 和 Linux 中也能作为只读装载。NTFS 中，文件/目录的所有信息都是 _属性_（Attribute），包括文件内容（称为 _流_ ，一个文件可以有多个流，其中至少有一个是默认流，其它的需要单独命名）。这些属性都保存在主文件表(Master File Table, MFT)的记录里，每条记录大小为 1 KB。如果空间足够，一个文件仅需要这么一条记录即可，无需另外分配磁盘空间；如果空间不足以容纳所有的属性，则会把部分属性存储在同卷的其它地方，在MFT中记录这些位置。NTFS 使用了日志系统，保证文件系统元数据不被意外破坏。

*   ext系列(ext2/ext3/ext4)是 Linux 下常用的文件系统。ext2 中每个文件或目录对应一个 _索引节点_ (inode, index node)，其中记录了文件的尺寸，权限等信息，以及数据块的位置（指针）。单个 inode 中可以有 15 个指针：其中前 12 个直接指向数据块；第 13 个是间接指针，它指向一个指针块，指针块中包含若干指向数据块的指针；第 14 个是双重间接指针，指向指向指针块的指针块；第 15 个是三重间接指针。ext3 在 ext2的基础上增加了日志功能，提升了系统故障时的容错性。ext4 支持更大的卷，为元数据和日志添加了校验码，同时在其它方面也有更多的改进。这些文件系统也可以通过第三方软件在 Windows/macOS 中受限使用（部分特性不受支持）。

*   ZFS 是一种独特的先进文件系统，在 Solaris 操作系统中原生可用，也可通过第三方软件在 Linux/macOS 中使用。ZFS 为长期大量数据存储而设计，有多种安全措施来防止软硬件错误带来的数据丢失：所有数据都存有多层级校验码，数据和校验码可存储多份，支持写入日志，提供软 RAID。功能上它支持快照，写时复制(copy-on-write)；性能上，ZFS 支持多级缓存设备，如内存和固态硬盘。与大部分其它文件系统不同的是，ZFS 还提供了虚拟设备的功能，在虚拟设备上可以使用其它文件系统，这样可以用 ZFS 提供优异的性能和数据安全性，同时使用其它文件系统的功能。ZFS 是新一代文件系统中较为成熟和完善的，但是潜在的版权法律问题，限制了它在 Linux 各发行版中的采用率。

*   Btrfs(B-tree file system) 基于写时复制(copy-on-write)的原则，解决传统文件系统中欠缺存储池，快照，校验码，多设备整合等功能的问题。功能上它和 ZFS 类似，经过完善和成熟后，有希望成为未来 Linux 的默认文件系统。

*   ReFS(Resilient File System) 是微软设计开发的新一代文件系统，类似 ZFS 和 Btrfs，尚未大规模普及，目前仅在 Windows Server 和 Windows 10 企业版本可用。

##### 网络文件系统 (Network File System)

网络文件系统作为远程文件访问协议的客户端，提供服务器上文件的存取服务。常见的网络文件系统(及类似系统）包括以下几种：

*   NFS(Network File System) 是一套分布式文件系统协议的开放标准。目前主要在 unix 系统上应用，在 macOS 和 Windows 下使用较少。目前主流使用的 NFS v3 以上版本，可选使用 TCP 或 UDP 作为底层传输协议。NFS v4 及以后的版本只使用一个端口 2049。

*   SMB(Server Message Block) 也叫 CIFS(Common Internet File System)，是 Windows 自带的网络协议，用于共享文件，打印机等。macOS 自带了 SMB 支持, Linux 可使用包 `cifs-utils` 和 `samba` 来使用该协议。SMB v2.0 及以后的版本基于 TCP, 使用端口 445。

*   9P(Plan 9 File System Protocol) 是一套轻量级的远程文件系统协议，经常用于虚拟机与外界的文件共享。WSL2(Windows Subsystem for Linux 2) 就使用了该协议与 Linux 文件系统交互。 9P 通常使用 TCP 端口 564。

*   WebDAV(Web Distributed Authoring and Versioning) 是 HTTP 的扩展，允许客户端执行远程文件编辑操作。它在标准的 HTTP 方法(GET, POST, PUT, DELETE 等)外，添加了新的方法：COPY, LOCK, UNLOCK, MKCOL, MOVE, PROPFIND, PROPPATCH。主流 HTTP 服务器(Nginx, Apache, IIS 等)都有内置或第三方的 WebDAV 支持，部分私人云软件(ownCloud, Nextcloud等)也支持 WebDAV 访问方式。 Windows 集成了 WebDAV 客户端。WebDAV 和 HTTP/HTTPS 使用相同的端口，默认为 80 和 443。

*   FTP(File Transfer Protocol) 是用于文件传输的标准网络协议，应用十分广泛。FTP 的控制流和数据流使用不同的端口（通常是21 和 20）。数据连接可选主动或被动模式，被动模式下服务器侦听客户端的请求，可解决客户端由于 NAT 或防火墙等原因无公开端口的问题。 FTP 可设置为匿名连接，也可使用明文传输的用户名/密码进行身份认证。FTPS(FTP Secure) 在 FTP 的基础上增加了数据加密的功能，以提升安全性，它通常使用 990(控制)和 989 端口。

*   SFTP(SSH File Transfer Protocol) 用于在安全数据连接上管理和传输文件。它是 SSH(Secure Shell)协议的扩展，通常由 SSH 服务器提供支持，但是也可以作为独立的文件服务使用。一般 SFTP 和 SSH 使用同一端口 22。