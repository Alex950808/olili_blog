---
title: 03_DMA
tags: 
---

DMA(Direct Memory Access,直接存储器访问)是指外部设备不通过CPU而直接与系统内存交换数据的接口技术,适合批量数据传送，整个过程主要由DMA控制器完成。

#### DMA的由来

在ＤＭＡ出现之前，CPU与外设之间的数据传送方式有程序传送方式. 中断传送方式。CPU是通过系统总线与其他部件连接并进行数据传输。

1. 程序传送方式

	程序传送方式是指直接在程序控制下进行数据的输入/输出操作。分为无条件传送方式和查询(条件传送方式)两种。

	无条件传送方式

	 微机系统中的一些简单的外设，如开关. 继电器. 数码管. 发光二极管等，在它们工作时，可以认为输入设备已随时准备好向CPU提供数据，而输出设备也随时准备好接收CPU送来的数据，这样，在CPU需要同外设交换信息时，就能够用IN或OUT指令直接对这些外设进行输入/输出操作。由于在这种方式下CPU对外设进行输入/输出操作时无需考虑外设的状态，故称之为无条件传送方式。

	查询(有条件)传送方式 

	查询传送也称为条件传送，是指在执行输入指令（IN）或输出指令（OUT）前，要先查询相应设备的状态，当输入设备处于准备好状态. 输出设备处于空闲状态时，CPU才执行输入/输出指令与外设交换信息。为此，接口电路中既要有数据端口，还要有状态端口。

2. 中断传送方式

	中断传送方式是指当外设需要与CPU进行信息交换时，由外设向CPU发出请求信号，使CPU暂停正在执行的程序，转而去执行数据输入/输出操作，待数据传送结束后，CPU再继续执行被暂停的程序。

	以上两种方式，均由CPU控制数据传输，不同的是程序传送方式由CPU来查询外设状态，CPU处于主动地位，而外设处于被动地位。这就是常说的----对外设的轮询，效率低。而中断传送法师则是外设主动向CPU发生请求，等候CPU处理，在没有发出请求时，CPU和外设都可以独立进行各自的工作。  需要进行断点和现场的保护和恢复，浪费了很多CPU的时间，适合少量数据的传送。
	
#### DMA原理

DMA的出现就是为了解决批量数据的输入/输出问题。DMA是指外部设备不通过CPU而直接与系统内存交换数据的接口技术。这样数据的传送速度就取决于存储器和外设的工作速度。

通常系统总线是由CPU管理的，在ＤＭＡ方式时，就希望CPU把这些总线让出来，即CPU连到这些总线上的线处于第三态(高阻状态)，而由DMA控制器接管，控制传送的字节数，判断DMA是否结束，以及发出DMA结束信号。因此DMA控制器必须有以下功能:

1. 能向CPU发出系统保持(HOLD)信号，提出总线接管请求；
2. 当CPU发出允许接管信号后，负责对总线的控制，进入DMA方式;
3. 能对存储器寻址及能修改地址指针，实现对内存的读写；
4. 能决定本次DMA传送的字节数，判断DMA传送是否借宿。
5. 发出DMA结束信号，使CPU恢复正常工作状态。

DMA传输将从一个地址空间复制到另外一个地址空间。当CPU初始化这个传输动作，传输动作本身是由DMA控制器来实行和完成。  典型例子---移动一个外部内存的区块到芯片内部更快的内存区。

对于实现ＤＭＡ传输，它是由DMA控制器直接掌管总线（地址总线、数据总线和控制总线），因此，存在一个总线控制权转移问题

- DMA传输开始前：　　　　CPU------>DMA控制器
- DMA传输结束后：              DMA控制器------>CPU

一个完整的DMA传输过程必须经历DMA请求、DMA响应、DMA传输、DMA结束4个步骤。

DMA方式是一种完全由硬件进行组信息传送的控制方式，具有中断方式的优点，即在数据准备阶段，CPU与外设并行工作。

#### DMA的传送过程

DMA的数据传送分为预处理、数据传送和后处理3个阶段。

1. 预处理

由CPU完成一些必要的准备工作。首先，CPU执行几条I/O指令，用以测试I/O设备状态，向DMA控制器的有关寄存器置初值，设置传送方向、启动该设备等。然后，CPU继续执行原来的程序，直到I/O设备准备好发送的数据(输入情况)或接受的数据(输出情况)时，I/O设备向DMA控制器发送DMA请求，再由DMA控制器向CPU发送总线请求(统称为DMA请求)，用以传输数据。

2. 数据传送

DMA的数据传输可以以单字节(或字)为基本单位，对于以数据块为单位的传送(如银盘)，DMA占用总线后的数据输入和输出操作都是通过循环来实现。需要特别之处的是，这一循环也是由DMA控制器(而不是通过CPU执行程序)实现的，即数据传送阶段是完全由DMA(硬件)来控制的。

3. 后处理

DMA控制器向CPU发送中断请求，CPU执行中断服务程序做DMA结束处理，包括检验送入主存的数据是否正确，测试传送过程中是否出错(错误则转入诊断程序)和决定是否继续使用DMA传送其他数据块等。

-----------------------------------

本文参考 [书中倦客的 DMA之理解](https://blog.csdn.net/zhejfl/article/details/82555634)