---
title: ftp理解 
tags: 
renderNumberedHeading: true
grammar_cjkRuby: true
---

[toc?theme=color]

目前比较常用的FTP服务端程序是 vsftpd 和 proftpd
FTP协议的两种工作方式
1.port方式：主动模式
2.pasv方式：被动模式

##### 连接过程
__port (主动)__ 方式的连接过程是：客户端向服务器的FTP端口（默认是21）发送连接请求，服务器接受连接，建立一条命令链路。当需要传送数据时，服务器从20端口向客户端的空闲端口发送连接请求，建立一条数据链路来传送数据。[即当需要传送数据时,客户端在命令链路上用PORT命令告诉服务器"我打开了\*\*\*X端口，你过来连接我"。于是服务器从20端口向客户端的\*\*\*X端口发送连接请求，建立一条数据链路来传送数据。]

__pasv (被动)__ 方式的连接过程是：客户端向服务器的FTP端口（默认是21）发送连接请求，服务器接受连接，建立一条命令链路。当需要传送数据时，客户端向服务器的空闲端口发送连接请求，建立一条数据链路来传送数据。[即当需要传送数据时,服务器在命令链路上用PASV命令告诉客户端"我打开了\*\*\*X端口，你过来连接我"。于是客户端向服务器的\*\*\*X端口发送连接请求，建立一条数据链 路来传送数据。]

==FTP是仅基于tcp的服务，不支持udp #F44336==。FTP使用2个端口，一个数据端口和一个命令端口（也可叫做控制端口）。通常来说这两个端口是21（命令端口）和20（数据端口）。但FTP工作方式的不同，数据端口并不总是20，这就是主动与被动FTP的最大不同之处。

##### 工作流程
__主动模式的FTP工作流程__：客户端从一个任意的非特权端口N（N>1024）连接到FTP服务器的命令端口，也就是21端口。然后客户端开始监听端口N+1，并发送FTP命令"portN+1"到FTP服务器。接着服务器会从它自己的数据端口（20）连接到客户端指定的数据端口（N+1）。针对FTP服务器前面的防火墙来说，必须允许以下通讯才能支持主动方式FTP：
1.任何大于1024的端口到FTP服务器的21端口。（客户端初始化的连接）
2.FTP服务器的21端口到大于1024的端口。（服务器响应客户端的控制端口）
3.FTP服务器的20端口到大于1024的端口。（服务器端初始化数据连接到客户端的数据端口）
4.大于1024端口到FTP服务器的20端口（客户端发送ACK响应到服务器的数据端口）

主动FTP：
命令连接：客户端>1024端口  --> 服务器 21端口
数据连接：客户端>1024端口 <-- 服务器 20端口

__被动模式的FTP工作流程(有效解决了服务器发起到客户的连接问题)__ 当客户端通知服务器它处于被动模式时才启用。在被动方式FTP中，命令连接和数据连接都由客户端发起，这样就可以解决从服务器到客户端的数据端口的入方向连接被防火墙过滤掉的问题。当开启一个FTP连接时，客户端打开两个任意的非特权本地端口（N>1024和N+1）。第一个端口连接服务器的21端口，但与主动方式的FTP不同，客户端不会提交PORT命令并允许服务器来回连它的数据端口，而是提交PASV命令。这样做的结果是服务器会开启一个任意的非特权端口（P>1024），并发送PORTP命令给客户端。然后客户端发起从本地端口N+1到服务器的端口P的连接用来传送数据。对于服务器端的防火墙来说，必须允许下面的通讯才能支持被动方式的FTP:
1.从任何大于1024的端口到服务器的21端口（客户端初始化的连接）
2.服务器的21端口到任何大于1024的端口（服务器响应到客户端的控制端口的连接）
3.从任何大于1024端口到服务器的大于1024端口（客户端初始化数据连接到服务器指定的任意端口）
4.服务器的大于1024端口到远程的大于1024的端口（服务器发送ACK响应和数据到客户端的数据端口）

被动FTP：
命令连接：客户端>1024端口 --> 服务器 21端口
数据连接：客户端>1024端口 --> 服务器>1023端口

==主动与被动FTP优缺点 #E91E63==
主动FTP对FTP服务器的管理有利，但对客户端的管理不利。因为FTP服务器企图与客户端的高位随机端口建立连接，而这个端口很有可能被客户端的防火墙阻塞掉。
被动FTP对FTP客户端的管理有利，但对服务器端的管理不利。因为客户端要与服务器端建立两个连接，其中一个连到一个高位随机端口，而这个端口很有可能被服务器端的防火墙阻塞掉。

随着WWW的广泛流行，许多人习惯用web浏览器作为FTP客户端。大多数浏览器只在访问 ftp://这样的URL时才支持被动模式。这到底是好还是坏取决于服务器和防火墙的配置。通常情况下会选用被动模式的FTP。

##### 登录的用户类型
FTP的用户有三种类型：==匿名用户、系统用户、虚拟用户 #E91E63==。
==匿名登录 #E91E63==：在登录FTP时使用默认的用户名，一般是ftp或anonymous。
==本地用户登录 #E91E63==：使用系统用户登录，在/etc/passwd中。
==虚拟用户登录 #E91E63==：这是FTP专有用户，有两种方式实现虚拟用户，本地数据文件和数据库服务器。

FTP虚拟用户是FTP服务器的专有用户，使用虚拟用户账号可以提供集中管理的FTP根目录，方便了管理员的管理，同时将用于FTP登录的用户名、密码与系统用户账号区别开，进一步增强了FTP服务器的安全性。某种意义上来说，==匿名用户也是系统用户，只是系统用户的一个映射 #E91E63==。公开的FTP都不会使用系统用户作为FTP帐号，而更多的采用了虚拟用户，这样能保证系统的安全性。

使用虚拟用户登录FTP服务器，可以避免使用操作系统帐号作为FTP用户带来的一些安全问题，也便于通过数据库或其它程序来进行管理。虚拟用户的特点是只能访问服务器为其提供的FTP服务，而不能访问系统的其它资源。所以，如果想让用户对FTP服务器站内具有写权限，但又不允许访问系统其它资源，可以使用虚拟用户来提高系统的安全性。

在VSFTP中，认证这些虚拟用户使用的是单独的口令库文件（pam_userdb），由可插入认证模块（PAM）认证。使用这种方式更加安全，并且配置更加灵活。基本流程：FTP用户访问->PAM配置文件（由vsftpd.conf中pam_service_name指定）->PAM论证->区别用户读取配置文件（由vsftpd.conf中user_config_dir指定配置文件路径，文件名即用户名）。有两种方式建立FTP的虚拟用户，分别是：本地数据文件方式、数据库服务器（MySQL）方式

