---
title: Linux入门到精通实战
tags: 小书匠语法,技术
renderNumberedHeading: true
grammar_abbr: true
grammar_table: true
grammar_defList: true
grammar_emoji: true
grammar_footnote: true
grammar_ins: true
grammar_mark: true
grammar_sub: true
grammar_sup: true
grammar_checkbox: true
grammar_mathjax: true
grammar_flow: true
grammar_sequence: true
grammar_plot: true
grammar_code: true
grammar_highlight: true
grammar_html: true
grammar_linkify: true
grammar_typographer: true
grammar_video: true
grammar_audio: true
grammar_attachment: true
grammar_mermaid: true
grammar_classy: true
grammar_cjkEmphasis: true
grammar_cjkRuby: true
grammar_center: true
grammar_align: true
grammar_tableExtra: true
---

[toc]

**京峰教育Linux入门到精通企业实战**  

# Linux基础篇

Linux基础篇总共包含8个章节，第1章到第8章学习内容分别包括：Linux快速入门、Linux发展及系统安装、CentOS Linux系统管理、Linux必备命令、Linux用户和组、Linux软件包管理、磁盘管理、Linux文件共享管理等。

读者通过对基础篇8个章节的深入学习，可以更加了解Linux发展历程，了解Linux发行版之间的特性以及Linux内核命名规范，基于虚拟机环境手动安装CentOS操作系统，能够快速上手，快速的入门Linux。

同时能够熟练掌握Linux操作系统完整的流程，掌握Linux操作系统用户和组管理的机制，对Linux系统文件及目录进行权限定制和分配，从而提升Linux操作系统使用安全，更加保证系统的稳定性。

对Linux必备命令的掌握程度，直接决定后期对Linux系统能否进行娴熟的操作，同时掌握Linux高效学习大绝招，养成学习Linux的习惯和方法，对后期的Linux学习能起到事半功倍的效果。

俗话说“基础不牢，地动山摇”，熟练掌握Linux基础必备篇的相关内容，能够独立维护和管理企业Linux操作系统，为后期维护企业生产环境服务器打下坚实的基础。

# Linux进阶篇

Linux进阶篇总共包含6个章节，第9章到第14章学习内容分别包括：HTTP协议详解、Apache WEB服务器企业实战、MySQL数据库服务器企业实战、LAMP企业架构实战、Zabbix分布式监控系统实战、Nginx高性能WEB服务器实战等。

读者通过对进阶篇6个章节的深入学习，可以基于基础篇学习的Linux操作系统管理，快速上手独立维护和管理企业各种服务，例如主流的Apache、Nginx WEB服务器，深入学习HTTP协议，掌握HTTP底层通信原理等。

同时能熟练构建企业级数据库管理集群，MySQL主从复制，一主多从、读写分离实战保证网站数据的完整，对数据库配置文件进行调优、增加索引提供数据查询效率，如果数据库异常或者缓慢，可以基于MySQL慢查询日志定位慢SQL。

进阶篇引入Redis高性能缓存服务器，互联网各大公司都在使用Redis，熟练掌握Redis对升职加薪及网站性能有巨大的帮助，Redis缓存还可以提高用户访问WEB网站的效率，增强用户体验。同时随着企业服务器不断增加，基于Zabbix分布式监控系统能够实时监控服务器CPU、内存、硬盘、网卡及服务器上各种应用的监控，做到有故障第一时间给相关人员发送微信报警，第一时间处理问题。

互联网主流WEB服务器软件Nginx，得到各大企业的SA的青睐，应用也非常的广泛，对Nginx深入掌握，对运维能力的提升是非常大的，通过进阶篇的对Nginx的深入学习，能够熟练掌握Nginx工作原理、安装配置、管理升级、负载均衡及动静分离、虚拟主机、参数调优、Nginx Location、Nginx Rewrite、日志切割、防盗链、HTTPS等核心技术，能更好的维护生产环境Nginx高性能 WEB服务器。

# Linux高级篇

Linux进阶篇总共包含9个章节，第15章到第38章学习内容分别包括：Linux性能优化、大数据量备份、Shell企业实战基础、Shell实战高级编程、自动化运维趋势、Puppet自动化运维实战、Ansible自动化运维实战、Jenkins企业级自动化实战、企业级高并发网站集群、Docker、K8S、Hadoop、Ceph、CI/CD、MQ、ZK、ETCD等。

读者通过对进阶篇9个章节的深入学习，可以能够独立维护和管理企业上百台、千台服务器，能够在企业中独当一面，打造企业级千万PV门户网站架构。

同时能够掌握对MYSQL 2T+大数量的备份，Linux服务器内核进行优化、对内核故障排错，服务器异常能够快速解决，编写企业生产环境各种Shell脚本工具，实现网站自动化维护和部署、Shell高级实战编程章讲述了11个高级实战脚本案例满足企业各种场景使用，基于Shell编程独立开发各种脚本，例如：构建网站服务器数据备份、LAMP、LNMP一键安装部署、服务器硬件信息收集存入DB、MYSQL主从实战、自动修改千台服务器IP、Zabbix自动部署客户端、Nginx、Tomcat自动部署、Docker虚拟化管理平台、Bind高级管理等脚本等。

对Linux高级篇的学习能够完全胜任万台服务器的维护和管理，基于Puppet各种案例实现主动部署管理、客户端自动获取配置、批量管理服务器等，通过轻量级Ansible自动化部署工具，实现至少1000台服务器的运维和管理，通过各种资源模块对服务器进行管理，同时可以编写Playbook剧本实现对服务器流程化管理，减轻人工干预，实现对服务器和web网站高效维护。

高级篇引入Jenkins自动化部署平台，讲述传统网站部署、主流网站部署的方法，基于Jenkins构建企业级自动化平台，支持SVN、GIT仓库，结合Ansible自动化运维工具打造企业级自动化部署平台，让运维工作更加的轻松。

本篇最后一个章节以9个企业级高级实战集群部署，例如Nginx+keepalived、Redis+keepalived、LVS+Keepalived、Haproxy+keepalived满足企业各个应用环境的部署，真正学以致用，满足企业高速的发展！

# 第一章 Linux快速入门

Linux是一套免费使用和自由传播的[类UNIX](http://baike.baidu.com/item/%E7%B1%BBUnix)[操作系统](http://baike.baidu.com/item/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/192)，是一个基于[POSIX](http://baike.baidu.com/item/POSIX)移植操作系统接口（Portable Operating System Interface of UNIX，POSIX）和[UNIX](http://baike.baidu.com/item/UNIX)的多用户、[多任务](http://baike.baidu.com/item/%E5%A4%9A%E4%BB%BB%E5%8A%A1)、支持[多线程](http://baike.baidu.com/item/%E5%A4%9A%E7%BA%BF%E7%A8%8B)和多[CPU](http://baike.baidu.com/item/CPU)的操作系统。

目前被广泛使用于企业服务器、WEB网站平台、大数据、虚拟化、Android、超级计算机等领域，未来Linux将应用各行各业，例如云计算、物联网、人工智能等。

本章向读者介绍Linux发展简介、Linux发行版特点、32位及64位CPU特性及Linux内核命名规则。

## 为什么要学习Linux

我们为什么要学习Linux？我们目前的处境是什么？我们想达到什么样的目标？在谈到这三个问题时，相信每个人都有自己的答案，我们来自不同的家庭，各种经历也都不一样，但最终的目标都是希望通过学习技术，提升自己的专业技术。真正做一个对社会有贡献的人。

想想我们刚步入学堂的那一刻起，心里就狠狠下决心，以后不管做什么，都要有一番出息，可是20年、30年过去了，我们收获了什么，得到了什么，到底是在追求什么？方向又在哪里呢？

在生活中各种挫折、感情、生活以及很多零碎的事情，让我们很难静下心来学习，当我们某天突然惊醒，年少已不在。所以今天就下定决心，现在就要学习，去行动，去改变。

人生最可怕的是在自以为舒适的地方待得太久，等到外界改变来的时候，已经晚了，我们不能像温水煮青蛙一样，待在温水里，没有觉察到周围事物的变化，最终被社会所淘汰,如图1-1所示。

![图1-1 温水煮青蛙](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855188.jpg)

## Linux操作系统简介

Linux操作系统是基于UNIX以网络为核心的设计思想，是一个性能稳定的多用户网络操作系统，Linux能运行各种工具软件、应用程序及网络协议，它支持安装在32位和64位CPU硬件上。

通常的讲，Linux这个词本身只表示Linux内核，但是人们已经习惯用Linux来形容整个基于Linux内核的操作系统，并且是一种使用GNU通用公共许可证（GNU General Public License，GPL）工程各种工具和数据库的操作系统。

GNU是“GNU is Not Unix”，UNIX是一种广泛使用的商业操作系统，由于GNU将要实现以UNIX系统的接口标准，因此GNU计划可以分别开发不同的操作系统部件，并且采用了部分当时已经可自由使用的软件。

为了保证GNU软件可以自由地“使用、复制、修改和发布”，所有的GNU软件都在一份禁止其他人添加任何限制的情况下授权所有权利给任何人的协议条款里，我们把这个条款称之为GNU通用公共许可证（GNU General Public License，GPL）。

1991年的10月5日，Linux创始人Linus Torvalds在comp.os.minix[新闻组](http://baike.baidu.com/view/834.htm)上发布消息，正式向外宣布Linux内核的诞生，1994年3月Linux 1.0发布，代码量17万行，当时是完全按照自由免费的协议发布，随后正式采用GPL协议，目前GPL协议版本包括：GPLv1、GPLv2、GPLv3以及未来的GPLv4、GPLv5等。

## Linux操作系统优点

随着IT产业的不断发展，Linux操作系统应用领域越来越广泛，尤其是近年来Linux在服务器领域飞速的发展，主要得益于Linux操作系统具备的如下优点：

-   开源、免费；
-   系统迭代更新；
-   系统性能稳定；
-   安全性高；
-   多任务，多用户；
-   耗资源少；
-   内核小；
-   应用领域广泛；
-   使用及入门容易。

## Linux操作系统发行版

学习Linux操作系统，需要选择不同的发行版本，Linux操作系统是一个大类别，Linux操作系统主流发行版本包括：Red Hat Linux、CentOS、Ubuntu、SUSE Linux、Fedora Linux等，具体发行版本区别如下：

####  Red Hat Linux

Red Hat Linux是最早的Linux发行版本之一，同时也是最著名的Linux版本，Red Hat Linux已经创造了自己的品牌，也是读者经常听到的“红帽操作系统”。Red Hat	1994年创立，目前公司全世界有3000多人，一直致力于开放的源代码体系，向用户提供一套完整的服务，这使得它特别适合在公共网络中使用。这个版本的Linux也使用最新的内核，还拥有大多数人都需要使用的主体软件包。

Red Hat	Linux发行版操作系统的安装过程非常简单，图形安装过程提供简易设置服务器的全部信息，磁盘分区过程可以自动完成，还可以通过图形界面（Graphical	User Interface，GUI）完成安装，即使对于Linux新手来说这些都非常简单。后期如果想批量安装Red Hat Linux系统，可以通过批量的工具来实现快速安装。

#### CentOS

社区企业版操作系统（Community Enterprise Operating System，CentOS）是Linux发行版之一，它是来自于Red Hat Enterprise	Linux依照开放源代码所编译而成。由于出自同样的源代码，因此有些要求高度稳定性的服务器以CentOS替代商业版的Red Hat Enterprise Linux使用。

CentOS 与 Red Hat	Linux不同之处在于CentOS并不包含封闭的源代码软件，可以开源免费使用，得到运维人员、企业、程序员的青睐，CentOS发行版操作系统是目前企业使用最多的系统之一，2016年12月12日，CentOS7基于	Red Hat Enterprise Linux 的 CentOS Linux 7 (1611) 系统正式对外发布。

#### Ubuntu 

Ubuntu是一个以桌面应用为主的Linux操作系统，其名称来自非洲南部祖鲁语或豪萨语的“ubuntu”一词（译为吾帮托或乌班图），意思是“人性”、“我的存在是因为大家的存在”，是非洲传统的一种价值观。

Ubuntu基于Debian发行版和GNOME桌面环境，Ubuntu发行版操作系统的目标在于为一般用户提供一个最新的、同时稳定的以开放自由软件构建而成的操作系统，目前Ubuntu具有庞大的社区力量，用户可以方便地从社区获得帮助。

#### SUSE Linux

SUSE(发音 /ˈsuːsə/)，SUSE Linux 出自德国，SuSE Linux	AG公司发行维护的Linux发行版，是属于此公司的注册商标2003年11月4日，Novell表示将会对SUSE提出收购。收购的工作于2004年1月完成。

Novell也向大家保证SUSE的开发工作仍会继续下去，Novell更把公司内全线电脑的系统换成SUSE LINUX，并同时表示将会把SUSE特有而优秀的系统管理程序 - YaST2以GPL授权释出。

####  Fedora Linux

Fedora是一个知名的Linux发行版，是一款由全球社区爱好者构建的面向日常应用的快速、稳定、强大的操作系统。它允许任何人自由地使用、修改和重发布，无论现在还是将来。它由一个强大的社群开发，这个社群的成员以自己的不懈努力，提供并维护自由、开放源码的软件和开放的标准。

Fedora	约每六个月会发布新版本，美国当地时间2015年11月3日，北京时间2015年11月4日，Fedora	Project 宣布 Fedora 23 正式对外发布，2019年6月发布Fedora 26版本。

## 32位与64位操作系统的区别

学习Linux操作系统之前，需要理解计算机基本的常识，计算机内部对数据的传输和储存都是使用二进制，二进制是计算技术中广泛采用的一种[数制](http://baike.baidu.com/item/%E6%95%B0%E5%88%B6)，而Bit（比特）则表示二进制位，[二进制数](http://baike.baidu.com/item/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%95%B0)是用0和1两个[数码](http://baike.baidu.com/item/%E6%95%B0%E7%A0%81)来表示的数。基数为2，进位规则是“逢二进一”，0或者1分别表示一个Bit二进制位。

Bit位是计算机最小单位，而字节是计算机中数据处理的基本单位，转换单位为：1Byte=8Bit，4Byte=32Bit。

随着计算机技术的发展，尤其是中央处理器（Central Processing Unit，CPU）技术的变革，CPU的位数指的是通用寄存器（General-Purpose Registers，GPRs）的数据宽度，也就是处理器一次可以处理的数据量多少。

目前主流CPU处理器分为32位CPU处理器和64位CPU处理器，32位CPU处理器可以一次性处理4个字节的数据量。而64位处理器一次性处理8个字节的数据量（1Byte=8bit），64位CPU处理器对计算机处理器在RAM里（随机存取储存器）处理信息的效率比32位CPU做了很多优化，效率更高。

X86_32位操作系统和X86_64操作系统也是基于CPU位数的支持，具体区别如下：

-   32位操作系统表示32位CPU对内存寻址的能力；
-   64位操作系统表示64位CPU对内存寻址的能力；
-   32位的操作系统安装在32位CPU处理器和64位CPU处理器上；
-   64位操作系统只能安装64位CPU处理器上；
-   32位操作系统对内存寻址不能超过4GB；
-   64位操作系统对内存寻址可以超过4GB，企业服务器更多安装64位操作系统，支持更多内存资源的利用；
-   64位操作系统是为高性能处理需求设计，数据处理、图片处理、实时计算等领域需求；
-   32位操作系统是为普通用户设计，普通办公、上网冲浪等需求。

## Linux内核命名规则

Linux内核是Linux操作系统的核心，一个完整的Linux发行版包括进程管理、内存管理、文件系统、系统管理、网络操作等部分。

Linux内核官网可以下载Linux内核版本、现行版本，历史版本，可以了解版本与版本之间的特性。

Linux内核版本命名在不同的时期有其不同的命名规范，其中在2.X版本中，X如果为奇数表示开发版、X如果为偶数表示稳定版，从2.6.X以及3.X，内核版本命名就没有严格的约定规范。

从Linux内核1994年发布1.0发布到目前主流2.6、3.X版本，4.X属于开发调试阶段，查看Linux操作系统内核如图1-2所示：

![图1-2操作系统内核](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855191.png)

Linux内核命名格式为 “R.X.Y-Z”，其中R、X、Y、Z命名意义如下：

-   数字R表示内核版本号，版本号只有在代码和内核有重大改变的时候才会改变，到目前为止有4个大版本更新。
-   数字X表示内核主版本号，主版本号根据传统的奇偶系统版本编号来分配，奇数为开发版，偶数为稳定版。
-   数字Y表示内核次版本号，次版本号是无论在内核增加安全补丁、修复Bug、实现新的特性或者驱动时都会改变。
-   数字Z表示内核小版本号，小版本号会随着内核功能的修改、Bug修复而发生变化。

官网内核版本如图1-3所示，Mainline表示主线开发版本，Stable表示稳定版本，稳定版本主要由mainline测试通过而发布。Longterm表示长期支持版，会持续更新及Bug修复，如果长期版本被标记为EOL（End of Life），则表示不再提供更新。

![ 图1-3官网内核版本](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855172.png)

# 第二章 Linux发展及系统安装

互联网飞速发展，用户对网站体验要求也越来越高，目前主流WEB网站后端承载系统均为Linux操作系统，Android手机也是基于Linux内核而研发，企业大数据、云存储、虚拟化等先进技术也均是基于Linux操作系统为载体，满足企业的高速发展。

本章向读者介绍Linux发展前景、Windows与Linux操作系统区别、硬盘分区介绍、CentOS 7 Linux操作系统安装图解及菜鸟学好Linux必备大绝招。

## Linux发展前景及就业形势

权威部门统计，未来几年内我国软件行业的从业机会十分庞大，中国每年对IT软件人才的需求将达到200万人左右。而对于Linux专业人才的就业前景，更是广阔；据悉在未来5-10年内Linux专业人才的需求将达到150万，尤其是有Linux行业经验的，资深的Linux工程师非常缺乏，薪资也非常诱人，平均月薪15000-25000，甚至更高，Linux行业薪资如图2-1所示：

![图2-1 Linux行业薪资](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855216.png)

## Windows操作系统简介

为什么要学习Windows操作系统呢，了解Windows系统结构，可以让我们快速学习Linux操作系统，通过对比学习的方法，我们可以更快的学会Linux。

计算机硬件组成包括：CPU、内存、网卡、硬盘、DVD光驱、电源、主板、显示器、鼠标、键盘等设备，计算机硬件是不能直接被人使用的，需要在其上安装各种操作系统，安装完操作系统，并安装驱动程序，方可进行操作、办公、上网冲浪等。

计算机的硬件组成：

-   CPU，相当于人的大脑，中央处理器；
-   内存，存储设备，临时存储，CPU所需要数据，从内存中读取，内存读写速度很快；
-   硬盘，持久化设备，内存空间小，费用高，大量的数据存在硬盘，硬盘读写速度比内存慢；（SSD、SAS、SATA）；

驱动程序主要指的是设备驱动程序（Device Driver），是一种可以使[计算机](http://baike.baidu.com/item/%E8%AE%A1%E7%AE%97%E6%9C%BA)系统和设备通信的特殊程序，相当于[硬件](http://baike.baidu.com/item/%E7%A1%AC%E4%BB%B6)的接口，[操作系统](http://baike.baidu.com/item/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F)只有通过这个接口，才能控制[硬件](http://baike.baidu.com/item/%E7%A1%AC%E4%BB%B6)设备，进行资源调度。

Windows操作系统主要以窗口形式对用户展示，操作系统须安装在硬盘上，安装系统之前需对硬盘进行分区并格式化，默认Windows操作系统安装在C盘分区，D盘分区用于存放数据文件。

通俗的讲，安装操作系统时，需要对磁盘进行格式化，格式化需要指定格式化的类型，告诉操作系统如何去管理磁盘空间，文件如何存放，如何查找及调用。操作系统不知道怎么存放文件以及文件结构，文件系统概念就诞生了。

文件系统是[操作系统](http://baike.baidu.com/view/880.htm)用于明确[磁盘](http://baike.baidu.com/view/157418.htm)或分区上文件的方法和[数据存储结构](http://baike.baidu.com/view/9900.htm)，文件系统由三部分组成：与文件管理有关软件、被管理文件以及实施文件管理所需数据结构。

Windows操作系统，文件系统类型一般有FAT、FAT16、FAT32、NTFS等，不同的文件系统类型，有不同的特性，例如NTFS文件系统类型支持文件及文件夹安全设置，而FAT32文件系统类型不支持，NTFS支持单文件最多为单个磁盘分区的容量大小2T，而FAT32单个最大文件不能超过4GB。

Windows操作系统从设计层面来讲，主要用来管理[电脑硬件](https://www.baidu.com/s?wd=%E7%94%B5%E8%84%91%E7%A1%AC%E4%BB%B6&tn=44039180_cpr&fenlei=mv6quAkxTZn0IZRqIHckPjm4nH00T1d-mH04uAR1nWRdnyn3nvf0IAYqnWm3PW64rj0d0AP8IA3qPjfsn1bkrjKxmLKz0ZNzUjdCIZwsrBtEXh9GuA7EQhF9pywdQhPEUiqkIyN1IA-EUBtknjfdrjnznjfsPHDsPWb4nHT4)与软件资源的程序，大致包括五个方面的管理功能:进程与处理机管理、作业管理、存储管理、设备管理、[文件管理](https://www.baidu.com/s?wd=%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86&tn=44039180_cpr&fenlei=mv6quAkxTZn0IZRqIHckPjm4nH00T1d-mH04uAR1nWRdnyn3nvf0IAYqnWm3PW64rj0d0AP8IA3qPjfsn1bkrjKxmLKz0ZNzUjdCIZwsrBtEXh9GuA7EQhF9pywdQhPEUiqkIyN1IA-EUBtknjfdrjnznjfsPHDsPWb4nHT4)。Windwos操作系统从个人使用角度来讲，主要用于个人电脑办公、软件安装、上网冲浪、游戏、数据分析、数据存储等功能。

## 硬盘分区简介

学习Windows、Linux操作系统，必然要了解硬盘设备，硬盘是电脑主要的存储[媒介](http://baike.baidu.com/item/%E5%AA%92%E4%BB%8B)之一，硬盘要能够安装系统或者存放数据，必须进行分区和格式化，Windows系统常见分区有三种：主磁盘分区、扩展磁盘分区、逻辑磁盘分区。

一块硬盘设备，主分区至少有1个，最多4个，扩展分区可以为0，最多1个，且主分区+扩展分区总数不能超过4个，逻辑分区可以有若干个。在Windows下激活的主分区是硬盘的启动分区，他是独立的，也是硬盘的第一个分区，通常就是我们所说的C盘系统分区。

扩展分区是不能直接用的，他是以逻辑分区的方式来使用的，扩展分区可分成若干逻辑分区。他们的关系是包含的关系，所有的逻辑分区都是扩展分区的一部分。

在Windows系统安装时，硬盘驱动器是通过磁盘0,磁盘1来显示,其中磁盘0表示第一块硬盘,磁盘1表示第二块硬盘,然后在第一块硬盘磁盘0上进行分区，最多不能超过4个主分区,分区为C、D、E、F。

硬盘接口是[硬盘](http://baike.baidu.com/item/%E7%A1%AC%E7%9B%98)与[主机系统](http://baike.baidu.com/item/%E4%B8%BB%E6%9C%BA%E7%B3%BB%E7%BB%9F)间的连接部件，作用是在硬盘[缓存](http://baike.baidu.com/item/%E7%BC%93%E5%AD%98)和主机内存之间传输数据。不同的硬盘接口决定着硬盘与计算机之间的连接速度，在整个系统中，硬盘接口的优劣直接影响着程序运行快慢和系统性能好坏，常见的硬盘接口类型为：[IDE](http://baike.baidu.com/item/IDE)（Integrated Drive Electronics）、[SATA](http://baike.baidu.com/item/SATA)（Serial Advanced Technology Attachment）、[SCSI](http://baike.baidu.com/item/SCSI)（Small Computer System Interface）、SAS（Serial Attached SCSI）和[光纤通道](http://baike.baidu.com/item/%E5%85%89%E7%BA%A4%E9%80%9A%E9%81%93)等。

[IDE接口](http://baike.baidu.com/item/IDE%E6%8E%A5%E5%8F%A3)硬盘多用于家用，部分也应用于传统[服务器](http://baike.baidu.com/item/%E6%9C%8D%E5%8A%A1%E5%99%A8)，[SCSI、SAS接口](http://baike.baidu.com/item/SCSI%E6%8E%A5%E5%8F%A3)的硬盘则主要应用于服务器市场，而光纤通道用于高端服务器上，SATA主要用于个人家庭办公电脑及低端服务器。

在Linux操作系统中，读者可以看到硬盘驱动器的第一块IDE硬盘接口的硬盘设备为hda，或者SATA硬盘接口的硬盘设备为sda，主分区编号为hda1-4或者sda1-4，逻辑分区从5开始。如果有第二块硬盘，主分区编号为hdb1-4或者sdb1-4。

不管是Windows还是Linux操作系统，硬盘的总容量=主分区的容量+扩展分区的容量，而扩展分区的容量=各个逻辑分区的容量之和。主分区也可成为“引导分区”，会被操作系统和主板认定为这个硬盘的第一个分区，所以C盘永远都是排在所有磁盘分区的第一的位置上。

MBR（Master Boot Record）和GPT（GUID Partition Table）是在磁盘上存储分区信息的两种不同方式。这些分区信息包含了分区从哪里开始的信息，这样操作系统才知道哪个扇区是属于哪个分区的，以及哪个分区是可以启动操作系统的。

在磁盘上创建分区时，必须选择MBR或者GPT，默认是MBR，也可以通过其他方式修改为GPT方式。MBR分区的硬盘最多支持4个主分区，如果想支持更多主分区，可以考虑使用GPT格式分区。

## Linux安装环境准备

要学好Linux这门技术，首先需安装Linux操作系统，Linux操作系统安装是每个初学者的门槛。而安装Linux操作系统，最大的困惑莫过于给操作系统进行磁盘分区。

虽然目前各种发行版本的 Linux 已经提供了友好的图形交互界面，但很多初学者还是感觉无从下手,这其中原因主要是不清楚Linux 的分区规定。

Linux 系统安装中规定，同样每块硬盘设备最多只能分 4个主分区（其中包含扩展分区）构成，任何一个扩展分区都要占用一个主分区号码，也就是在一个硬盘中，主分区和扩展分区一共最多是 4 个。

为了让读者能将本书所有Linux技术应用于企业，本书案例以企业里主流Linux操作系统CentOS为蓝本，目前主流CentOS发行版本为CentOS7。

读者在安装CentOS操作系统时，如果没有多余的计算机裸机设备，可以基于Windows主机上安装Vmware workstation工具，该工具的用途可以在Windows主机上创建多个计算机裸机设备资源，包括：CPU、内存、硬盘、网卡、DVD光驱、USB接口、声卡，创建的多个计算机裸机设备共享Windows主机的所有资源。

读者在安装CentOS操作系统时，如果有多余的计算机裸机设备或者企业服务器，可以将CentOS系统直接安装在多余的设备上，安装之前需要下载CentOS7操作系统镜像文件(International Organization for Standardization,ISO 9660标准)，通过刻录工具，将ISO镜像文件刻录至DVD光盘或者U盘里，通过DVD或者U盘启动然后安装系统。

如下为在Windwos主机上安装VMware workstation虚拟机软件，虚拟机软件的用途是可以在真实机上模拟一个新的计算机完整的资源设备，进而可以在计算机裸设备上安装CentOS7操作系统步骤：

1.  安装环境准备

-   [VMware workstation 10.0](http://www.xp510.com/xiazai/ossoft/desktools/22610.html)
-   CentOS7 x86_64

![图2-2 VMware Workstation图标](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855190.png)

2.  双击桌面VMware Workstation图标打开虚拟机软件，单击“创建新的虚拟机”，如图2-3所示：

![图2-3 VMware Workstation创建虚拟机](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855198.png)

3.  新建虚拟机向导，选择自定义（高级）（C）选项，如图2-4所示：

![图2-4 创建虚拟机向导](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855174.png)

4.  安装客户机操作系统，选择“稍后安装操作系统（S）”，如图2-5所示:

![图2-5 安装客户机操作系统](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855176.png)

5.  选择客户机操作系统，由于我们即将安装CentOS7操作系统，所以需要勾选“Linux（L）”，同时版本（V）选择“CentOS64位”，如图2-6所示：

![图2-6 操作系统版本](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855179.png)

6.  虚拟机内存设置，默认为1024MB，如图2-7所示：

![图2-7 虚拟机内存分配](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855207.png)

7.  选择虚拟机网络类型，此处选择-网络连接为-“使用桥接模式”，如图2-8所示：

![图2-8 虚拟机网络类型](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855194.png)

8.  指定磁盘容量，设置虚拟机硬盘大小为40GB，将虚拟磁盘拆分成多个文件，如下图2-9所示：

![图2-9设置虚拟机磁盘容量](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855200.png)

9.  虚拟机硬件资源创建完成，设备详情里面包括计算机常用设备，例如内存、处理器、硬盘、CD/DVD、网络适配器等，如图2-10所示：

![图2-10虚拟机裸机设备](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855205.png)

10.  将CentOS7 ISO系统镜像文件添加至虚拟机CD/DVD中，双击虚拟机“CD/DVD（IDE）自动检测”选项，选择CentOS-7-x86_64-DVD-1511.iso镜像文件，如图2-11所示：

![图2-11选择系统安装镜像](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855473.png)

## Linux系统安装图解

如果直接在硬件设备上安装CentOS系统，不需要安装虚拟机等步骤，直接将U盘或者光盘插入DVD光驱即可，打开电源设备。

1.  如图2-12所示，光标选择Install CentOS 7，直接按Enter键进行系统安装。

![图2-12选择安装菜单](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855219.png)

2.  继续按Enter键启动安装进程，进入光盘检测，按Esc键跳过检测，如图2-13所示：

![图2-13跳过ISO镜像检测](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855203.png)

3.  CentOS7欢迎界面，选择安装过程中界面显示的语言，初学者可以选择“简体中文”或者默认English，如图2-14所示：

![图2-14选择安装过程语言](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855209.png)

4.  CentOS7 Installation Summary安装总览界面，如图2-15所示：

![图2-15 Installation Summary界面](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855469.png)

5.  选择“I will configure partioning.”，单击Done，如图2-16所示：

![图2-16 磁盘分区方式选择](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855212.png)

6.  下拉框选择“Standard Partition”，选择+号，创建分区，如图2-17所示：

![图2-17 磁盘分区类型选择](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855275.png)

7.  Linux操作系统分区与Windows操作系统分区C盘、D盘有很大区别，Liunx操作系统是采用树形的文件系统管理方式，所有的文件存储以/（根）开始，如图2-18所示。

![图2-18 Linux文件系统目录结构](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855740.png)

Linux是以文件的方式存储，例如/dev/sda代表整块硬盘，/dev/sda1表示硬盘第一分区，/dev/sda2表示硬盘第二分区，为了能将目录和硬盘分区关联，所以Linux采用挂载点的方式来关联磁盘分区，/boot目录、/根目录、/data目录跟磁盘管理后，称之为分区，每个分区功能如下：

-   /boot分区用于存放Linux内核及系统启动过程所需文件；
-   Swap分区又称为交换分区，类似Windows系统的虚拟内存，物理内存不够用时，以供程序使用Swap内存；物理内存32G，虚拟内存512MB！阿里云交换分区设置0；
-   /分区用于系统安装核心分区及所有文件存放的根系统；
-   /data分区为自定义分区，企业服务器中用于作应用数据存放。

如图2-19所示，创建/boot分区并挂载，分区大小为200MB：

![图2-19 创建/boot分区](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855227.png)

单击“Add mount point”即可，磁盘分区默认文件系统类型为XFS，根据如上方法，依次创建swap分区，大小为2048MB，创建/分区，大小为剩余所有空间，最终如图2-20所示：

![图2-20 磁盘完整分区](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855222.png)

8.  选择SOFTWARE SELECTION，设置为Minimal Install最小化安装，如果后期需要开发包、开发库等软件，可以在系统安装完后，根据需求安装即可，如图2-21所示:

![图2-21 选择安装的软件](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855457.png)

9.  操作系统时区选择，选择Asia-Shanghai，关闭Network Time，如图2-22所示：

![图2-22 操作系统时区选择](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855459.png)

10.  以上配置完毕后，单击“Begin Installation”，单击“Root PASSWORD”设置Root用户密码，如图2-23所示，如果需要新增普通用户，可以单击“USER CREATEION”进行创建即可。

![图2-23 设置ROOT用户密码](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855463.png)

11.  安装进程完毕，单击“Reboot”重启系统，如图2-24所示：

![图2-24 系统安装完毕](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855466.png)

12.  重启CentOS 7 Linux操作系统，进入Login登录界面，“localhost login:”处输入root，按Enter键，然后“Password：”处输入系统安装时设定的密码，输入密码时不会提示，密码输入完按Enter键，即可登录CentOS 7 Linux操作系统，默认登录的终端称为Shell终端，所有的后续操作指令均在Shell终端上执行，默认显示字符提示[root\@localhost\~]\#，其中\#代表当前是root用户登录，如果是\$表示当前为普通用户。如图2-25所示：

![图2-25 Login登录系统界面](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855461.png)

## 菜鸟学好Linux大绝招

系统安装是初学者的门槛，系统安装完毕后，很多初学者不知道该如何学习，不知道如何快速进阶，下面作者总结了菜鸟学好Linux技能的大绝招：

-   初学者完成Linux系统分区及安装之后，需熟练掌握Linux系统管理必备命令，命令包括：cd、ls、pwd、clear、chmod、chown、chattr、useradd、userdel、groupadd、vi、vim、cat、more、less、mv、cp、rm、rmdir、touch、ifconfig、ip addr、ping、route、echo、wc、expr、bc、ln、head、tail、who、hostname、top、df、du、netstat、ss、kill、alias、man、tar、zip、unzip、jar、fdisk、free、uptime、lsof、lsmod、lsattr、dd、date、crontab、ps、find、awk、sed、grep、sort、uniq等，每个命令至少练习30遍，逐步掌握每个命令的用法及应用场景；

-   初学者进阶之路，需熟练构建Linux下常见服务（DHCP、SAMBA、DNS、Apache、MySQL、Nginx、Zabbix、Squid、Varnish、LVS、Keepalived、ELK、MQ、Zookeeper、Docker、Openstack、Hbase、Mongodb、Redis等，遇到问题先思考，没有头绪可以借助百度、Google搜索引擎，问题解决后，将解决问题的步骤总结并形成文档；

-   理解操作系统的每个命令，每个服务的用途，为什么要配置这个服务，为什么需要调整该参数，只有带着目标去学习才能更快的成长，才能让你去发掘更多新知识；

-   熟练搭建Linux系统上各种服务之后，需要理解每个服务的完整配置和优化，可以拓展思维。例如LAMP所有服务放在一台机器上，能否分开放在多台服务器以平衡压力呢，该如何去构建和部署呢？一台物理机构建Docker虚拟化，如果是100台、1000台如何去实施呢，会遇到哪些问题呢；

-   Shell是Linux最经典的命令解释器，Shell脚本可以实现自动化运维，平时多练习Shell脚本编程，每个Shell脚本多练习几遍，从中吸取关键的参数、语法，不断的练习，不断的提高；

-   建立个人学习博客，把平时工作、学习中的知识都记录到博客，一方面可以供别人参考，另一方面可以提高自己文档编写及总结的能力；

-   学习Linux技术是一个长期的过程，一定要坚持，遇到各种错误、问题可以借助百度、Google搜索引擎，如果解决不了，可以请教同学、朋友及你的老师；

-   通过以上步骤的学习方法，不断进步，如果想达到高级、资深大牛级别，还需要进一步深入学习WEB集群架构、网站负载均衡、网站架构优化、自动化运维、运维开发、虚拟化等知识；

-   多练习才是硬道理，实践出真知。

## 本章小结

通过对本章内容的学习，读者对Linux系统有了一个初步的理解，了解Linux行业的发展前景，学会了如何在企业中或者虚拟机中安装Linux系统。

对32位、64位CPU处理器以及对Linux内核版本命名也有进一步的认识，同时掌握了学习Linux的大绝招。

## 同步作业

1.  企业中服务器品牌DELL R730，其硬盘总量为300G，现需安装CentOS 7 Linux操作系统，请问如何进行分区？
2.  GNU与GPL的区别是什么？
3.  企业一台Linux服务器，查看该Linux内核显示：3.10.0-327.36.3.el7.x86_64，请分别说出点号分割的每个数字及字母的含义？
4.  CentOS Linux至今发布了多少个系统版本？
5.  如果Linux系统采用光盘安装，如何将ISO镜像文件刻录成光盘，请写出具体实现流程？

# 第三章 CentOS系统管理

Linux系统安装完毕，需要对Linux系统进行管理和维护，让Linux服务器能真正应用于企业中。

本章向读者介绍Linux系统引导原理、启动流程、系统目录、权限、命令及CentOS7和CentOS6在系统管理、命令方面有什么区别，让我们一起来遨游在Linux的海洋里。

## 操作系统启动概念

不管是Windows还是Linux操作系统，底层设备一般均为物理硬件，操作系统启动之前会对硬件进行检测，然后硬盘引导启动操作系统，如下为操作系统启动相关的各个概念：

### BIOS

基本输入输出系统（Basic Input Output System，BIOS）是一组固化到计算机主板上的只读内存[镜像](http://baike.baidu.com/item/%E9%95%9C%E5%83%8F/1574)（Read Only Memory image，ROM）芯片上的程序，它保存着计算机最重要的基本输入输出的程序、系统设置信息、开机后自检程序和系统自启动程序。主要功能是为计算机提供最底层的、最直接的硬件设置和控制。

### MBR 

全新硬盘在使用之前必须进行分区格式化，硬盘分区初始化的格式主要由两种，分别是：MBR格式和GPT格式。

如果使用MBR格式，操作系统将创建主引导记录扇区（Main Boot Record，MBR），MBR位于整块硬盘的0[磁道](http://baike.baidu.com/view/201106.htm)0柱面1[扇区](http://baike.baidu.com/view/201129.htm)，主要功能是操作系统对磁盘进行读写时，判断分区的合法性以及分区引导信息的定位。

[主引导扇区](http://baike.baidu.com/view/418400.htm)总共为512字节，MBR只占用了其中的446个字节，另外的64个字节为[硬盘分区表](http://baike.baidu.com/view/1385.htm) (Disk Partition Table，DPT)，最后两个字节“55，AA”是分区的结束标志。

在MBR硬盘中，硬盘分区信息直接存储于[主引导记录](http://baike.baidu.com/item/%E4%B8%BB%E5%BC%95%E5%AF%BC%E8%AE%B0%E5%BD%95)（MBR）中，同时主引导记录还存储着系统的[引导程序](http://baike.baidu.com/item/%E5%BC%95%E5%AF%BC%E7%A8%8B%E5%BA%8F)，如图3-1所示：

![图3-1 MBR分区表内容](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855607.png)

MBR是计算机启动最先执行的硬盘上的程序，只有512字节大小，所以不能载入[操作系统](https://www.baidu.com/s?wd=%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F&tn=44039180_cpr&fenlei=mv6quAkxTZn0IZRqIHckPjm4nH00T1YznWf3m1nzP1fYm16vnhwh0ZwV5Hcvrjm3rH6sPfKWUMw85HfYnjn4nH6sgvPsT6KdThsqpZwYTjCEQLGCpyw9Uz4Bmy-bIi4WUvYETgN-TLwGUv3En1RYP1cvn10L)的核心，只能先载入一个可以载入计算机核心的程序，我们称之为引导程序。

因为MBR分区标准决定了MBR只支持在2TB以下的硬盘，对于后面的多余空间只能浪费。为了支持能使用大于2T硬盘空间，微软和英特尔公司在可扩展固件接口(Extensible Firmware Interface，EFI)方案中开发了全局唯一的标识符（Globally unique identifier，GUID），进而全面支持大于2T硬盘空间在企业中使用。

### GPT 

全局唯一的标识符（Globally unique identifier，GUID），正逐渐取代MBR成为新标准。它和统一的可扩展固件接口 (Unified Extensible Firmware Interface,UEFI)相辅相成。

UEFI用于取代老旧的BIOS，而GPT则取代老旧的MBR。之所以称为“GUID分区表”，是因为驱动器上的每个分区都有一个全局唯一的标识符。

在GPT硬盘中，分区表的位置信息储存在GPT头中。出于兼容性考虑，第一个扇区同样有一个与MBR类似的标记，叫做受保护的主引导记录（Protected Main Boot Record，PMBR）。

PMBR的作用是当使用不支持GPT的分区工具时，整个硬盘将显示为一个受保护的分区，以防止分区表及硬盘数据遭到破坏，而其中存储的内容和MBR一样，之后才是GPT头。

GPT优点支持2T以上磁盘，如果使用Fdisk分区，最大只能建立2TB大小的分区，创建大于2TB的分区，需使用parted，同时必须使用64位操作系统，Mac、Linux系统都能支持GPT分区格式，Windows 7/8 64bit、Windows Server 2008 64bit支持GPT。图3-2所示，为GPT硬盘分区表内容：

![图3-2 GPT分区表内容](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855568.png)

### GRUB

GNU项目的多操作系统启动程序（GRand Unified Bootloader，GRUB），可以支持多操作系统的引导，它允许用户可以在[计算机](http://baike.baidu.com/view/3314.htm)内同时拥有多个[操作系统](http://baike.baidu.com/view/880.htm)，并在计算机启动时选择希望运行的操作系统。

GRUB可用于选择[操作系统](http://baike.baidu.com/view/880.htm)分区上的不同[内核](http://baike.baidu.com/view/1366.htm)，也可用于向这些[内核](http://baike.baidu.com/view/1366.htm)传递启动参数。它是一个多重[操作系统](http://baike.baidu.com/view/880.htm)启动管理器。用来引导不同系统，如Windows，Linux。Linux常见的引导程序包括：LILO、GRUB、GRUB2，CentOS 7 Linux默认使用GRUB2引导程序，引导系统启动。如图3-3所示为GRUB加载引导流程：

![图3-3 GRUB引导流程](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855476.png)

GRUB2是基于GRUB开发成更加安全强大的多系统引导程序，最新[Linux](http://lib.csdn.net/base/linux)发行版都是使用GRUB2作为引导程序。同时GRUB2采用了模块化设计，使得GRUB2核心更加精炼，使用更加灵活，同时也就不需要像GRUB分为stage1,stage1.5,stage2三个阶段。

## Linux操作系统启动流程

初学者对Linux操作系统启动流程的理解，能有助于后期在企业中更好的维护Linux服务器，能快速定位系统问题，进而解决问题。Linux操作系统启动流程如图3-4所示：

![图3-4 系统启动流程](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855471.png)

1.  加载BIOS
计算机电源加电质检，首先加载基本输入输出系统（Basic Input Output System，BIOS），BIOS中包含硬件CPU、内存、硬盘等相关信息，包含设备启动顺序信息、硬盘信息、内存信息、时钟信息、即插即用（Plug-and-Play，PNP）特性等。加载完BIOS信息，计算机将根据顺序进行启动。

2.  读取MBR
读取完BIOS信息，计算机将会查找BIOS所指定的硬盘MBR引导扇区，将其内容复制到0x7c00地址所在的物理内存中。被复制到物理内存的内容是Boot Loader，然后进行引导。

3.  GRUB引导
GRUB启动引导器是计算机启动过程中运行的第一个软件程序，当计算机读取内存中的GRUB配置信息后，会根据其配置信息来启动硬盘中不同的操作系统。

4.  加载Kernel
计算机读取内存映像，并进行解压缩操作，屏幕一般会输出“Uncompressing Linux”的提示，当解压缩内核完成后，屏幕输出“OK, booting the kernel”。系统将解压后的内核放置在内存之中，并调用start_kernel()函数来启动一系列的初始化函数并初始化各种设备，完成Linux核心环境的建立。

5.  设定Inittab运行等级
内核加载完毕，会启动Linux操作系统第一个守护进程init，然后通过该进程读取/etc/inittab文件，/etc/inittab文件的作用是设定Linux的运行等级，Linux常见运行级别如下：

-   0：关机模式；
-   1：单用户模式；
-   2：无网络支持的多用户模式；
-   3：字符界面多用户模式；
-   4：保留，未使用模式；
-   5：图像界面多用户模式；
-   6：重新引导系统，重启模式。

6.  加载rc.sysinit
读取完运行级别，Linux系统执行的第一个用户层文件/etc/rc.d/rc.sysinit，该文件功能包括：设定PATH运行变量、设定网络配置、启动swap分区、设定/proc、系统函数、配置Selinux等。

7.  加载内核模块
读取/etc/modules.conf文件及/etc/modules.d目录下的文件来加载系统内核模块。该模块文件，可以后期添加或者修改及删除。

8.  启动运行级别程序
根据之前读取的运行级别，操作系统会运行rc0.d到rc6.d中的相应的脚本程序，来完成相应的初始化工作和启动相应的服务。其中以S开头表示系统即将启动的程序，如果以K开头，则代表停止该服务。S和K后紧跟的数字为启动顺序编号。如图3-5所示：

![图3-5 运行级别服务](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855479.png)

9.  读取rc.local文件
操作系统启动完相应服务之后，会读取执行/etc/rc.d/rc.local文件，可以将需要开机启动的任务加入到该文件末尾，系统会逐行去执行并启动相应命令，如图3-6所示：

![图3-6 开机运行加载文件](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855750.png)

10.  执行/bin/login程序
执行/bin/login程序，启动到系统登录界面，操作系统等待用户输入用户名和密码，即可登录到Shell终端，如图3-7所示，输入用户名、密码即可登录Linux操作系统，至此Linux操作系统完整流程启动完毕。

![图3-7 系统登录界面](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855482.png)

## TCP/IP协议概述

要学好Linux，对网络协议也要有充分的了解和掌握，例如传输控制协议/[因特网](http://baike.baidu.com/view/1706.htm)互联协议（Transmission Control Protocol/Internet Protocol，TCP/IP），TCP/IP名为网络[通讯协议](http://baike.baidu.com/view/278358.htm)，是Internet最基本的协议、Internet国际[互联网](http://baike.baidu.com/view/6825.htm)络的基础，由[网络层](http://baike.baidu.com/view/239600.htm)的IP协议和[传输层](http://baike.baidu.com/view/239605.htm)的TCP协议组成。

TCP/IP
定义了电子设备如何连入[因特网](http://baike.baidu.com/view/1706.htm)，以及数据如何在它们之间传输的标准。协议采用了4层的层级结构，每一层都呼叫它的下一层所提供的协议来完成自己的需求。

TCP负责发现[传输](http://baike.baidu.com/view/389471.htm)的问题，一有问题就发出信号，要求重新传输，直到所有[数据安全](http://baike.baidu.com/view/2308446.htm)正确地传输到目的地，而IP是给[因特网](http://baike.baidu.com/view/1706.htm)的每台联网设备规定一个地址。

基于TCP/IP的参考模型将协议分成四个层次，它们分别是网络接口层、网际互连层（IP层）、[传输层](http://baike.baidu.com/view/239605.htm)（TCP层）和应用层。如图3-9为TCP/IP跟OSI参考模型层次的对比：

![图3-9 ISO7层模型与TCP/IP四层对比](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855492.png)

OSI模型与TCP/IP模型协议功能实现对照表，如图3-10所示：

![图3-10 ISO7层模型与TCP/IP层次功能对比](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855495.png)

## IP地址及网络常识

互联网协议地址（Internet Protocol Address，IP），IP地址是[IP协议](http://baike.baidu.com/view/2802.htm)提供的一种统一的地址格式，它为互联网上的每一个网络和每一台主机分配一个逻辑地址，以此来屏蔽物理地址的差异。IP地址被用来给[Internet](http://baike.baidu.com/view/11165.htm)上的每个通信设备的一个编号，每台联网的PC上都需要有IP地址，这样才能正常通信。

IP地址是一个32位的二进制数，通常被分割为4个“8位[二进制](http://baike.baidu.com/view/18536.htm)数”（即4个字节）。IP地址通常用“[点分十进制](http://baike.baidu.com/view/828066.htm)”表示成（a.b.c.d）的形式，其中，a,b,c,d都是0\~255之间的十进制整数。

常见的IP地址，分为[IPv4](http://baike.baidu.com/view/21992.htm)与[IPv6](http://baike.baidu.com/view/5228.htm)两大类。IP地址编址方案将IP地址空间划分为A、B、C、D、E五类，其中A、B、C是基本类，D、E类作为多播和保留使用。

IPV4有4段数字，每一段最大不超过255。由于互联网的蓬勃发展，IP位址的需求量愈来愈大，使得IP位址的发放愈趋严格，各项资料显示全球IPv4位址在2011年已经全部分发完毕。

地址空间的不足必将妨碍互联网的进一步发展。为了扩大[地址空间](http://baike.baidu.com/view/1507129.htm)，拟通过IPv6重新定义地址空间。IPv6采用128位地址长度。在IPv6的设计过程中除了一劳永逸地解决了地址短缺问题以外，IPV6的诞生可以给全球每一粒沙子配置一个IP地址，还考虑了在IPv4中解决不好的其它问题，如图3-11所示：

![图3-11 IPV4与IPV6地址](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855497.png)

### **IP地址分类**

IPV4地址编址方案有A、B、C、D、E五类，其中A、B、C是基本类，D、E类作为多播和保留使用，如下为分类详解：

1.  A类IP地址
一个A类IP地址是指，在IP地址的四段号码中，第一段号码为网络号码，剩下的三段号码为本地计算机的号码。如果用二进制表示IP地址的话，A类IP地址就由1字节的网络地址和3字节主机地址组成，网络地址的最高位必须是“0”。A类IP地址中网络的标识长度为8位，主机标识的长度为24位，A类网络地址数量较少，有126个网络，每个网络可以容纳主机数达1600万台。
A类IP地址 地址范围1.0.0.0到127.255.255.255 （二进制表示为：00000001 00000000 00000000 00000000 - 01111110 11111111 11111111 11111111），最后一个为广播地址，A类IP地址的子网掩码为255.0.0.0，每个网络支持的最大主机数为256的3次方-2=16777214台。

2.  B类IP地址
一个B类IP地址是指在IP地址的四段号码中，前两段号码为网络号码。如果用二进制表示IP地址的话，B类IP地址就由2字节的网络地址和2字节主机地址组成，网络地址的最高位必须是“10”。
B类IP地址中网络的标识长度为16位，主机标识的长度为16位，B类网络地址适用于中等规模的网络，有16384个网络，每个网络所能容纳的计算机数为6万多台。
B类IP地址地址范围128.0.0.0-191.255.255.255（二进制表示为：10000000 00000000 00000000 00000000----10111111 11111111 11111111 11111111）。
最后一个是广播地址，B类IP地址的子网掩码为255.255.0.0，每个网络支持的最大主机数为256的2次方-2=65534台。

3.  C类IP地址
一个C类IP地址是指在IP地址的四段号码中，前三段号码为网络号码，剩下的一段号码为本地计算机的号码。如果用二进制表示IP地址的话，C类IP地址就由3字节的网络地址和1字节主机地址组成，网络地址的最高位必须是“110”。C类IP地址中网络的标识长度为24位，主机标识的长度为8位，C类网络地址数量较多，有209万余个网络。适用于小规模的局域网络，每个网络最多只能包含254台计算机。
C类IP地址范围192.0.0.0-223.255.255.255[3] （二进制表示为: 11000000 00000000 00000000 00000000 - 11011111 11111111 11111111 11111111）。C类IP地址的子网掩码为255.255.255.0，每个网络支持的最大主机数为256-2=254台。

4.  D类IP地址
D类IP地址又称之为多播地址(Multicast Address)，即组播地址。在以太网中，多播地址命名了一组应该在这个网络中应用接收到一个分组的站点。多播地址的最高位必须是“1110”，范围从224.0.0.0到239.255.255.255。

5.  特殊的地址
每一个字节都为0的地址（“0.0.0.0”）表示当前主机，IP地址中的每一个字节都为1的IP地址（“255．255．255．255”）是当前子网的广播地址，IP地址中凡是以“11110”开头的E类IP地址都保留用于将来和实验使用。
IP地址中不能以十进制“127”作为开头，而以数字127．0．0．1到127．255．255．255段的IP地址称为回环地址，用于回路测试，如：127.0.0.1可以代表本机IP地址，网络ID的第一个8位组也不能全置为“0”，全“0”表示本地网络。

### 子网掩码

子网掩码(Subnet Mask)又名[网络掩码](http://baike.baidu.com/view/1169777.htm)、[地址掩码](http://baike.baidu.com/view/4040643.htm)，它是一种用来指明一个[IP地址](http://baike.baidu.com/view/3930.htm)的哪些位标识的是[主机](http://baike.baidu.com/view/23880.htm)所在的子网，以及哪些位标识的是主机的位掩码。

通常的讲，子网掩码不能单独存在，它必须结合IP地址一起使用。子网掩码只有一个作用，就是将某个IP地址划分成[网络地址](http://baike.baidu.com/view/547479.htm)和[主机地址](http://baike.baidu.com/view/547482.htm)两部分。

子网掩码是一个32位地址，用于屏蔽IP地址的一部分以区别网络标识和主机标识，并说明该IP地址是在局域网上，还是在远程网上。

对于A类地址，默认的子网掩码是255.0.0.0，而对于B类地址来说默认的子网掩码是255.255.0.0；对于C类地址来说默认的子网掩码是255.255.255.0。

[互联网](http://baike.baidu.com/view/6825.htm)是由各种小型[网络构成](http://baike.baidu.com/view/2039649.htm)的，每个网络上都有许多[主机](http://baike.baidu.com/view/23880.htm)，这样便构成了一个有层次的结构。IP地址在设计时就考虑到地址分配的层次特点，将每个IP地址都分割成[网络号](http://baike.baidu.com/view/2271538.htm)和[主机](http://baike.baidu.com/view/23880.htm)号两部分，以便于IP地址的[寻址](http://baike.baidu.com/view/1303626.htm)操作。

子网掩码的设定必须遵循一定的规则。与[二进制](http://baike.baidu.com/item/%E4%BA%8C%E8%BF%9B%E5%88%B6)IP地址相同，子网掩码由1和0组成，且1和0分别连续。子网掩码的长度也是32位，左边是网络位，用[二进制](http://baike.baidu.com/item/%E4%BA%8C%E8%BF%9B%E5%88%B6)数字“1”表示，1的数目等于网络位的长度；右边是主机位，用二进制数字“0”表示，0的数目等于主机位的长度。

### 网关地址

[网关](http://baike.baidu.com/view/807.htm)（Gateway）是一个网络连接到另一个网络的“关口”，网关实质上是一个网络通向其他网络的IP[地址](http://baike.baidu.com/view/494802.htm)。主要用于不同网络传输数据。

例如我们电脑设备上网，如果是接入到同一个交换机，在交换机内部传输数据是不需要经过网关的，但是如果两台设备不在一个交换机网络，则需要在本机配置网关，内网服务器的数据通过网关，网关把数据转发到其他的网络的网关，直至找到对方的主机网络，然后返回数据。

### MAC地址

媒体访问控制（Media Access Control或者Medium Access Control，MAC），也即是物理地址、硬件地址，用来定义[网络设备](http://baike.baidu.com/view/1158081.htm)的位置。

在[OSI模型](http://baike.baidu.com/view/571842.htm)中，第三层[网络层](http://baike.baidu.com/view/239600.htm)负责 [IP地址](http://baike.baidu.com/view/3930.htm)，第二层数据链路层则负责 MAC地址。因此一个主机会有一个MAC地址，而每个[网络位置](http://baike.baidu.com/view/1643855.htm)会有一个专属于它的IP地址。

IP地址工作在OSI参考模型的第三层网络层。两者之间分工明确，默契合作，完成通信过程。IP地址专注于网络层，将数据包从一个网络转发到另外一个网络；而MAC地址则专注于数据链路层，将一个数据帧从一个节点传送到相同链路的另一个节点。

IP地址和MAC地址一般是成对出现。如果一台计算机要和网络中另一外计算机通信，那么这两台设备必须配置IP地址和MAC地址，而MAC地址是网卡出厂时设定的，这样配置的IP地址就和MAC地址形成了一种对应关系。

在数据通信时，IP地址负责表示计算机的网络层地址，网络层设备（如路由器）根据IP地址来进行操作；MAC地址负责表示计算机的数据链路层地址，数据链路层设备，根据MAC地址来进行操作。IP和MAC地址这种映射关系是通过[地址解析协议](http://baike.baidu.com/view/149421.htm)（Address Resolution Protocol，ARP）来实现的。

## Linux系统配置IP

Linux操作系统安装完毕，那接下来如何让Linux操作系统能上外网呢？如下为Linux服务器配置IP的方法。

Linux服务器网卡默认配置文件在/etc/sysconfig/network-scripts/下，命名的名称一般为:`ifcfg-eth0 ifcfg-eth1` ，eth0表示第一块网卡，eth1表示第二块网卡，依次类推，例如DELL R720标配有4块千兆网卡，在系统显示的名称依次为：eth0、eth1、eth2、eth3。

修改服务器网卡IP地址命令为`vi /etc/sysconfig/network-scripts/ifcfg-eth0`（注CentOS7网卡名ifcfg-eno16777736）。vi命令打开网卡配置文件，默认为DHCP方式，配置如下：
```
DEVICE=eth0 
BOOTPROTO=dhcp 
HWADDR=00:0c:29:52:c7:4e 
ONBOOT=yes 
TYPE=Ethernet
```

vi命令打开网卡配置文件，修改BOOTPROTO为DHCP方式，同时添加IPADDR、NETMASK、GATEWAY信息如下：
```
DEVICE=eth0 
BOOTPROTO=static 
HWADDR=00:0c:29:52:c7:4e 
ONBOOT=yes 
TYPE=Ethernet 
IPADDR=192.168.1.103 
NETMASK=255.255.255.0 
GATEWAY=192.168.1.1
```

服务器网卡配置文件，详细参数如下：
```
DEVICE=eth0 \#物理设备名
ONBOOT=yes \# [yes\|no]（重启网卡是否激活网卡设备）
BOOTPROTO=static \#[none\|static\|bootp\|dhcp]（不使用协议\|静态分配\|BOOTP协议\|DHCP协议） TYPE=Ethernet \#网卡类型 
IPADDR=192.168.1.103 \#IP地址 
NETMASK=255.255.255.0 \#子网掩码
GATEWAY=192.168.1.1 \#网关地址 
```

服务器网卡配置完毕后，重启网卡服务：`/etc/init.d/network restart` 即可。

然后查看ip地址，命令为：`ifconfig`或者`ip addr show`查看当前服务器所有网卡的IP地址。

CentOS 7 Linux中，如果没有ifconfig命令，可以用`ip addr list/show`查看，也可以安装ifconfig命令，需安装软件包net-tools，命令如图3-12所示：
`yum install net-tools -y`

![图3-12 YUM安装net-tools工具](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855550.png)

## Linux系统配置DNS

如上网卡IP地址配置完毕，如果服务器需上外网，还需配置域名解析地址（Domain Name System，DNS），DNS主要用于将请求的域名转换为IP地址，DNS地址配置方法如下：

修改`vi /etc/resolv.conf` 文件，在文件中加入如下两条:

```
nameserver 202.106.0.20 
nameserver 8.8.8.8
```

如上分别表示主DNS于备DNS，DNS配置完毕后，无需重启网络服务,DNS是立即生效。

可以 `ping -c 6 www.baidu.com`
查看返回结果，如果有IP返回，则表示服务器DNS配置正确，如图3-13所示：

![图3-13 ping命令返回值](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855560.png)

## Linux网卡名称命名

CentOS7服务器，默认网卡名为ifcfg-eno16777736，如果我们想改成ifcfg-eth0，使用如下步骤即可：

1.  编辑/etc/sysconfig/grub文件，命令为`vi /etc/sysconfig/grub`，在倒数第二行quiet后加入如下代码，并如图3-14所示：
`net.ifnames=0 biosdevname=0`

![图3-14 网卡配置ifnames设置](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855564.png)

2.  执行命令`grub2-mkconfig -o /boot/grub2/grub.cfg`，生成新的grub.cfg文件，如图3-15所示：
`grub2-mkconfig -o /boot/grub2/grub.cfg`

![图3-15 生成新的grub.cnf文件](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855566.png)

3.  重命名网卡名称，执行命令`mv ifcfg-eno16777736 ifcfg-eth0`，修改ifcfg-eth0文件中DEVICE= eno16777736为DEVICE=eth0，如图3-16所示：

![图3-16 重命名网卡名称](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855949.png)

4.  重启服务器，并验证网卡名称是否为eth0，Reboot完后，如图3-17所示：

![图3-17 验证网卡设备名称](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856343.png)

## CentOS7密码重置

修改CentOS 7 ROOT密码非常简单，只需登录系统，执行命令passwd回车即可，但是如果忘记ROOT，无法登录系统，该如何去重置ROOT用户的密码呢？如下为重置ROOT用户的密码的方法：

1.  Reboot重启系统，系统启动进入欢迎界面，加载内核步骤时，按e，然后选中“CentOS Linux （3.10.0-327.e17.x86_64）7 （Core）”，如图3-18所示：

![图3-18 内核菜单选择界面](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855739.png)

2.  继续按e进入编辑模式，找到ro crashkernel=auto xxx项，将ro改成rw init=/sysroot/bin/sh，如图3-19所示：

![图3-19 内核编辑界面](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855742.png)

3.  修改为后如图3-20所示：

![图3-20 内核编辑界面](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855746.png)

4.  按ctrl+x按钮进入单用户模式，如图3-21所示：

![图3-21 进入系统单用户模式](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855744.png)

5.  执行命令chroot /sysroot访问系统，并使用passwd修改root密码，如图3-22所示：

![图3-22 修改ROOT用户密码](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855748.png)

6.  更新系统信息，`touch /.autorelabel`，执行命令`touch /.autorelabel`，在/目录下创建一个.autorelabel文件，如果该文件存在，系统在重启时就会对整个文件系统进行relabeling重新标记，可以理解为对文件进行底层权限的控制和标记，如果seLinux属于disabled关闭状态则不需要执行这条命令，如图3-23所示：

![图3-23 创建autorelabel文件](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855752.png)

## 远程管理Linux服务器

系统安装完毕后，可以通过远程工具来连接到Linux服务器，远程连接服务器管理的好处在于可以跨地区管理服务器，例如读者在北京，想管理的服务器在上海某IDC机房，通过远程管理后，不需要到IDC机房现场去操作，直接通过远程工具即可管理，与在现场的管理是一模一样。

远程管理Linux服务器要满足如下三个步骤：
1.  服务器配置IP地址，如果服务器在公网，需配置公网IP，如果服务器在内部局域网，可以直接配置内部私有IP即可；
2.  服务器安装SSHD软件服务并启动该服务，几乎所有的Linux服务器系统安装完毕均会自动安装并启动SSHD服务，SSHD服务监听22端口，关于SSHD服务、OpenSSH及SSH协议后面章节会讲解；
3.  在服务器中防火墙服务需要允许22端口对外开放，初学者可以临时关闭防火墙，CentOS6 Linux关闭防火墙的命令：`service iptables stop`，而CentOS7 Linux关闭防火墙的命令：`systemctl stop firewalld.service`。

常见的Linux远程管理工具包括：SecureCRT、Xshell、Putty、Xmanger等工具。目前主流的远程管理Linux服务器工具为SecureCRT，[官网](https://www.vandyke.com) 下载并安装SecureCRT，打开工具，点击左上角quick connect快速连接，弹出界面如图3-24所示，连接配置具体步骤如下：

-   协议（P）：选择SSH2
-   主机名（H）：输入Linux服务器IP地址
-   端口（o）: 22
-   防火墙（F）：None
-   用户名（U）：root

单击下方的“连接”，会提示输入密码，输入root用户对应密码即可。

![图3-24 SecureCRT远程Linux服务器](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855754.png)

通过SecureCRT远程连接Linux服务器之后，会发现如图3-25所示界面，与服务器本地操作界面一样，在命令行可以执行命令，操作结果与在服务器现场操作是一样。

![图3-25 SecureCRT远程Linux服务器](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856024.png)

## Linux系统目录功能

通过以上知识的学习,读者已经能够独立安装并配置Linux服务器IP并远程连接，为了进一步学习Linux，需熟练掌握Linux系统各个目录的功能。

Linux主要树结构目录包括：/、/root、/home、/usr、/bin、/tmp、/sbin、/proc、/boot等，如图3-26所示，为典型的Linux目录结构如下：

![图3-26 Linux目录树形结构](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855886.png)

Linux系统中常见目录功能如下：

-   / 根目录；
-   /bin 存放必要的命令；
-   /boot 存放内核以及启动所需的文件；
-   /\[dev](http://www.baike.com/wiki/dev) 存放硬件设备文件；
-   /etc 存放系统配置文件；
-   /home 普通用户的宿主目录，用户数据存放在其主目录中； 
-   /lib\|lib64 存放必要的运行库；
-   /mnt 存放临时的映射文件系统，通常用来挂载使用；
-   /proc 存放存储进程和系统信息；
-   /root 超级用户的主目录；
-   /sbin 存放系统管理程序；
-   /tmp 存放临时文件；
-   /usr 存放应用程序，命令程序文件、程序库、手册和其它文档；
-   /var 系统默认日志存放目录。

# 第四章 Linux必备命令

Linux系统启动默认为字符界面，一般不会启动图形界面，所以对命令行的熟练程度能更加方便、高效的管理Linux系统。

本章向读者介绍Linux系统必备命令各项参数及功能场景，Linux常见命令包括：cd、ls、pwd、mkdir、rm、cp、mv、touch、cat、head、tail、chmod、vim等。

## Linux命令集

初学者完成Linux系统安装以后，学习Linux操作系统必备的指令，基于Linux指令管理Linux操作系统，必备Linux指令有哪些？

-   基础命令相关一：
Cd、ls、pwd、help、man、if、for、while、case、select、read、test、ansible、iptables、firewall-cmd、salt、mv、cut、uniq、sort、wc、source、sestatus、setenforce；

-   基础命令相关二：
Date、ntpdate、crontab、rsync、ssh、scp、nohup、sh、bash、hostname、hostnamectl、source、ulimit、export、env、set、at、dir、db_load、diff、dmsetup、declare；

-   用户权限相关：
Useradd、userdel、usermod、groupadd、groupmod、groupdel、Chmod、chown、chgrp、umask、chattr、lsattr、id、who、whoami、last、su、sudo、w、chpasswd、chroot；

-   文件管理相关：
Touch、mkdir、rm、rmdi、vi、vim、cat、head、tail、less、more、find、sed、grep、awk、echo、ln、stat、file；

-   软件资源管理：
Rpm、yum、tar、unzip、zip、gzip、wget、curl、rz、sz、jar、apt-get、bzip2、service、systemctl、make、cmake、chkconfig；

-   系统资源管理：
Fdisk、mount、umount、mkfs.ext4、fsck.ext4、parted、lvm、dd、du、df、top、iftop、free、w、uptime、iostat、vmstat、iotop、ps、netstat、lsof、ss、sar；

-   网络管理相关：
Ping、ifconfig、ip addr、ifup、ifdown、nmcli、route、nslookup、traceroute、dig、tcpdump、nmap、brctl、ethtool、setup、arp、ab、iperf；

-   Linux系统开关机：
Init、reboot、shutdown、halt、poweroff、runlevel、login、logout、exit；

## cd命令详解

cd命令主要用于目录切换，例如：
cd /home切换至/home目录
cd /root表示切换至/root目录 
cd ../切换至上一级目录
cd ./切换至当前目录。

其中.和..可以理解为相对路径，例如
cd ./test表示以当前目录为参考，表示相对于当前
而cd /home/test表示完整的路径，理解为绝对路径

如图4-1所示：
![图4-1 Linux cd命令操作](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855757.png)

## ls命令详解

ls命令主要用于浏览目录下的文件或者文件夹，使用方法参考：ls ./
查看当前目录所有的文件和目录，ls -a
查看所有的文件，包括隐藏文件,以.开头的文件，常用参数详解如下:

-a, --all 不隐藏任何以. 开始的项目； 
-A,	--almost-all 列出除. 及.. 以外的任何项目； 
	  --author 与-l 同时使用时列出每个文件的作者； 
-b, --escape 以八进制溢出序列表示不可打印的字符；
	 --block-size=大小 块以指定大小的字节为单位； 
-B, --ignore-backups 不列出任何以"\~"字符结束的项目； 
-d, --directory 当遇到目录时列出目录本身而非目录内的文件； 
-D, --dired 产生适合Emacs 的dired 模式使用的结果；
-f 不进行排序，-aU 选项生效，-lst 选项失效； 
-i, --inode 显示每个文件的inode 号； 
-I, --ignore=PATTERN 不显示任何符合指定shell PATTERN 的项目； 
-k 即--block-size=1K； 
-l 使用较长格式列出信息； 
-n, --numeric-uid-gid 类似 -l，但列出UID 及GID 号； 
-N, --literal 输出未经处理的项目名称 (如不特别处理控制字符) ； 
-r, --reverse 排序时保留顺序； 
-R, --recursive 递归显示子目录； 
-s, --size 以块数形式显示每个文件分配的尺寸； 
-S 根据文件大小排序； 
-t 根据修改时间排序； 
-u 同 -lt 一起使用：按照访问时间排序并显示； 
	同 -l 一起使用：显示访问时间并按文件名排序； 
	其他：按照访问时间排序； 
-U 不进行排序；按照目录顺序列出项目； 
-v 在文本中进行数字(版本)的自然排序.

## pwd命令详解

pwd命令主要用于显示或者查看当前所在的目录路径，如图4-2所示：

![图4-2 pwd命令查看当前目录](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855759.png)

## mkdir命令详解

mkdir命令主要用于创建目录，用法mkdir dirname，命令后接目录的名称，常用参数详解如下:

用法：mkdir [选项]... 目录；若指定目录不存在则创建目录；
长选项必须使用的参数对于短选项时也是必需使用的；
-m, --mode=模式 设置权限模式(类似chmod)，而不是rwxrwxrwx 减umask； 
-p, --parents 需要时创建目标目录的上层目录，但即使这些目录已存在也不当作错误处理； 
-v, --verbose 每次创建新目录都显示信息；
-Z, --context=CTX 将每个创建的目录的SELinux 安全环境设置为CTX； 
--help 显示此帮助信息并退出；
--version 显示版本信息并退出。

## rm命令详解

rm 命令主要用于删除文件或者目录，用法 rm –rf test.txt (-r表示递归，-f表示强制)，常用参数详解如下:

用法：rm \[选项]... 文件...删除 (unlink) 文件。 
-f, --force 强制删除。忽略不存在的文件，不提示确认； 
-i 在删除前需要确认； 
-I 在删除超过三个文件或者递归删除前要求确认。此选项比-i 提示内容更少，但同样可以阻止大多数错误发生； 
-r, -R, --recursive 递归删除目录及其内容； 
-v, --verbose 详细显示进行的步骤； 
--help 显示此帮助信息并退出； 
--version 显示版本信息并退出； 

默认时，rm 不会删除目录，使用--recursive(-r 或-R)选项可删除每个给定的目录，以及其下所有的内容； 要删除第一个字符为"-"的文件 (例如"-foo")，请使用以下方法之一： 
rm -- -foo 
rm ./-foo


## cp命令详解

cp 命令主要用于拷贝文件，用法,cp old.txt /tmp/new.txt，常用来备份，如果拷贝目录需要加-r参数，常用参数详解如下:

用法：cp \[选项]... \[-T] 源文件 目标文件 　
	或：cp\[选项]... 源文件... 目录 　
	或：cp \[选项]... -t 目录 源文件... 
	将源文件复制至目标文件，或将多个源文件复制至目标目录。 
	长选项必须使用的参数对于短选项时也是必需使用的。 
	
-a,		--archive 等于-dR --preserve=all； 
		 --backup \[=CONTROL 为每个已存在的目标文件创建备份； 
-b 类似--backup 但不接受参数； 
		 --copy-contents 在递归处理是复制特殊文件内容； 
-d 等于--no-dereference --preserve=links； 
-f, --force 如果目标文件无法打开则将其移除并重试(当 -n 选项； 存在时则不需再选此项)； 
-i, --interactive 覆盖前询问(使前面的 -n 选项失效)； 
-H 跟随源文件中的命令行符号链接； 
-l, --link 链接文件而不复制； 
-L, --dereference 总是跟随符号链接； 
-n, --no-clobber 不要覆盖已存在的文件(使前面的 -i 选项失效)； 
-P, --no-dereference 不跟随源文件中的符号链接； 
-p 等于--preserve=模式,所有权,时间戳； 
		 --preserve\[=属性列表 保持指定的属性(默认：模式,所有权,时间戳)，如果； 可能保持附加属性：环境、链接、xattr 等； -c same as --preserve=context； 
		 --sno-preserve=属性列表 不保留指定的文件属性； 
		 --parents 复制前在目标目录创建来源文件路径中的所有目录； 
-R, -r, --recursive 递归复制目录及其子目录内的所有内容。 


## mv命令详解

mv 命令主要用于重命名或者移动文件或者目录，用法, mv old.txt new.txt，常用参数详解如下:

用法：mv \[选项]... \[-T] 源文件 目标文件； 
	或：mv \[选项]... 源文件... 目录； 
	或：mv \[选项]... -t 目录 源文件； 
	将源文件重命名为目标文件，或将源文件移动至指定目录。
	长选项必须使用的参数对于短选项时也是必需使用的。 
	--backup\[=CONTROL] 为每个已存在的目标文件创建备份； 
-b 类似--backup 但不接受参数； 
-f, --force 覆盖前不询问； 
-i, --interactive 覆盖前询问； 
-n, --no-clobber 不覆盖已存在文件，如果您指定了-i、-f、-n 中的多个，仅最后一个生效； 
		 --strip-trailing-slashes 去掉每个源文件参数尾部的斜线； 
-S, --suffix=SUFFIX 替换常用的备份文件后缀； 
-t, --target-directory=DIRECTORY 将所有参数指定的源文件或目录； 移动至 指定目录； 
-T, --no-target-directory 将目标文件视作普通文件处理； 
-u, --update 只在源文件文件比目标文件新，或目标文件； 不存在时才进行移动； 
-v, --verbose 详细显示进行的步骤； 
--help 显示此帮助信息并退出； 
--version 显示版本信息并退出。

## touch命令详解

touch 命令主要用于创建普通文件，用法为touch test.txt，如果文件存在，则表示修改当前文件时间，常用参数详解如下:

用法：touch \[选项]... 文件... 
将每个文件的访问时间和修改时间改为当前时间； 
不存在的文件将会被创建为空文件，除非使用-c 或-h 选项； 
如果文件名为"-"则特殊处理，更改与标准输出相关的文件的访问时间； 
长选项必须使用的参数对于短选项时也是必需使用的； 

-a 只更改访问时间； 
-c, --no-create 不创建任何文件； 
-d, --date=字符串 使用指定字符串表示时间而非当前时间； 
-f (忽略)； 
-h, --no-dereference 会影响符号链接本身，而非符号链接所指示的目的地； (当系统支持更改符号链接的所有者时，此选项才有用)； 
-m 只更改修改时间； 
-r, --reference=文件 使用指定文件的时间属性而非当前时间； 
-t STAMP 使用\[\[CC]YY]MMDDhhmm\[.ss] 格式的时间而非当前时间； 
--time=WORD 使用WORD 指定的时间：access、atime、use 都等于-a； 选项的效果，而modify、mtime 等于-m 选项的效果； 
--help 显示此帮助信息并退出； 
--version 显示版本信息并退出。

## cat命令详解

cat 命令主要用于查看文件内容，用法 cat test.txt,可以查看test.txt内容，常用参数详解如下:

用法：cat \[选项]... \[文件]... 将\[文件]或标准输入组合输出到标准输出。 
-A, --show-all 等于-vET； 
-b, --number-nonblank 对非空输出行编号； 
-e 等于-vE； 
-E, --show-ends 在每行结束处显示"\$"； 
-n, --number 对输出的所有行编号； 
-s, --squeeze-blank 不输出多行空行； 
-t 与-vT 等价； 
-T, --show-tabs 将跳格字符显示为\^I； 
-u (被忽略)； 
-v, --show-nonprinting 使用\^ 和M- 引用，除了LFD和 TAB 之外； 
--help 显示此帮助信息并退出； 
--version 显示版本信息并退出。

cat还有一种用法，cat …EOF…EOF，表示追加内容至 /tmp/test.txt 文件中，如下：

```
cat \>\> /tmp/test.txt \<\< EOF 
My Name is JFEDU.NET 
I am From Bei jing. 
EOF
```

cat test.txt |more
分页显示text内容，|符号是管道符，用于把|前的输出作为后面命令的输入。
More命令常用于分页查看某文件或者内容。

## head命令详解

head命令主要用于查看文件内容，通常查看文件前10行，`head -10 /var/log/messages` 可以查看该文件前10行的内容，常用参数详解如下:

用法：head \[选项]... \[文件]... 
将每个指定文件的头10 行显示到标准输出。 
如果指定了多于一个文件，在每一段输出前会给出文件名作为文件头。 
如果不指定文件，或者文件为"-"，则从标准输入读取数据，
长选项必须使用的参数对于短选项时也是必需使用的； 

-q, --quiet, --silent 不显示包含给定文件名的文件头； 
-v, --verbose 总是显示包含给定文件名的文件头； 
--help 显示此帮助信息并退出； 
--version 显示版本信息并退出； 
-c, --bytes=\[-]K 显示每个文件的前K 字节内容，如果附加"-"参数，则除了每个文件的最后K字节数据外显示剩余全部内容； 
-n, --lines=\[-]K 显示每个文件的前K 行内容，如果附加"-"参数，则除了每个文件的最后K 行外显示剩余全部内容。

## echo命令详解

echo命令主要用于打印字符或者回显，例如输入echo ok，会显示ok， `echo ok > test.txt` 则会把ok字符覆盖test.txt内容。>表示覆盖，原内容被覆盖，>>表示追加，原内容不变。

例如 `echo ok >> test.txt` ,表示向test.txt文件追加OK字符，不覆盖原文件里的内容，常用参数详解如下:

使用-e扩展参数选项时，与如下参数一起使用，有不同含义，例如： \\a 发出警告声 \\b 删除前一个字符 \\c 最后不加上换行符号； \\f 换行但光标仍旧停留在原来的位置； \\n 换行且光标移至行首； \\r 光标移至行首，但不换行； \\t 插入tab； \\v 与\\f相同； \\\\ 插入\\字符； \\033\[30m 黑色字 \\033\[0m \\033\[31m 红色字 \\033\[0m \\033\[32m 绿色字 \\033\[0m \\033\[33m 黄色字 \\033\[0m \\033\[34m 蓝色字 \\033\[0m \\033\[35m 紫色字 \\033\[0m \\033\[36m 天蓝字 \\033\[0m \\033\[37m 白色字 \\033\[0m \\033\[40;37m 黑底白字 \\033\[0m \\033\[41;37m 红底白字 \\033\[0m \\033\[42;37m 绿底白字 \\033\[0m \\033\[43;37m 黄底白字 \\033\[0m \\033\[44;37m 蓝底白字 \\033\[0m \\033\[45;37m 紫底白字 \\033\[0m \\033\[46;37m 天蓝底白字 \\033\[0m \\033\[47;30m 白底黑字 \\033\[0m 

echo颜色打印扩展，auto_lamp_v2.sh内容如下：

echo -e "\\033\[36mPlease Select Install Menu follow:\\033\[0m" 
echo -e "\\033\[32m1)Install Apache Server\\033\[1m"
echo "2)Install MySQL Server"
echo "3)Install PHP Server" 
echo "4)Configuration index.php and start LAMP server" 
echo -e "\\033\[31mUsage: { /bin/sh \$0 1\|2\|3\|4\|help}\\033\[0m"

执行结果如图4-3所示：

![图4-3 echo –e颜色打印](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855760.png)

## df命令详解

df命令常用于磁盘分区查询，常用命令df –h，查看磁盘分区信息，常用参数详解如下:

用法：df \[选项]... \[文件]... 
显示每个文件所在的文件系统的信息，默认是显示所有文件系统。 
长选项必须使用的参数对于短选项时也是必需使用的。 
-a, --all 显示所有文件系统的使用情况，包括虚拟文件系统； 
-B, --block-size=SIZE 使用字节大小块； 
-h, --human-readable 以人们可读的形式显示大小； 
-H, --si 同-h，但是强制使用1000而不是1024； 
-i, --inodes 显示inode 信息而非块使用量； 
-k 即--block-size=1K； 
-l, 	--local 只显示本机的文件系统； 
		--no-sync 取得使用量数据前不进行同步动作(默认)； 
-P,	   --portability 使用POSIX 兼容的输出格式； 
		--sync 取得使用量数据前先进行同步动作； 
-t, --type=类型 只显示指定文件系统为指定类型的信息； 
-T, --print-type 显示文件系统类型；
-x, --exclude-type=类型 只显示文件系统不是指定类型信息； 
--help 显示帮助信息并退出； 
--version 显示版本信息并退出。

## vi\|vim编辑器实战

VI是一个命令行界面下的文本编辑工具，最早在1976年由Bill Joy开发，当时名字叫做ex。vi支持绝大多数操作系统（最早在BSD上发布），并且功能已经十分强大

1991年Bram Moolenaar基于vi进行改进，发布了vim，加入了对GUI的支持。

随着VIM更新发展，VIM已经不是普通意义上的文本编辑器，而是被广泛的作为在文本编辑、文本处理、代码开发等用途，Linux中主流的文本编辑器包括：VI、Vim、Sublime、Emacs、Light Table、Eclipse、Gedit等。

Vim强大的编辑能力中很大部分是来自于其普通模式命令。vim的设计理念是命令的组合。

-   `5dd` 5表示总共5行，删除光标所在后的5行，包含光标行；

-   `d\$` \$"代表行尾,删除到行尾的内容，包含光标；

-   `2yy` 表示复制光标及后2行，包括光标行；

-   `%d` %代表全部或者全局,%d表示删除文本所有的内容，也即是清空文档所有的内容。

如图4-4为vim与键盘键位功能对应关系：

![图4-4 vim与键盘位置对应关系](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052855883.png)

## VIM编辑器模式

Vim编辑器模式常用有三种，分别是：

-   命令行模式；
-   文本输入模式；
-   末行模式。

vim是vi的升级版本，它是安装在Linux操作系统中的一个软件，官网为：[www.vim.org](http://www.vim.org)

在Linux Shell终端下默认执行vim命令，按Enter键后：

-   默认进入命令行模式；
-   在命令行模式按i进入文本输入模式；
-   按ESC进入命令行模式；
-   按:进入末行模式。
## 本章小结

通过对本章内容的学习，读者对Linux操作系统引导有了进一步的理解，能够快速解决Linux启动过程中的故障，同时学习了CentOS6与CentOS7系统的区别，理解了TCP/IP协议及IP地址相关基础内容。

学会了Linux初学必备的16个Linux命令，能使用命令熟练的操作Linux系统，通过对VIM编辑器的深入学习，能够熟练编辑、修改系统中任意的文本及配置文件。对Linux系统的认识及操作有了更进一步的飞跃。

## 同步作业

1.  修改密码的命令默认为passwd，需要按Enter键两次，如何一条命令快速修改密码呢?
2.  企业服务器，某天发现系统访问很慢，需要查看系统内核日志，请写出查看系统内核日志的命令；
3.  如果在Linux系统/tmp/目录，快速创建1000个目录，目录名为：jfedu1、jfedu2、jfedu依次类推，不断增加；
4.  Httpd.conf配置文件中存在很多以\#号开头的行，请使用vim相关指令删除\#开头的行；

# 第五章 Linux用户及权限管理

Linux是一个多用户的操作系统，引入用户，可以更加方便管理Linux服务器，系统默认需要以一个用户的身份登入，而且在系统上启动进程也需要以一个用户身份去运行，用户可以限制某些进程对特定资源的权限控制。

本章向读者介绍Linux系统如何管理创建、删除、修改用户角色、用户权限配置、组权限配置及特殊权限深入剖析。

## Linux用户及组

Linux操作系统对多用户的管理，是非常繁琐的，所以用组的概念来管理用户就变得简单，每个用户可以在一个独立的组，每个组也可以有零个用户或者多个用户。

Linux系统用户是根据用户ID来识别的，从默认ID编号从0开始，但是为了和老式系统兼容，用户ID限制在60000以下，Linux用户分总共分为三种，分别如下：

-   root用户 （ID 0）
-   系统用户 （ID 1-499）
-   普通用户 （ID 500以上）

Linux系统中的每个文件或者文件夹，都有一个所属用户及所属组，使用id命令可以显示当前用户的信息，使用passwd命令可以修改当前用户密码。Linux操作系统用户的特点如下：

-   每个用户拥有一个UserID，操作系统实际读取的是UID，而非用户名；
-   每个用户属于一个主组，属于一个或多个附属组，一个用户最多有31个附属组；
-   每个组拥有一个GroupID；
-   每个进程以一个用户身份运行，该用户可对进程拥有资源控制权限；
-   每个可登陆用户拥有一个指定的Shell环境。

## Linux用户管理

Linux用户在操作系统可以进行日常管理和维护，涉及到的相关配置文件如下：

-   /etc/passwd 保存用户信息
-   /etc/shdaow 保存用户密码（以加密形式保存）
-   /etc/group 保存组信息
-   /etc/login.defs 用户属性限制,密码过期时间,密码最大长度等限制
-   /etc/default/useradd 显示或更改默认的useradd配置文件

如需创建新用户，可以使用命令useradd，执行命令useradd
jfedu1即可创建jfedu1用户，同时会创建一个同名的组jfedu1，默认该用户属于jfedu1主组。

Useradd jfedu1命令默认创建用户jfedu1，会根据如下步骤进行操作：

-   读取/etc/default/useradd，根据配置文件执行创建操作；
-   在/etc/passwd文件中添加用户信息；
-   如使用passwd命令创建密码，密码会被加密保存在/etc/shdaow中；
-   为jfedu1创建家目录：/home/jfedu1；
-   将/etc/skel中的.bash开头的文件复制至/home/jfedu1家目录；
-   创建与用户名相同的jfedu1组，jfedu1用户默认属于jfeud1同名组；
-   Jfedu1组信息保存在/etc/group配置文件中。
-   
在使用useradd命令创建用户时，可以支持如下参数：

用法：useradd \[选项] 登录 
useradd -D 
useradd -D \[选项] 

选项： 
-b, --base-dir BASE_DIR 指定新账户的家目录；
-c, --comment COMMENT 新账户的 GECOS 字段；
-d, --home-dir HOME_DIR 新账户的主目录； 
-D, --defaults 显示或更改默认的 useradd 配置； 
-e, --expiredate EXPIRE_DATE 新账户的过期日期；
-f, --inactive INACTIVE 新账户的密码不活动期； 
-g, --gid GROUP 新账户主组的名称或ID； 
-G, --groups GROUPS 新账户的附加组列表； 
-h, --help 显示此帮助信息并推出； 
-k, --skel SKEL_DIR 使用此目录作为骨架目录； 
-K, --key KEY=VALUE 不使用 /etc/login.defs 中的默认值；
-l, --no-log-init 不要将此用户添加到最近登录和登录失败数据库； 
-m, --create-home 创建用户的主目录； 
-M, --no-create-home 不创建用户的主目录；
-N, --no-user-group 不创建同名的组； 
-o, --non-unique 允许使用重复的 UID 创建用户； 
p, --password PASSWORD 加密后的新账户密码；
-r, --system 创建一个系统账户； 
-R, --root CHROOT_DIR chroot 到的目录；
-s, --shell SHELL 新账户的登录 shell； 
-u, --uid UID 新账户的用户 ID； 
-U, --user-group 创建与用户同名的组；
-Z, --selinux-user SEUSER 为SELinux 用户映射使用指定 SEUSER。

Useradd案例演示：

1.  新建jfedu用户，并加入到jfedu1，jfedu2附属组；
`useradd -G jfedu1,jfedu2 jfedu`

2.  新建jfedu3用户，并指定新的家目录，同时指定其登陆的SHELL；
`useradd jfedu3 -d /tmp/ -s /bin/bash`

## Linux组管理

所有的Linux或者Windows系统都有组的概念，通过组可以更加方便的管理用户，组的概念应用于各行行业，例如企业会使用部门、职能或地理区域的分类方式来管理成员，映射在Linux系统，同样可以创建用户，并用组的概念对其管理。

Linux组有如下特点：

-   每个组有一个组ID；
-   组信息保存在/etc/group中；
-   每个用户至少拥有一个主组，同时还可以拥有31个附属组。

通过命令groupadd、groupdel、groupmod来对组进行管理，详细参数使用如下：

groupadd用法 
-f, --force 如果组已经存在则成功退出； 并且如果 GID 已经存在则取消 –g； 
-g, --gid GID 为新组使用 GID； 
-h, --help 显示此帮助信息并推出； 
-K, --key KEY=VALUE 不使用 /etc/login.defs 中的默认值； 
-o, --non-unique 允许创建有重复 GID 的组； 
-p, --password PASSWORD 为新组使用此加密过的密码； 
-r, --system 创建一个系统账户； 

groupmod用法 
-g, --gid GID 将组 ID 改为 GID；
-h, --help 显示此帮助信息并推出；
-n, --new-name NEW_GROUP 改名为 NEW_GROUP； 
-o, --non-unique 允许使用重复的 GID； 
-p, --password PASSWORD 将密码更改为(加密过的) PASSWORD；

groupdel用法 
groupdel jfedu 删除jfedu组;

Groupadd案例演示：
1.  groupadd创建jingfeng组
`groupadd jingfeng`

2.  groupadd创建jingfeng组，并指定GID为1000；
`groupadd -g 1000 jingfeng`

3.  groupadd创建一个system组，名为jingfeng组
`groupadd -r jingfeng`

Groupmod案例演示：
1.  groupmod修改组名称，将jingfeng组名，改成jingfeng1；
`groupmod -n jingfeng1 jingfeng`

2.  groupmod修改组GID号，将原jingfeng1组gid改成gid 1000；
`groupmod –g 1000 jingfeng1`

## Linux用户及组案例

Useradd主要用于新建用户,而用户新建完毕
可以使用usermod来修改用户及组的属性，如下为usermod详细参数：

用法：usermod \[选项] 登录 
选项： 
-c, --comment 注释 GECOS 字段的新值； 
-d, --home HOME_DIR 用户的新主目录； 
-e, --expiredate EXPIRE_DATE 设定帐户过期的日期为 EXPIRE_DATE；
-f, --inactive INACTIVE 过期 INACTIVE 天数后，设定密码为失效状态；
-g, --gid GROUP 强制使用 GROUP 为新主组；
-G, --groups GROUPS 新的附加组列表 GROUPS；
-a, --append GROUP 将用户追加至上边 -G 中提到的附加组中， 并不从其它组中删除此用户；
-h, --help 显示此帮助信息并推出； 
-l, --login LOGIN 新的登录名称；
-L, --lock 锁定用户帐号； 
-m, --move-home 将家目录内容移至新位置 (仅于 -d 一起使用)； 
-o, --non-unique 允许使用重复的(非唯一的) UID； 
-p, --password PASSWORD 将加密过的密码 (PASSWORD) 设为新密码；
-R, --root CHROOT_DIR chroot 到的目录； 
-s, --shell SHELL 该用户帐号的新登录shell环境； 
-u, --uid UID 用户帐号的新UID； 
-U, --unlock 解锁用户帐号； 
-Z, --selinux-user SEUSER 用户账户的新SELinux 用户映射。

Usermod案例演示：
1.  将jfedu用户属组修改为jfedu1，jfedu2附属组；
`usermod -G jfedu1,jfedu2 jfedu`

2.  将jfedu用户加入到jfedu3，jfedu4附属组，-a为添加新组，原组保留；
`usermod –a -G jfedu3,jfedu4 jfedu`

3.  修改jfedu用户，并指定新的家目录，同时指定其登陆的SHELL；
`usermod -d /tmp/ -s /bin/sh jfedu`

4.  将jfedu用户名修改为jfedu1；
`usermod -l jfedu1 jfedu`

5.  锁定jfedu1用户及解锁jfedu1用户方法；
`usermod –L jfedu1 usermod -U jfedu1`

Userdel案例演示：
使用userdel可以删除指定用户及其用户的邮箱目录或者Selinux映射环境：

`userdel jfedu1` 保留用户的家目录；
`userdel -r jfedu1` 删除用户及用户家目录，用户login系统无法删除；
`userdel -rf jfedu1` 强制删除用户及该用户家目录，不论是否login系统。

## Linux权限管理

Linux权限是操作系统用来限制对资源访问的机制，权限一般分为读、写、执行。系统中每个文件都拥有特定的权限、所属用户及所属组，通过这样的机制来限制哪些用户或用户组可以对特定文件进行相应的操作。

Linux每个进程都是以某个用户身份运行，进程的权限与该用户的权限一样，用户的权限越大，则进程拥有的权限就越大。

Lnux中有的文件及文件夹都有至少权限三种权限，常见的权限如表5-1所示:

| **权限**| **对文件的影响** | **对目录的影响**|
|---------------|-------------------------------|------------------------------|
| r（读取）                             | 可读取文件内容   | 可列出目录内容                |
| w（写入）                            | 可修改文件内容   | 可在目录中创建删除内容 |
| x（执行）                             | 可作为命令执行   | 可访问目录内容               |
| 目录必须拥有x权限，否则无法查看其内容 	      | | |
[表5-1 Linux 文件及文件及权限]

Linux权限授权，默认是授权给三种角色，分别是user、group、other，Linux权限与用户之间的关联如下：

-   U代表User，G代表Group，O代表Other；
-   每个文件的权限基于UGO进行设置；
-   权限三位一组（rwx），同时需授权给三种角色，UGO；
-   每个文件拥有一个所属用户和所属组，对应UGO，不属于该文件所属用户或所属组使用O来表示；

在Linux系统中，可以通过ls –l查看jfedu.net目录的详细属性，如图5-1所示：
`drwxrwxr-x 2 jfedu1 jfedu1 4096 Dec 10 01:36 jfedu.net`

![图5-1 Linux jfedu.net目录详细属性](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856348.png)

jfedu.net目录属性参数详解如下：

-   d 表示目录，同一位置如果为-则表示普通文件；
-   rwxrwxr-x 表示三种角色的权限，每三位为一种角色，依次为u，g，o权限，如上则表示user的权限为rwx，group的权限为rwx，other的权限为r-x；
-   2表示文件夹的链接数量，可理解为该目录下子目录的数量；
-   从左到右，第一个jfedu1表示该用户名，第二个jfedu1则为组名，其他人角色默认不显示；
-   4096表示该文件夹占据的字节数；
-   Dec 10 01:36 表示文件创建或者修改的时间；
-   Jfedu.net 为目录的名，或者文件名。

## Chown属主及属组 

修改某个用户、组对文件夹的属主及属组，用命令chown实现，案例演示如下：

1.  修改jfedu.net文件夹所属的用户为root，其中-R参数表示递归处理所有的文件及子目录。
`chown -R root jfedu.net`

2.  修改jfedu.net文件夹所属的组为root。
`chown -R :root jfedu.net或者chgrp –R root jfedu.net`

3.  修改jfedu.net文件夹所属的用户为root，组也为root。
`chown -R root:root jfedu.net`

## Chmod用户及组权限 

修改某个用户、组对文件夹的权限，用命令chmod实现，其中以代指ugo，、-、=代表加入、删除和等于对应权限，具体案例如下：

1.  授予用户对jfedu.net目录拥有rwx权限
`chmod –R u+rwx jfedu.net`

2.  授予组对jfedu.net目录拥有rwx权限
`chmod –R g+rwx jfedu.net`

3.  授予用户、组、其他人对jfedu.net目录拥有rwx权限
`chmod –R u+rwx,g+rwx,o+rwx jfedu.net`

4.  撤销用户对jfedu.net目录拥有w权限
`chmod –R u-w jfedu.net`

5.  撤销用户、组、其他人对jfedu.net目录拥有x权限
`chmod –R u-x,g-x,o-x jfedu.net`

6.  授予用户、组、其他人对jfedu.net目录只有rx权限
`chmod –R u=rx,g=rx,o=rx jfedu.net`

## Chmod二进制权限 

Linux权限默认使用rwx来表示，为了更简化在系统中对权限进行配置和修改，Linux权限引入二进制表示方法，如下代码：

Linux权限可以将rwx用二进制来表示，其中有权限用1表示，没有权限用0表示； 
Linux权限用二进制显示如下： 
rwx=111 
r-x=101 
rw-=110 
r--=100 
依次类推，转化为十进制，对应十进制结果显示如下： 
rwx=111=4+2+1=7 
r-x=101=4+0+1=5 
rw-=110=4+4+0=6 
r--=100=4+0+0=4 
得出结论，用r=4,w=2,x=1来表示权限。

使用二进制方式来修改权限案例演示如下，其中默认jfedu.net目录权限为755：

1.  授予用户对jfedu.net目录拥有rwx权限
`chmod –R 755 jfedu.net`

2.  授予组对jfedu.net目录拥有rwx权限
`chmod –R 775 jfedu.net`

3.  授予用户、组、其他人对jfedu.net目录拥有rwx权限
`chmod –R 777 jfedu.net`

4.  撤销用户对jfedu.net目录拥有w权限
`chmod –R 555 jfedu.net`

5.  撤销用户、组、其他人对jfedu.net目录拥有x权限
`chmod –R 644 jfedu.net`

6.  授予用户、组、其他人对jfedu.net目录只有rx权限
`chmod –R 555 jfedu.net`

## 本章小结

通过对本章内容的学习，读者可以了解Linux用户和组的系统知识，同时账号Linux用户和组在系统中各种案例操作。读者可以熟练新建用户、删除用户、修改用户属性、添加组、修改组以及删除组。

## 同步作业

1.  某互联网公司职能及员工信息表，如表5-3所示，请在Linux系统中创建相关员工，并把员工加入到部门。

| **部门**         | **职能**      |
|------------------|---------------|
| 讲师部(teacher)  | jfwu,jfcai    |
| 市场部(market)   | jfxin,jfqi    |
| 管理部(manage)   | jfedu,jfteach |
| 运维部(operater) | jfhao,jfyang  |
[表5-3 Linux用户和组管理]

2.  批量创建1-100个用户，用户名以jfedu开头，后面紧跟1,2,3，例如jfedu1,jfedu2,jfedu3。

3.  使用useradd创建用户并通过-p参数指定密码，设定完密码需通过系统能正常验证并登陆。

4.  小王公司服务器，使用Root用户通过SecureCRT远程登陆后，如图5-3所示，发现登录终端变成bash-4.1\#，是什么原因导致？以及如何修复为正常的登录SHELL环境，请写出答案。

![图5-3 SecureCRT登录Linux系统界面](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856017.png)

# 第六章 Linux软件包企业实战

通过前几章的学习，读者掌握了Linux系统基本命令、用户及权限等知识，Linux整个体系的关键不在于系统本身，而是在于可以基于Linux系统去安装和配置企业中相关的软件、数据及应用程序，所以对软件的维护是运维工程师的重中之重。

本章向读者介绍Linux系统软件的安装、卸载、配置、维护以及如何构建企业本地YUM光盘源及HTTP本地源。

## RPM软件包管理

Linux软件包管理大致可分为二进制包、源码包，使用的工具也各不相同。Linux常见软件包分为两种，分别是源代码包（Source Code）、二进制包（Binary Code），源代码包是没有经过编译的包，需要经过GCC、C++编译器环境编译才能运行，二进制包无需编译，可以直接安装使用。

通常而言，可以通过后缀简单区别源码包和二进制包，例如.tar.gz、.zip、.rar结尾的包通常称之为源码包，以.rpm结尾的软件包称之为二进制包。真正区分是否为源码还是二进制还得基于代码里面的文件来判断，例如包含.h、.c、.cpp、.cc等结尾的源码文件，称之为源码包，而代码代码里面存在bin可执行文件，称之为二进制包。

CentOS操作系统中有一款默认软件管理的工具，红帽包管理工具（Red Hat Package Manager，RPM）。

使用RPM工具可以对软件包实现快速安装、管理及维护。RPM管理工具适用的操作系统包括：CentOS，RedHat，Fedora，SUSE等，RPM工具常用于管理.rpm后缀结尾的软件包。

RPM软件包命令规则详解如下：

RPM包命名格式为： 
name-version.rpm 
name-version-noarch.rpm 
name-version-arch.src.rpm 
如下软件包格式： 
epel-release-6-8.noarch.rpm 
perl-Pod-Plainer-1.03-1.el6.noarch.rpm 
yasm-1.2.0-4.el7.x86_64.rpm 

RPM包格式解析如下：
-   name 软件名称，例如yasm、perl-pod-Plainer；
-   version 版本号，1.2.0通用格式：“主版本号.次版本号.修正号”；
	4表示是发布版本号，该RPM包是第几次编译生成的；
-   arch 适用的硬件平台，RPM支持的平台有：i386、i586、i686、x86_64、sparc、alpha等。
-   .rpm 后缀包表示编译好的二进制包，可用rpm命令直接安装；
-   .src.rpm 源代码包，源码编译生成.rpm格式的RPM包方可使用；
-   el\* 软件包发行版本，el6表示该软件包适用于RHEL 6.x/CentOS 6.x；
-   devel： 开发包；
-   noarch： 软件包可以在任何平台上安装。

RPM工具命令详解如下：
RPM 选项 PACKAGE_NAME 

-a, --all 查询所有已安装软件包； 
-q，--query 表示询问用户，输出信息； 
-l, --list 打印软件包的列表； 
-f, --file FILE 查询包含 FILE 的软件包； 
-i, --info 显示软件包信息，包括名称，版本，描述； 
-v, --verbose 打印输出详细信息； 
-U, --upgrade 升级RPM软件包； 
-h,	   --hash 软件安装，可以打印安装进度条； 
		--last 列出软件包时，以安装时间排序，最新的在上面； 
-e,    --erase 卸载rpm软件包 
		--force 表示强制，强制安装或者卸载； 
		--nodeps RPM包不依赖 
-l, 	--list 列出软件包中的文件； 
		--provides 列出软件包提供的特性； 
-R,   --requires 列出软件包依赖的其他软件包； 
		--scripts 列出软件包自定义的小程序。

RPM企业案例演示：
`rpm -q httpd` 检查httpd包是否安装； 
`rpm -ql httpd` 查看软件安装的路径； 
`rpm -qi httpd` 查看软件安装的版本信息； 
`rpm -e httpd` 卸载httpd软件； 
`rpm -e --nodeps httpd` 强制卸载httpd； 
`rpm -qa\|grep httpd` 检查httpd相关的软件包是否安装。 
`rpm -ivh httpd-2.4.10-el7.x86_64.rpm` 安装httpd软件包； 
`rpm -Uvh httpd-2.4.10-el7.x86_64.rpm` 升级httpd软件； 
`rpm -ivh --nodeps httpd-2.4.10-el7.x86_64.rpm` 不依赖其他软件包；

## Tar软件包管理

Linux操作系统除了使用RPM管理工具对软件包管理之外，还可以通过tar、zip、jar等工具进行源码包的管理。

### Tar命令参数详解

-A, --catenate, --concatenate 将存档与已有的存档合并 
-c, --create 建立新的存档 
-d, 	--diff, --compare 比较存档与当前文件的不同之处 
		--delete 从存档中删除 
-r, --append 附加到存档结尾 
-t, --list 列出存档中文件的目录 
-u, --update 仅将较新的文件附加到存档中 
-x, --extract, --get 解压文件 
-j, --bzip2, --bunzip2 有bz2属性的软件包；
-z, --gzip, --ungzip 有gz属性的软件包；
-b, --block-size N 指定块大小为 Nx512 字节（缺省时 N=20)；
-B, --read-full-blocks 读取时重组块； 
-C, 	--directory DIR 指定新的目录； 
		--checkpoint 读取存档时显示目录名； 
-f, 	--file \[HOSTNAME:] F 指定存档或设备，后接文件名称； 
		--force-local 强制使用本地存档，即使存在克隆； 
-G, --incremental 建立老 GNU 格式的备份； 
-g, --listed-incremental 建立新 GNU 格式的备份； 
-h, --dereference 不转储动态链接，转储动态链接指向的文件； 
-i, 	--ignore-zeros 忽略存档中的 0 字节块（通常意味着文件结束）； 
		--ignore-failed-read 在不可读文件中作 0 标记后再退出；
-k, --keep-old-files 保存现有文件；从存档中展开时不进行覆盖； 
-K, --starting-file F 从存档文件 F 开始；
-l, --one-file-system 在本地文件系统中创建存档； 
-L, --tape-length N 在写入 N\*1024 个字节后暂停，等待更换磁盘；
-m, --modification-time 当从一个档案中恢复文件时，不使用新的时间标签；
-M, --multi-volume 建立多卷存档,以便在几个磁盘中存放； 
-O, --to-stdout 将文件展开到标准输出； 
-P, --absolute-paths 不要从文件名中去除 '/'；
-v, 	--verbose 详细显示处理的文件； 
		--version 显示tar 程序的版本号； 
		--exclude FILE不把指定文件包含在内；
-X, --exclude-from FILE 从指定文件中读入不想包含的文件的列表。

### TAR企业案例演示

`tar -cvf jfedu.tar.gz jfedu` 打包jfedu文件或者目录，打包后名称jfedu.tar.gz； 
`tar -tf jfedu.tar.gz` 查看jfedu.tar.gz包中内容； 
`tar -rf jfedu.tar.gz jfedu.txt` 将jfedu.txt文件追加到jfedu.tar.gz中 
`tar -xvf jfedu.tar.gz` 解压jfedu.tar.gz程序包； 
`tar -czvf jfedu.tar.gz jfedu` 使用gzip格式打包并压缩jfedu目录； 
`tar -cjvf jfedu.tar.bz2 jfedu` 使用bzip2格式打包并压缩jfedu目录；
`tar -czf jfedu.tar.gz \* -X list.txt` 使用gzip格式打包并压当前目录所有文件，排除list.txt中记录的文件； 
`tar -czf jfedu.tar.gz \* --exclude=zabbix-3.2.4.tar.gz --exclude=nginx-1.12.0.tar.gz` 使用gzip格式打包并压当前目录所有文件及目录，排除zabbix-3.2.4.tar.gz和nginx-1.12.0.tar.gz软件包。

### TAR实现Linux操作系统备份

Tar命令工具除了用于日常打包、解压源码包或者压缩包之外，最大的亮点是还可以用于Linux操作系统文件及目录的备份，使用 tar -g 可以基于GNU 格式的增量备份，备份原理是基于检查目录或者文件的atime、mtime、ctime属性是否被修改。文件及目录时间属性详解如下：

-   文件被访问的时间(Access time,atime)；
-   文件内容被改变的时间（Modified time，mtime)；
-   文件写入、权限更改的时间（Change time，ctime)。

总结，更改文件内容mtime和ctime都会改变，但ctime可以在mtime未发生变化时被更改，例如修改文件权限，文件mtime时间不变，而ctime时间改变。TAR增量备份案例演示步骤如下：

1.  /root目录创建jingfeng文件夹，同时在jingfeng文件夹中，新建jf1.txt，jf2.txt文件，如图6-1所示：

![图6-1 创建jingfeng目录及文件](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856008.png)

2.  使用tar命令第一次完整备份jingfeng文件夹中的内容，-g指定快照snapshot文件，第一次没有该文件则会自动创建，如图6-2所示：

`cd /root/jingfeng/`
`tar -g /data/backup/snapshot -czvf /data/backup/2019jingfeng.tar.gz`

![图6-2 tar备份jingfeng目录中文件](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856012.png)

3.  使用tar命令第一次完整备份jingfeng文件夹中之后，会生成快照文件：/data/backup/snapshot，后期增量备份会以snapshot文件为参考，在jingfeng文件夹中再创建jf3.txt ,jf4.txt文件，然后通过tar命令增量备份jingfeng目录所有内容，如图6-3所示：
```
cd /root/jingfeng/ 
touch jf3.txt jf4.txt 
tar -g /data/backup/snapshot -czvf /data/backup/2019jingfeng_add1.tar.gz *
```

![图6-3 tar增量备份jingfeng目录中文件](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856116.png)

如上图6-3所示，增量备份时，需-g指定第一次完整备份的快照snapshot文件，同时增量打包的文件名不能跟第一次备份后的文件名重复，通过 tar –tf 可以查看打包后的文件内容。

### Shell+TAR实现增量备份

企业中日常备份的数据包括/boot、/etc、/root、/data目录等，备份的策略参考：每周1-6执行增量备份，每周日执行全备份。同时在企业中备份操作系统数据均使用Shell脚本完成，此处auto_backup_system.sh脚本供参考，后面章节会系统讲解Shell脚本，脚本内容如下：

``` shell
#!/bin/bash
#Automatic Backup Linux System Files
#By Author www.jfedu.net
#Define Variables
SOURCE_DIR=(
    $*
)
TARGET_DIR=/data/backup/
YEAR=`date +%Y`
MONTH=`date +%m`
DAY=`date +%d`
WEEK=`date +%u`
FILES=system_backup.tgz
CODE=$?
if
    [ -z $SOURCE_DIR ]；then
    echo -e "Please Enter a File or Directory You Need to Backup:\n--------------------------------------------\nExample $0 /boot /etc ......"
    exit
fi
#Determine Whether the Target Directory Exists
if
    [ ! -d $TARGET_DIR/$YEAR/$MONTH/$DAY ]；then
    mkdir -p $TARGET_DIR/$YEAR/$MONTH/$DAY
    echo "This $TARGET_DIR Created Successfully !"
fi
#EXEC Full_Backup Function Command
Full_Backup()
{
if
    [ "$WEEK" -eq "7" ]；then
    rm -rf $TARGET_DIR/snapshot
    cd $TARGET_DIR/$YEAR/$MONTH/$DAY ；tar -g $TARGET_DIR/snapshot -czvf $FILES `echo ${SOURCE_DIR[@]}`
    [ "$CODE" == "0" ]&&echo -e  "--------------------------------------------\nFull_Backup System Files Backup Successfully !"
fi
}
#Perform incremental BACKUP Function Command
Add_Backup()
{
   cd $TARGET_DIR/$YEAR/$MONTH/$DAY ；
if
    [ -f $TARGET_DIR/$YEAR/$MONTH/$DAY/$FILES ]；then
    read -p "$FILES Already Exists, overwrite confirmation yes or no ? : " SURE
    if [ $SURE == "no" -o $SURE == "n" ]；then
    sleep 1 ；exit 0
    fi
#Add_Backup Files System
    if
        [ $WEEK -ne "7" ]；then
        cd $TARGET_DIR/$YEAR/$MONTH/$DAY ；tar -g $TARGET_DIR/snapshot -czvf $$_$FILES `echo ${SOURCE_DIR[@]}`
        [ "$CODE" == "0" ]&&echo -e  "-----------------------------------------\nAdd_Backup System Files Backup Successfully !"
    fi
else
   if
      [ $WEEK -ne "7" ]；then
      cd $TARGET_DIR/$YEAR/$MONTH/$DAY ；tar -g $TARGET_DIR/snapshot -czvf $FILES `echo ${SOURCE_DIR[@]}`
      [ "$CODE" == "0" ]&&echo -e  "-------------------------------------------\nAdd_Backup System Files Backup Successfully !"
   fi
fi
}
Full_Backup；Add_Backup
```

## ZIP软件包管理

ZIP也是计算机文件的压缩的算法，原名Deflate（真空），发明者为菲利普·卡兹（Phil Katz)），他于1989年1月公布了该格式的资料。ZIP通常使用后缀名“.zip”。

主流的压缩格式包括tar、rar、zip、war、gzip、bz2、iso等。从性能上比较，TAR、WAR、RAR格式较ZIP格式压缩率较高，但压缩时间远远高于ZIP，Zip命令行工具可以实现对zip属性的包进行管理，也可以将文件及文件及打包成zip格式。如下为ZIP工具打包常见参数详解：

-f freshen：只更改文件； 
-u update：只更改或新文件； 
-d 从压缩文件删除文件； 
-m 中的条目移动到zipfile（删除OS文件）； 
-r 递归到目录； 
-j junk（不记录）目录名； 
-l 将LF转换为CR LF（-11 CR LF至LF）； 
-1 压缩更快1-9压缩更好； 
-q 安静操作，不输出执行的过程； 
-v verbose操作/打印版本信息； 
-c 添加一行注释； 
-z 添加zipfile注释； 
-o 读取名称使zip文件与最新条目一样旧； 
-x 不包括以下名称； 
-F 修复zipfile（-FF尝试更难）； 
-D 不要添加目录条目； 
-T 测试zip文件完整性； 
-X eXclude eXtra文件属性； 
-e 加密 - 不要压缩这些后缀； 
-h2 显示更多的帮助。

ZIP企业案例演示：

1.  通过zip工具打包jingfeng文件夹中所有内容，如图6-4所示：
`zip -rv jingfeng.zip /root/jingfeng/`

![图6-4 zip对jingfeng目录打包备份](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856236.png)

2.  通过zip工具打包jingfeng文件夹中所有内容，排除部分文件，如图6-5所示：
`zip -rv jingfeng.zip \* -x jf1.txt zip -rv jingfeng.zip \* -x jf2.txt -x jf3.txt`

![图6-5 zip对jingfeng目录打包备份，排除部分文件](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856238.png)

3.  通过zip工具删除jingfeng.zip中jf3.txt文件，如图6-6所示
`zip jingfeng.zip -d jf3.txt`

4.  通过unzip工具解压jingfeng.zip文件夹中所有内容，如图6-6所示：
`unzip jingfeng.zip unzip jingfeng.zip -d /data/backup/ 可以-d指定解压后的目录`

![图6-6 unzip对jingfeng目录解压](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856239.png)

## 源码包软件安装

通常使用RPM工具管理.rpm结尾的二进制包，而标准的.zip、tar结尾的源代码包则不能使用RPM工具去安装、卸载及升级，源码包安装有三个步骤，如下：

-  ./configure 预编译，主要用于检测系统基准环境库是否满足，生成MakeFile文件
-   make 编译，基于第一步生成的makefile文件，进行源代码的编译；
-   make install 安装，编译完毕之后，将相关的可运行文件安装至系统中；

使用make编译时，Linux操作系统必须有GCC编译器，用于编译源码。
源码包安装通常需要./configure、make、make
install三个步骤，某些特殊源码可以只有三步中的其中一个步骤，或者两个步骤。

以CentOS 7 Linux系统为基准，在其上安装Nginx源码包，企业中源码安装的详细步骤如下：

1.  Nginx.org官网下载Nginx-1.13.0.tar.gz包
`wget http://nginx.org/download/nginx-1.13.0.tar.gz`

2.  Nginx源码包解压
`tar -xvf nginx-1.13.0.tar.gz`

3.  源码Configure预编译，需进入解压后的目录执行./configure指令，分号“；”表示连接多个命令。
`cd nginx-1.13.0；./configure`

4.  make编译
`make`

5.  make install安装
`make install`

通过以上五个步骤，源码包软件安装成功，源码包在编译及安装时，可能会遇到各种错误，需要把错误解决之后，然后再进行下一步安装即可，后面章节会重点针对企业使用的软件进行案例演练。

## YUM软件包管理

前端软件包管理器（Yellow Updater Modified，YUM）适用于CentOS、Fedora、RedHat及SUSE中的Shell命令行，主要用于管理RPM包，于RPM工具使用范围类似，YUM工具能够从指定的服务器自动下载RPM包并且安装，还可以自动处理依赖性关系。

使用RPM工具管理和安装软件时，会发现rpm包有依赖，需要逐个手动下载安装，而YUM工具的最大便利就是可以自动安装所有依赖的软件包，从而提升效率，节省时间。

### YUM工作原理

学习YUM，一定要理解YUM工作原理，YUM正常运行，需要依赖两个部分，一是YUM源端，二是YUM客户端，也即用户使用端。

YUM客户端安装的所有RPM包都是来自YUM服务端，YUM源端通过HTTP或者FTP服务器发布。而YUM客户端能够从YUM源端下载依赖的RPM包是由于在YUM源端生成了RPM包的基准信息，包括RPM包版本号、配置文件、二进制信息、依赖关系等。

YUM客户端需要安装软件或者搜索软件，会查找/etc/yum.repos.d下以.repo结尾文件，CentOS Linux默认的.repo文件名为CentOS-Base.repo，该文件中配置了YUM源端的镜像地址，所以每次安装、升级RPM包，YUM客户端均会查找.repo文件。

YUM客户端如果配置了CentOS官方repo源，客户端操作系统必须能联外网，满足网络条件，才能下载软件并安装，如果没有网络，也可以构建光盘源或者内部YUM源。在只要YUM客户端时，YUM客户端安装软件，默认会把YUM源地址、Header信息、软件包、数据库信息、缓存文件存储在/var/cache/yum中，每次使用YUM工具，YUM优先通过Cache查找相关软件包，Cache中不存在，然后在访问外网YUM源。

### YUM企业案例演练

由于YUM工具的使用简便、快捷、高效，在企业中得到广泛的使用，得到众多IT运维、程序人员的青睐，要能熟练使用YUM工具，需要先掌握YUM命令行参数的使用，如下为YUM命令工具的参数详解及实战步骤：

YUM命令工具指南，YUM格式为： 
YUM \[command] \[package] -y\|-q 其中的\[options]是可选。
-y安装或者卸载出现YES时，自动确认yes；
-q不显示安装的过程。 

`yum install httpd` 安装httpd软件包； 
`yum search` YUM搜索软件包； 
`yum list httpd` 显示指定程序包安装情况httpd； 
`yum list` 显示所有已安装及可安装的软件包； 
`yum remove httpd` 删除程序包httpd； 
`yum erase httpd` 删除程序包httpd； 
`yum update` 内核升级或者软件更新； 
`yum update httpd` 更新httpd软件； 
`yum check-update` 检查可更新的程序； 
`yum info httpd` 显示安装包信息httpd； 
`yum provides` 列出软件包提供哪些文件；
`yum provides "\*/rz"` 列出rz命令由哪个软件包提供；
`yum grouplist` 查询可以用groupinstall安装的组名称； 
`yum groupinstall "Chinese Support"` 安装中文支持；
`yum groupremove "Chinese Support"` 删除程序组Chinese Support；
`yum deplist httpd` 查看程序httpd依赖情况；
`yum clean packages` 清除缓存目录下的软件包；
`yum clean headers` 清除缓存目录下的headers；
`yum clean all` 清除缓存目录下的软件包及旧的headers.

1.  基于CentOS 7 Linux，执行命令yum install httpd -y，安装httpd服务，如图6-7所示：

![图6-7 YUM 安装httpd软件](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856245.png)

2.  执行命令yum grouplist，检查groupinstall的软件组名，如图6-8所示：

![图6-8 YUM Grouplist显示组安装名称](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856241.png)

3.  执行命令yum groupinstall "GNOME Desktop" -y，安装Linux图像界面，如图6-9所示:

![图6-9 GNOME Desktop图像界面安装](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856243.png)

4.  执行命令yum install httpd php php-devel php-mysql mariadb mariadb-server -y，安装中小企业LAMP架构环境，如图6-10所示:

![图6-10 LAMP中小企业架构安装](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856251.png)

5.  执行命令yum remove ntpdate -y，卸载ntpdate软件包，如图6-11所示:

![图6-11 卸载NTPDATE软件](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856249.png)

6.  执行命令yum provides rz或者yum provides "\*/rz"，查找rz命令的提供者，如图6-12所示：

![图6-12 查找RZ命令的提供者](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856247.png)

7.  执行命令yum update -y，升级Linux所有可更新的软件包或Linux内核升级，如图6-13所示：

![图6-13 软件包升级或内核升级](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856660.png)

## YUM优先级配置实战

基于YUM安装软件时,通常会配置多个Repo源，而Fastest mirror 插件是为拥有多个镜像的软件库配置文件而设计的。它会连接到每一个镜像，计算连接所需的时间，然后将镜像按快到慢排序供YUM应用。

默认CentOS Linux系统，Fastestmirror插件是开启的，所以安装软件会从最快的镜像源安装，但是由于Repo源很多，而在这些源中都存在某些软件包,但有些软件有重复,甚至冲突,能否可以优先从一些Repo源中去查找，如果找不到，再去其他源中找呢？

可以使用YUM优先级插件解决该问题，YUM提供的插件yum-plugin-priorities，直接YUM安装即可，命令如下：
`yum install -y yum-plugin-priorities`

![](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856253.png)

修改YUM源优先级配置文件，设置为Enabled，开启优先级插件，1为开启，0为禁止；

vim /etc/yum/pluginconf.d/priorities.conf
enabled = 1

![](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856256.png)

vim 修改/etc/yum.repos./xx.repo文件，在base段中加入如下指令：（优先级为1表示优先被查找，越大其反而被后续查找）

priority=1

![](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856258.png)

基于YUM安装ntpdate软件，测试已经优先从163源中查找；

![](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856438.png)

## 基于ISO镜像构建YUM本地源

通常而言，YUM客户端使用前提是必须联外网，YUM安装软件时，检查repo配置文件查找相应的YUM源仓库，企业IDC机房很多服务器为了安全起见，是禁止服务器上外网的，所以不能使用默认的官方YUM源仓库。

构建本地YUM光盘源，其原理是通过查找光盘中的软件包，实现YUM安装，配置步骤如下：

1.  将CentOS-7-x86_64-DVD-1511.iso镜像加载至虚拟机CD/DVD或者放入服务器CD/DVD光驱中，并将镜像文件挂载至服务器/mnt目录，如图6-14所示，挂载命令：
`mount /dev/cdrom /mnt/`

![图6-14 CentOS ISO镜像文件挂载](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856260.png)

2.  备份/etc/yum.repos.d/CentOS-Base.repo文件为CentOS-Base.repo.bak，同时在/etc/yum.repos.d目录下创建media.repo文件，并写入如下内容：
```
[yum] 
name=CentOS7 
baseurl=file:///mnt 
enabled=1 
gpgcheck=1 
gpgkey=file:///mnt/RPM-GPG-KEY-CentOS-7
```

Media.repo配置文件详解：

name=CentOS7 YUM源显示名称； 
baseurl=file:///mnt ISO镜像挂载目录； 
gpgcheck=1 是否检查GPG-KEY； 
enabled=1 是否启用YUM源； 
gpgkey=file:///mnt/RPM-GPG-KEY-CentOS-7 指定载目录下的GPG-KEY文件验证。

1.  运行命令yum clean all清空YUM Cache，执行yum install screen –y安装screen软件如图6-15所示：

![图6-15 YUM 安装Screen软件](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856332.png)

2.  至此YUM光盘源构建完毕，在使用YUM源时，会遇到部分软件无法安装，原因是因为光盘中软件包不完整导致，同时光盘源只能本机使用，其他局域网服务器无法使用。

## 基于HTTP构建YUM网络源

YUM光盘源默认只能本机使用，局域网其他服务器无法使用YUM光盘源，如果想使用的话，需要在每台服务器上构建YUM本地源，该方案在企业中不可取，所以需要构建HTTP局域网YUM源解决，可以通过CreateRepo创建本地YUM源端，repo即为Repository。

构建HTTP局域网YUM源方法及步骤如下：
1.  挂载光盘镜像文件至/mnt
`mount /dev/cdrom /mnt/`

2.  拷贝/mnt/Packages目录下所有软件包至/var/www/html/centos/
`mkdir -p /var/www/html/centos/ cp -R /mnt/Packages/\* /var/www/html/centos/`

3.  使用Createrepo创建本地源，执行如下命令会在Centos目录生成repodata目录，目录内容如图6-16所示：
`yum install createrepo\* -y cd /var/www/html createrepo centos/`

![图6-16 Createrepo生成repodata目录](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856790.png)

4.  利用HTTP发布YUM本地源

本地YUM源通过CreateRepo搭建完毕，需要借助HTTP WEB服务器发布/var/www/html/centos/中所有软件，YUM或者RPM安装HTTP WEB服务器，并启动httpd服务。

```
yum install httpd httpd-devel -y 安装HTTP WEB服务； 
useradd apache -g apache 创建apache用户和组；
systemctl restart httpd.service 重启HTTPD服务；
setenforce 0 临时关闭SeLinux应用级安全策略；
systemctl stop firewalld.service 停止防火墙； 
ps -ef \|grep httpd 查看HTTPD进程是否启动。
```

1.  在YUM客户端，创建/etc/yum.repos.d/http.repo文件，写入如下内容：
```
[base] 
name="CentOS7 HTTP YUM" 
baseurl=http://192.168.1.115/centos/ 
gpgcheck=0 
enabled=1 

[updates] 
name="CentOS7 HTTP YUM" 
baseurl=http://192.168.1.115/centos 
gpgcheck=0 
enabled=1
```

2.  至此在YUM客户端上执行如下命令，如图6-17所示：
`yum clean all` 清空YUM Cache； 
`yum install ntpdate -y` 安装NTPDATE软件。

![图6-17 HTTP YUM源客户端验证](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856785.png)

## YUM源端软件包扩展

默认使用ISO镜像文件中的软件包构建的HTTP YUM源，会发现缺少很多软件包，如果服务器需要挂载移动硬盘，Mount挂载移动硬盘需要ntfs-3g软件包支持，而本地光盘镜像中没有该软件包，此时需要往YUM源端添加ntfs-3g软件包，添加方法如下：

1.  切换至/var/www/html/centos目录，官网下载NTFS-3G软件包。

`cd /var/www/html/centos/ `
`wget http://dl.fedoraproject.org/pub/epel/7/x86_64/n/ntfs-3g-2016.2.22-3.el7.x86_64.rpm http://dl.fedoraproject.org/pub/epel/7/x86_64/n/ntfs-3g-devel-2016.2.22-3.el7.x86_64.rpm`

2.  Createrepo命令更新软件包，同理，如需新增其他软件包，同样把软件下载至本地，然后通过createrepo更新即可，如图6-18所示：
`createrepo --update centos/`

![图6-18 CreateRepo update更新软件包](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856433.png)

3.  客户端YUM验证，安装NTFS-3G软件包，如图6-19所示：

![图6-19 YUM INSTALL NTFS-3G软件包](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856541.png)

## 同步外网YUM源

在企业实际应用场景中，仅仅靠光盘里面的RPM软件包是不能满足需要，我们可以把外网的YUM源中的所有软件包同步至本地，可以完善本地YUM源的软件包数量及完整性。

获取外网YUM源软件常见方法包括Rsync、Wget、Reposync，三种同步方法的区别Rsync方式需要外网YUM源支持RSYNC协议，Wget可以直接获取，而Reposync可以同步几乎所有的YUM源，下面以Reporsync为案例，同步外网YUM源软件至本地，步骤如下：

1.  下载CentOS7 REPO文件至/etc/yum.repos.d/，并安装reposync命令工具：
```
wget http://mirrors.163.com/.help/CentOS7-Base-163.repo 
mv CentOS7-Base-163.repo /etc/yum.repos.d/centos.repo 
yum clean all 
yum install yum-utils createrepo –y 
yum repolist
```

2.  通过reposync命令工具获取外网YUM源所有软件包，-r指定repolist id，默认不加-r表示获取外网所有YUM软件包，-p参数表示指定下载软件的路径，如图6-20（a）、图6-20（b）所示：
`reposync -r base -p /var/www/html/centos/ reposync -r updates -p /var/www/html/centos/`

![图6-20（a） Reposync获取外网YUM源软件包](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856436.png)

![图6-20（b） Reposync获取外网YUM源软件包](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856652.png)

3.  通过reposync工具下载完所有的软件包之后，需要执行createrepo更新本地YUM仓库：
`createrepo /var/www/html/centos/`

## 本章小结

通过对本章内容的学习，读者掌握了Linux安装不同包的工具及命令，使用RPM及YUM管理.RPM结尾的二进制包，基于configure、make、make install实现源码包安装，并能够对软件进行安装、卸载及维护。

能够独立构建企业光盘源、HTTP网络YUM源，实现无外网网络使用YUM安装各种软件包及工具，同时能随时添加新的软件包至本地Yum源中。

## 同步作业

1.  RPM及YUM管理工具的区别是什么？
2.  企业中安装软件，何时选择YUM安装或者源码编译安装？
3.  将Linux系统中PHP5.3版本升级至PHP5.5版本，升级方法有几种，分别写出升级步骤？
4.  使用源码编译安装httpd-2.4.25.tar.bz2，写出安装的流程及注意事项。
5.  如何将CentOS 7 Linux字符界面升级为图形界面，并设置系统启动默认为图形界面？

# 第七章 Linux文件服务器企业实战

运维和管理企业Linux服务器，除了要熟练Linux系统本身的维护和管理之外，最重要的是熟练甚至精通基于Linux系统安装配置各种应用软件，对软件进行调优以及软件在使用中遇到各类问题，能够快速定位并解决问题。

本章向读者介绍进程、线程、企业Vsftpd服务器实战、匿名用户访问、系统用户访问及虚拟用户实战等。

## Vsftpd服务器企业实战

文件传输协议（File Transfer Protocol，FTP），基于该协议FTP客户端与服务端可以实现共享文件、上传文件、下载文件。 FTP 基于[TCP](http://baike.baidu.com/subview/32754/8048820.htm)协议生成一个虚拟的连接，主要用于控制FTP连接信息，同时再生成一个单独的TCP连接用于FTP[数据传输](http://baike.baidu.com/view/875888.htm)。用户可以通过客户端向FTP服务器端上传、下载、删除文件，FTP服务器端可以同时提供给多人共享使用。

FTP服务是Client/Server（简称C/S）模式，基于FTP协议实现FTP文件对外共享及传输的软件称之为FTP服务器源端，客户端程序基于FTP协议，则称之为FTP客户端，FTP客户端可以向FTP服务器上传、下载文件。

### FTP传输模式

FTP基于C/S模式，FTP客户端与服务器端有两种传输模式，分别是FTP主动模式、FTP被动模式，主被动模式均是以FTP服务器端为参照。主被动模式如图8-2（a）、8-2（b）所示，主被动模式详细区别如下：

-   FTP主动模式：客户端从一个任意的端口N（N\>1024）连接到FTP服务器的port 21命令端口，客户端开始监听端口N+1，并发送FTP命令“port N+1”到FTP服务器，FTP服务器以数据端口（20）连接到客户端指定的数据端口（N+1）。

-   FTP被动模式：客户端从一个任意的端口N（N\>1024）连接到FTP服务器的port 21命令端口，客户端开始监听端口N+1，客户端提交
    PASV命令，服务器会开启一个任意的端口（P \>1024），并发送PORT P命令给客户端。客户端发起从本地端口N+1到服务器的端口P的连接用来传送数据。

在企业实际环境中，如果FTP客户端与FTP服务端均开放防火墙，FTP需以主动模式工作，这样只需要在FTP服务器端防火墙规则中，开放20、21端口即可。关于防火墙配置后面章节会讲解。

![图8-2（a） FTP主动模式](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856440.jpg)

![图8-2（b） FTP被动模式](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856537.jpg)

### Vsftpd服务器简介

目前主流的FTP服务器端软件包括：Vsftpd、ProFTPD、PureFTPd、Wuftpd、Server-U FTP、 FileZilla Server等软件，其中Unix/Linux使用较为广泛的FTP服务器端软件为Vsftpd 。

非常安全的FTP服务进程（Very Secure FTP daemon，Vsftpd），Vsftpd在Unix/[Linux](http://www.ha97.com/category/linux)发行版中最主流的FTP服务器程序，优点小巧轻快，安全易用、稳定高效、满足企业跨部门、多用户的使用（1000用户）等。

Vsftpd基于GPL开源协议发布，在中小企业中得到广泛的应用，Vsftpd可以快速上手，基于Vsftpd虚拟用户方式，访问验证更加安全。Vsftpd还可以基于MYSQL数据库做安全验证，多重安全防护。

### Vsftpd服务器安装配置

Vsftpd服务器端安装有两种方法，一是基于YUM方式安装，而是基于源码编译安装，最终实现效果完全一致，本文采用YUM安装Vsftpd，步骤如下：

1.  在命令行执行如下命令，如图8-3所示：
`yum install vsftpd\* -y`

![图8-3 YUM安装Vsftpd服务端](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856539.png)

2.  打印vsftpd安装后的配置文件路径、启动Vsftpd服务及查看进程是否启动，如图8-4所示：
```
rpm -q l vsftpd |more 
systemctl restart vsftpd.service 
ps -ef |grep vsftpd
```

![图8-4 打印Vsftpd软件安装后路径](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856543.png)

3.  Vsftpd.conf默认配置文件详解如下：

```
anonymous_enable=YES		开启匿名用户访问；
local_enable=YES			    启用本地系统用户访问；
write_enable=YES			    本地系统用户写入权限；
local_umask=022			    本地用户创建文件及目录默认权限掩码；
dirmessage_enable=YES		打印目录显示信息，通常用于用户第一次访问目录时，信息提示；
xferlog_enable=YES			启用上传/下载日志记录；	
connect_from_port_20=YES	FTP使用20端口进行数据传输；
xferlog_std_format=YES		日志文件将根据xferlog的标准格式写入；
listen=NO					Vsftpd不以独立的服务启动，通过Xinetd服务管理，建议改成YES；
listen_ipv6=YES				启用IPV6监听；
pam_service_name=vsftpd	    登录FTP服务器，依据/etc/pam.d/vsftpd中内容进行认证；
userlist_enable=YES			vsftpd.user_list和ftpusers配置文件里用户禁止访问FTP；
tcp_wrappers=YES			    设置vsftpd与tcp wrapper结合进行主机的访问控制，Vsftpd服务器检查/etc/hosts.allow 和/etc/hosts.deny中的设置，来决定请求连接的主机，是否允许访问该FTP服务器。
```

4.  启动Vsftpd服务后，通过Windows客户端资源管理器访问Vsftp服务器端，如图8-5所示：
`ftp://192.168.111.131/`

![图8-5 匿名用户访问FTP默认目录](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856650.png)

FTP主被动模式，默认为主动模式，设置为被动模式使用端口方法如下：
```
pasv_enable=YES 
pasv_min_port=60000 
pasv_max_port=60100
```

### Vsftpd匿名用户配置

Vsftpd默认以匿名用户访问，匿名用户默认访问的FTP服务器端路径为：/var/ftp/pub，匿名用户只有查看权限，无法创建、删除、修改。如需关闭FTP匿名用户访问，需修改配置文件/etc/vsftpd/vsftpd.conf，将anonymous_enable=YES修改为anonymous_enable=NO，重启Vsftpd服务即可。

如果允许匿名用户能够上传、下载、删除文件，需在/etc/vsftpd/vsftpd.conf配置文件中加入如下代码：
```
anon_upload_enable=YES 允许匿名用户上传文件； 
anon_mkdir_write_enable=YES 允许匿名用户创建目录； 
anon_other_write_enable=YES 允许匿名用户其他写入权限。 
```

匿名用户完整vsftpd.conf配置文件代码如下：

```
anonymous_enable=YES
local_enable=YES
write_enable=YES
local_umask=022
anon_upload_enable=YES
anon_mkdir_write_enable=YES
anon_other_write_enable=YES
dirmessage_enable=YES
xferlog_enable=YES
connect_from_port_20=YES
xferlog_std_format=YES
listen=NO
listen_ipv6=YES
pam_service_name=vsftpd
userlist_enable=YES
tcp_wrappers=YES

```

由于默认Vsftpd匿名用户有两种：anonymous、ftp，所以匿名用户如果需要上传文件、删除及修改等权限，需要ftp用户对/var/ftp/pub目录有写入权限，使用如下chown和chmod任意一种即可，设置命令如下：

`chown -R ftp pub/ chmod o+w pub/`

如上Vsftpd.conf配置文件配置完毕，同时权限设置完，重启vsftpd服务即可，通过Windows客户端访问，能够上传文件、删除文件、创建目录等操作，如图8-6所示：

![图8-6 匿名用户访问上传文件](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856545.png)

### Vsftpd系统用户配置

Vsftpd匿名用户设置完毕，匿名用户，任何人都可以查看FTP服务器端的文件、目录，甚至可以修改、删除，此方案如适合存放私密文件在FTP服务器端，如何保证文件或者目录专属拥有者呢，Vsftpd系统用户可以实现该需求。

实现Vsftpd系统用户方式验证，只需在Linux系统中创建多个用户即可，创建用户使用useradd，同时给用户设置密码，即可通过用户和密码登录FTP，进行文件上传、下载、删除等操作。Vsftpd系统用户实现方法步骤如下：

1.  Linux系统中创建系统用户jfedu1、jfedu2，分别设置密码为123456：
```
useradd   jfedu1
useradd   jfedu2
echo 123456|passwd --stdin  jfedu1
echo 123456|passwd --stdin  jfedu2

```

2.  修改vsftpd.conf配置文件代码如下：
```
anonymous_enable=NO
local_enable=YES
write_enable=YES
local_umask=022
dirmessage_enable=YES
xferlog_enable=YES
connect_from_port_20=YES
xferlog_std_format=YES
listen=NO
listen_ipv6=YES
pam_service_name=vsftpd
userlist_enable=YES
tcp_wrappers=YES

```

3.  通过Windows资源客户端验证，使用jfedu1、jfedu2用户登录FTP服务器，即可上传文件、删除文件、下载文件，jfedu1、jfedu2系统用户上传文件的家目录在/home/jfedu1、/home/jfedu2下，如图8-7（a）、8-7（b）所示：

![图8-7（a） jfedu1用户登录FTP服务器](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856547.png)

![图8-7（b） jfedu1登录FTP服务器上传文件](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856549.png)

### Vsftpd虚拟用户配置

如果基于Vsftpd系统用户访问FTP服务器，系统用户越多越不利于管理，而且不利于系统安全管理，鉴于此，为了能更加的安全使用VSFTPD，需使用Vsftpd虚拟用户方式。

Vsftpd虚拟用户原理：虚拟用户就是没有实际的真实系统用户，而是通过映射到其中一个真实用户以及设置相应的权限来实现访问验证，虚拟用户不能登录Linux系统，从而让系统更加的安全可靠。

Vsftpd虚拟用户企业案例配置步骤如下：

1.  安装Vsftpd虚拟用户需用到的软件及认证模块：
`yum install pam\* libdb-utils libdb\* --skip-broken -y`

2.  创建虚拟用户临时文件/etc/vsftpd/ftpusers.txt，新建虚拟用户和密码，其中jfedu001、jfedu002为虚拟用户名，123456为密码，如果有多个用户，依次格式填写即可：
```
jfedu001 
123456 
jfedu002 
123456
```

3.  生成Vsftpd虚拟用户数据库认证文件，设置权限700：
```
db_load  -T  -t  hash  -f  /etc/vsftpd/ftpusers.txt  /etc/vsftpd/vsftpd_login.db
chmod  700  /etc/vsftpd/vsftpd_login.db
```

4.  配置PAM认证文件，/etc/pam.d/vsftpd行首加入如下两行：
```
auth      required        pam_userdb.so   db=/etc/vsftpd/vsftpd_login
account   required        pam_userdb.so   db=/etc/vsftpd/vsftpd_login
```

5.  所有Vsftpd虚拟用户需要映射到一个系统用户，该系统用户不需要密码，也不需要登录，主要用于虚拟用户映射使用，创建命令如下：
`useradd -s /sbin/nologin ftpuser`

6.  完整vsftpd.conf配置文件代码如下：
```
#global config Vsftpd 2019
anonymous_enable=YES
local_enable=YES
write_enable=YES
local_umask=022
dirmessage_enable=YES
xferlog_enable=YES
connect_from_port_20=YES
xferlog_std_format=YES
listen=NO
listen_ipv6=YES
userlist_enable=YES
tcp_wrappers=YES
#config virtual user FTP
pam_service_name=vsftpd
guest_enable=YES
guest_username=ftpuser
user_config_dir=/etc/vsftpd/vsftpd_user_conf
virtual_use_local_privs=YES
```

如上Vsftpd虚拟用户配置文件参数详解：
```
#config virtual user FTP
pam_service_name=vsftpd                  虚拟用户启用pam认证；
guest_enable=YES							启用虚拟用户；
guest_username=ftpuser						映射虚拟用户至系统用户ftpuser；
user_config_dir=/etc/vsftpd/vsftpd_user_conf 	设置虚拟用户配置文件所在的目录；
virtual_use_local_privs=YES					虚拟用户使用与本地用户相同的权限。
```

7.  至此，所有虚拟用户共同基于/home/ftpuser主目录实现文件上传与下载，可以在/etc/vsftpd/vsftpd_user_conf目录创建虚拟用户各自的配置文件，创建虚拟用户配置文件主目录:
`mkdir -p /etc/vsftpd/vsftpd_user_conf/`

8.  如下分别为虚拟用户jfedu001、jfedu002用户创建配置文件：
`vim /etc/vsftpd/vsftpd_user_conf/jfedu001`，同时创建私有的虚拟目录，代码如下：

```
local_root=/home/ftpuser/jfedu001
write_enable=YES
anon_world_readable_only=YES
anon_upload_enable=YES
anon_mkdir_write_enable=YES
anon_other_write_enable=YES
```

`vim /etc/vsftpd/vsftpd_user_conf/jfedu002`，同时创建私有的虚拟目录，代码如下：
```
local_root=/home/ftpuser/jfedu002
write_enable=YES
anon_world_readable_only=YES
anon_upload_enable=YES
anon_mkdir_write_enable=YES
anon_other_write_enable=YES
```

虚拟用户配置文件内容详解：

```
local_root=/home/ftpuser/jfedu002		jfedu002虚拟用户配置文件路径；
write_enable=YES						允许登陆用户有写权限；		
anon_world_readable_only=YES			允许匿名用户下载，然后读取文件；
anon_upload_enable=YES				允许匿名用户上传文件权限，只有在write_enable=YES时该参数才生效；
anon_mkdir_write_enable=YES		   允许匿名用户创建目录，只有在write_enable=YES时该参数才生效；
anon_other_write_enable=YES	      允许匿名用户其他权限，例如删除、重命名等。
```

9.  创建虚拟用户各自虚拟目录：
```
mkdir -p /home/ftpuser/{jfedu001,jfedu002} ;
chown -R ftpuser:ftpuser /home/ftpuser
```

重启Vsftpd服务，通过Windows客户端资源管理器登录Vsftpd服务端，测试结果如图8-8（a）、8-8（b）所示：

![图8-8（a） jfedu001虚拟用户登录FTP服务器](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856552.png)

![图8-8（b） jfedu001虚拟用户上传下载文件](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856554.png)

# 第八章 Apache WEB服务器企业实战

万维网 (WORLD WIDE WEB，WWW)服务器，也称之为WEB服务器，主要[功能](http://baike.baidu.com/view/587727.htm)是提供网上[信息](http://baike.baidu.com/view/1527.htm)浏览服务。WWW是 [Internet](http://baike.baidu.com/view/11165.htm)的多媒体信息查询工具，是Internet上飞快发展的服务，也是目前用的最广泛的服务。正是因为有了WWW软件，才使得近年来 Internet 迅速发展。

目前主流的WEB服务器软件包括：Apache、Nginx、Lighttpd、IIS、Resin、Tomcat、WebLogic、Jetty等。

本章向读者介绍Apache WEB服务器发展历史、Apache工作模式深入剖析、Apache虚拟主机、配置文件详解及Apache Rewrite企业实战等。

## Apache WEB服务器入门简介

Apache HTTP [Server](http://baike.baidu.com/view/488131.htm)是[Apache软件基金会](http://baike.baidu.com/view/7044910.htm)的一个开源的网页服务器，是世界使用排名第一的Web[服务器](http://baike.baidu.com/view/899.htm)软件，可以运行在几乎所有广泛使用的[计算机平台](http://baike.baidu.com/view/2269685.htm)上，由于其[跨平台](http://baike.baidu.com/view/469855.htm)和安全性被广泛使用，是目前最流行的Web服务器端软件之一。

Apache服务器是一个多模块化的服务器，经过多次修改，成为目前世界使用排名第一的[Web服务器](http://baike.baidu.com/view/460250.htm)软件。Apache取自“A Patchy Server”的读音，即充满补丁的服务器，因为Apache基于GPL发布，大量开发者不断为Apache贡献新的代码、功能、新的特性、修改原来的缺陷。

Apache服务器的特点是使用简单、速度快、性能稳定，可以做负载均衡及[代理服务器](http://baike.baidu.com/view/751.htm)来使用。

## Prefork MPM工作原理

每辆汽车都有发动机引擎，不同的引擎，对车子运行效率也不一样，同样Apache也有类似工作引擎或者处理请求的模块，亦可称之为多路处理模块（Multi-Processing Modules，MPM），Apache WEB服务器有三种处理模块：Prefork MPM、Worker MPM、Event MPM。

在企业中最常用的处理模块为Prefork MPM和Worker MPM，Event MPM不支持HTTPS方式，官网也给出“This MPM is experimental, so it may or may not work as expected”提示，所以很少被使用。

默认Apache处理模块为Prefork MPM方式，Prefork采用的预派生子进程方式，Prefork用单独的子进程来处理不同的请求，进程之间是彼此独立的，所以比较稳定。

Prefork的工作原理：控制进程Master在最初建立“StartServers”个进程后，为了满足MinSpareServers设置的最小空闲进程，所以需创建第一个空闲进程，等待一秒钟，继续创建两个，再等待一秒钟，继续创建四个，依次按照递增指数级创建进程数，最多每秒同时创建32个空闲进程，直到满足至少有MinSpareServers设置的值为止。

Apache的预派生模式（Prefork），基于预派生模式，不必在请求到来时再产生新的进程，从而减小了系统开销以增加性能，不过由于Prefork MPM引擎是基于多进程方式提供对外服务，每个进程占内存也相对较高。

## Worker MPM工作原理

相对于Prefork MPM,Worker方式是2.0版中全新的支持多线程和多进程混合模型的MPM，由于使用线程来处理，所以可以处理海量的HTTP请求，而系统资源的开销要小于基于Prefork多进程的方式。Worker也是基于多进程，但每个进程又生成多个线程，这样可以保证多线程可以获得进程的稳定性。

Worker MPM工作原理：控制进程Master在最初建立“StartServers”个进程，每个进程会创建ThreadsPerChild设置的线程数，多个线程共享该进程内存空间，同时每个线程独立地处理用户的HTTP请求。为了不在请求到来时再生成线程，Worker MPM也可以设置最大最小空闲线程。

Worker MPM模式下同时处理的请求总数=进程总数xThreadsPerChild，也即等于MaxClients。如果服务器负载很高，当前进程数不满足需求，Master控制进程会fork新的进程，最大进程数不能超过ServerLimit数，如果需调整的StartServers进程数，需同时调整ServerLimit值。

Prefork MPM与Worker MPM引擎区别小结如下：

-   Prefork MPM模式：使用多个进程，每个进程只有一个线程，每个进程在某个确定的时间只能维持一个连接，稳定，内存开销较高；
-   Worker MPM模式：使用多个进程，每个子进程包含多个线程，每个线程在某个确定的时间只能维持一个连接，内存占用量比较小，适合大并发、高流量的WEB服务器。Worker MPM缺点是一个线程崩溃，整个进程就会连同其任何线程一起挂掉。

## Apache WEB服务器安装

从Apache官方分站点下载,文档以 版本 httpd-2.2.32 来进行安装步骤的说明
```
tar  -xjvf  httpd-2.2.32.tar.bz2						
tar工具解压httpd包；
cd httpd-2.2.32/									
进入解压后目录；
yum install apr apr-devel apr-util apr-util-devel -y	        
安装APR相关优化模块；
./configure --prefix=/usr/local/apache2/ --enable-rewrite --enable-so --enable-mpms-shared=all --with-mpm=event
预编译Apache，启用rewrite规则、启用动态加载库、开启Apache三种工作引擎,如果开启模块支持，需要添加配置：
#LoadModule mpm_prefork_module modules/mod_mpm_prefork.so
#LoadModule mpm_event_module modules/mod_mpm_event.so
#LoadModule mpm_worker_module modules/mod_mpm_worker.so
make											
编译
make install									
安装
```

Apache2.2.32安装完毕，如图10-1所示：

![图10-1 Apache2.2.32安装图解](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856557.png)

启动Apache服务，临时关闭selinux、firewalld防火墙：
```
/usr/local/apache2/bin/apachectl start 
setenforce 0 
systemctl stop firewalld.service
```

查看Apache服务进程，通过客户端浏览器访问 `http://192.168.111.131/`，如图10-2（a）、10-2（b）所示：

![图10-2（a） Apache启动及查看进程](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856559.png)

![图10-2（b） 浏览器访问Apache WEB服务器](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856561.png)

## Apache虚拟主机企业应用

企业真实环境中，一台WEB服务器发布单个网站会非常浪费资源，所以一台WEB服务器上会发布多个网站，少则3-5个，多则2-30个网站。
在一台服务器上发布多网站，也称之为部署多个虚拟主机，WEB虚拟主机配置方法有三种：

-   基于单IP多个Socket端口； 
-   基于多IP地址一个端口；
-   基于单IP一个端口不同域名。

其中基于同一端口不同域名的方式在企业中得到广泛的使用和应用，如下为基于一个端口不同域名，在一台Apache WEB服务器上部署多个网站，步骤如下：

1.  创建虚拟主机配置文件httpd-vhosts.conf，该文件默认已存在，只需去掉httpd.conf配置文件中#号即可，如图10-3所示：

![图10-3 httpd.conf配置文件开启虚拟主机](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856564.png)

2.  配置文件/usr/local/apache2/conf/extra/httpd-vhosts.conf中代码设置为如下：
```
NameVirtualHost *:80
<VirtualHost *:80>
    ServerAdmin support@jfedu.net
    DocumentRoot "/usr/local/apache2/htdocs/jf1"
    ServerName www.jf1.com
    ErrorLog "logs/www.jf1.com_error_log"
    CustomLog "logs/www.jf1.com_access_log" common
</VirtualHost>
<VirtualHost *:80>
    ServerAdmin support@jfedu.net
    DocumentRoot "/usr/local/apache2/htdocs/jf2"
    ServerName www.jf2.com
    ErrorLog "logs/www.jf2.com_error_log"
    CustomLog "logs/www.jf2.com_access_log" common
</VirtualHost>

```

Httpd-vhosts.conf参数详解：
```
NameVirtualHost *:80								   开启虚拟主机，并且监听本地所有网卡接口的80端口；
<VirtualHost *:80>									虚拟主机配置起始；
    ServerAdmin support@jfedu.net					管理员邮箱；
    DocumentRoot "/usr/local/apache2/htdocs/jf1"	    该虚拟主机发布目录；
    ServerName www.jf1.com							虚拟主机完整域名；
    ErrorLog "logs/www.jf1.com_error_log"			    错误日志路径及文件名；
    CustomLog "logs/www.jf1.com_access_log" common	访问日志路径及文件名；
</VirtualHost>										虚拟主机配置结束。

```

3.  创建 `www.jf1.com` 及 `www.jf2.com` 发布目录，重启apache服务，并分别创建index.html页面：
```
mkdir  -p  /usr/local/apache2/htdocs/{jf1,jf2}/
/usr/local/apache2/bin/apachectl restart
echo  "<h1> www.jf1.com  Pages</h1>" >/usr/local/apache2/htdocs/jf1/index.html
echo  "<h1> www.jf2.com  Pages</h1>" >/usr/local/apache2/htdocs/jf2/index.html
```

4.  Windows客户端设置Hosts映射，将`www.jf1.com`、`www.jf2.com`与 192.168.111.131进行映射绑定，映射的目的将域名跟IP进行绑定，在浏览器可以输入域名，不需要输入IP地址，绑定方法是在“C:\\Windows\\System32\\drivers\\etc”文件夹中，使用记事本编辑hosts文件，加入如下代码，如图10-4所示：
```
192.168.111.131 www.jf1.com 
193.192.168.111.131 www.jf2.com
```

![图10-4 Windows主机Hosts配置](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856649.png)

5.  浏览器访问 `www.jf1.com`、`www.jf2.com`如图10-5（a）、10-5（b）所示，至此Apache基于多域名虚拟主机配置完毕，如果还需添加虚拟主机，直接拷贝其中一个虚拟主机配置、修改WEB发布目录即可：

![图10-5（a）](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856657.png)

![图10-5（b）](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856654.png)
 
## Apache常用目录学习

Apache可以基于源码安装、YUM安装，不同的安装方法，所属的路径特不同，如下为Apache常用路径的功能用途：

```
/usr/lib64/httpd/modules/				Apache模块存放路径；
/var/www/html/						YUM安装Apache网站发布目录；
/var/www/error/						服务器设置错误信息，浏览器显示；
var/www/icons/						Apache小图标文件存放目录；
var/www/cgi-bin/						可执行的CGI程序存放目录。
/var/log/httpd/							Apache日志目录；
/usr/sbin/apachectl						Apache启动脚本；
/usr/sbin/httpd							Apache二进制执行文件；
/usr/bin/htpasswd						设置Apache目录密码访问；
/usr/local/apache2/bin					Apache命令目录；
/usr/local/apache2/build				    Apache构建编译目录；
/usr/local/apache2/htdocs/				源码安装Apache网站发布目录；
/usr/local/apache2/cgi-bin				可执行的CGI程序存放目录；
/usr/local/apache2/include				Apache引用配置文件目录；
/usr/local/apache2/logs					Apache日志目录；
/usr/local/apache2/man					Apache帮助文档目录；
/usr/local/apache2/manual				Apache手册；
/usr/local/apache2/modules				Apache模块路径。
```


## Apache配置文件详解

Apache的配置文件是Apache
WEB难点，读者需要掌握配置文件中每个参数的含义，才能理解并在日常运维中去解决Apache遇到的故障，如下为Apache配置文件详解：

```
ServerTokens OS 					    显示服务器的版本和操作系统内核版本；
ServerRoot  "/usr/local/apache2/" 	    Apache主配置目录；
PidFile run/httpd.pid				    PidFile进程文件；
Timeout 60							不论接收或发送，当持续连接等待超过60秒则该次连接就中断；
KeepAlive Off						    关闭持续性的连接；
MaxKeepAliveRequests 100			    当KeepAlive设置为On的时候，该数值可以决定此次连接能够传输的最大传输数量；
KeepAliveTimeout 65					当KeepAlive设置为On的时候，该连接在最后一次传输后等待延迟的秒数；
<IfModule prefork.c>				    Prefork MPM引擎配置段；
StartServers      8					默认启动Apache工作进程数；
MinSpareServers   5					最小空闲进程数；
MaxSpareServers   20				    最大空闲进程数；
ServerLimit      4096				    Apache服务器最多进程数；
MaxClients      4096				    每秒支持的最大客户端并发；
MaxRequestsPerChild  4000			    每个进程能处理的最大请求数；
</IfModule>
<IfModule worker.c>					Worker MPM引擎配置段；
StartServers        8				    默认启动Apache工作进程数；
MaxClients         4000				每秒支持的最大客户端并发；
MinSpareThreads     25				最小空闲线程数；
MaxSpareThreads     75 				最小空闲线程数；
ThreadsPerChild     75				每个进程启动的线程数；
MaxRequestsPerChild  0				每个进程能处理的最大请求数，0表示无限制；
</IfModule>
LoadModule  mod_version.so  		    静态加载apache相关模块；
ServerAdmin support@jfedu.net		    管理员邮箱，网站异常，错误信息会发生至该邮箱；
DocumentRoot   "/usr/local/apache2/htdocs/"  Apache网站默认发布目录；
<Directory "/data/webapps/www1">	    设置/data/webapps/www1目录权限；
    AllowOverride All
    Options -Indexes FollowSymLinks
    Order allow,deny
    Allow from all
</Directory>
AllowOverride 						设置为None时，目录中.htaccess 文件将被完全忽略，当指令设置为All时，.htaccess文件生效；
Options -Indexes FollowSymLinks		禁止浏览目录，去掉”-“,表示浏览目录，常用于下载站点；
Order 	allow,deny 					默认情况下禁止所有客户机访问；
Order   deny,allow 					默认情况下允许所有客户机访问；
Allow   from all					    允许所有客户机访问。
```

# 第九章 LAMP架构企业实战

Linux下LAMP（Linux+Apache+MySQL/MariaDB+Perl/PHP/Python）是一组用来搭建[动态网站](http://baike.baidu.com/view/863075.htm)的[开源软件](http://baike.baidu.com/view/444964.htm)架构，本身是各自独立的软件服务，放在一起使用，拥有了越来越高的兼容度，共同组成了一个强大的Web[应用程序](http://baike.baidu.com/view/330120.htm)平台。

本章向读者介绍互联网主流企业架构LAMP应用案例、PHP解释性语言详解、LAMP组合通信原理、LAMP企业源码架设、LAMP拓展及使用Redis提升LAMP性能优化等。

## LAMP企业架构简介

随着开源潮流的蓬勃发展，开放源[代码](http://baike.baidu.com/view/41.htm)的LAMP已经与[J2EE](http://baike.baidu.com/view/1507.htm)和[.Net](http://baike.baidu.com/view/4294.htm)[商业软件](http://baike.baidu.com/view/194971.htm)形成三足鼎立之势，并且该软件开发的项目在软件方面的投资成本较低，因此受到整个[IT](http://baike.baidu.com/view/30.htm)界的关注。LAMP架构受到大多数中小企业的运维、DBA、程序员的青睐，Apache默认只能发布静态网页，而LAMP组合可以发布静态+PHP动态页面。

静态页面通常指不与数据库发生交互的页面，是一种基于w3c规范的一种网页书写格式，是一种统一协议语言，所以称之为静态网页。静态页面被设计好之后，一般很少去修改，不随着浏览器参数改变而内容改变，需注意的是动态的图片也是属于静态文件。从SEO角度来讲，HTML页面更有利于搜索引擎的爬行和收录。常见的静态页面以.html、.gif、.jpg、.jpeg、.bmp、.png、.ico、.txt、.js、.css等结尾。

动态页面通常指与数据库发生交互的页面，内容展示丰富，功能非常强大，实用性广。从SEO角度来讲，搜索引擎很难全面的爬行和收录动态网页，因为动态网页会随着数据库的更新、参数的变更而发生改变，常见的动态页面以.jsp、.php、.do、.asp、.cgi、.apsx等结尾。

## Apache与PHP工作原理

LAMP企业主流架构最重要的三个环节，一是Apache WEB服务器，二是PHP（PHP: Hypertext Preprocessor），三是MYSQL数据库。

Apache WEB服务器主要是基于多模块工作，依赖PHP SAPI处理方式中的PHP_MODULE去解析PHP结尾的文件，如图12-1所示：

![](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856783.png)

![图12-1 Apache+PHP mod工作原理](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856787.png)

PHP是一种适用于web开发的动态语言，PHP语言内核基于C语言实现包含大量组件的软件框架，是一种功能强大的解释型脚本语言。PHP底层运行机制如图12-2所示：

![图12-2 PHP底层处理机制](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856781.png)

PHP底层工作原理包括4个部分：

-   Zend引擎，属于PHP内核部分，它负责将PHP代码解析为可执行opcode的处理并实现相应的处理方法、实现基本的数据结构、内存分配及管理、提供了相应的api方法供外部调用，是一切的核心，所有的外围功能均围绕Zend实现。

-   Extensions，围绕着Zend引擎，Extensions通过组件的方式提供各种基础服务，各种内置函数、标准库等都是通过Extension来实现。

-   Sapi，服务端应用编程接口（Server Application Programming Interface，Sapi），sapi通过一系列钩子函数，基于SAPI可以让PHP与外部进行数据交互。

-   常见的SAPI编程接口处理方法包括：apache2handler：以apache作为webserver，采用MOD_PHP模式运行时候的处理方式；cgi：webserver和PHP直接的另一种交互方式，FastCGI协议；cli：命令行调用的应用模式。

-   APP代码应用，又称之为PHP代码程序，基于sapi接口生成不同的应用模式，从而被PHP引擎解析。

当用户在浏览器地址中输入域名或者域名+PHP页面，向HTTP WEB服务器Apache发起HTTP请求，WEB服务器接受该请求，并根据其后缀判断如果请求的页面是以.php结尾，WEB服务器从硬盘或者内存中取出该PHP文件，将其发送给PHP引擎程序。

PHP引擎程序将会对WEB服务器传送过来的文件进行扫描并根据命令从后台读取、处理数据、并动态地生成相应的HTML页面。然后PHP引擎程序将生成的HTML页面返回给WEB服务器，最终WEB服务器将HTML页面返回给客户端浏览器，浏览器基于MIME类型进行解析展示给用户页面。

## LAMP企业安装配置

构建LAMP架构有两种方法，一是使用YUM在线安装，另外一种是基于LAMP源码编译安装，YUM在线安装方法如下：
```
yum  install  httpd  httpd-devel  mysql mysql-server mysql-devel  php php-devel php-mysql  -y
service httpd restart
service mysqld restart
```

YUM方式安装简单、快捷，但如果需要添加扩展的功能和模块，需使用源码包的方式来编译安装LAMP。如下为LAMP源码编译安装的步骤：

1.  Apache WEB安装，先安装apr、apr-utils库包。
```
yum install apr-devel apr-util-devel -y；
cd  /usr/src ； 
wget http://mirror.bit.edu.cn/apache/httpd/httpd-2.2.31.tar.gz 
tar  xzf  httpd-2.2.31.tar.gz
cd httpd-2.2.31 
./configure --prefix=/usr/local/apache --enable-so --enable-rewrite
make 
make install
```

2.  MYSQL数据库安装，基于MYSQL5.5编译安装，通过cmake、make、make
    install三个步骤实现。

```
wget http://down1.chinaunix.net/distfiles/mysql-5.5.20.tar.gz 
yum  install  cmake  make  ncurses-devel ncurses -y
cmake  . -DCMAKE_INSTALL_PREFIX=/usr/local/mysql55 \
-DMYSQL_UNIX_ADDR=/tmp/mysql.sock \
-DMYSQL_DATADIR=/data/mysql \
-DSYSCONFDIR=/etc \
-DMYSQL_USER=mysql \
-DMYSQL_TCP_PORT=3306 \
-DWITH_XTRADB_STORAGE_ENGINE=1 \
-DWITH_INNOBASE_STORAGE_ENGINE=1 \
-DWITH_PARTITION_STORAGE_ENGINE=1 \
-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \
-DWITH_MYISAM_STORAGE_ENGINE=1 \
-DWITH_READLINE=1 \
-DENABLED_LOCAL_INFILE=1 \
-DWITH_EXTRA_CHARSETS=1 \
-DDEFAULT_CHARSET=utf8 \
-DDEFAULT_COLLATION=utf8_general_ci \
-DEXTRA_CHARSETS=all \
-DWITH_BIG_TABLES=1 \
-DWITH_DEBUG=0
make
make install
```

将源码安装的Mysql数据库服务设置为系统服务，可以使用chkconfig管理，并启动MYSQL数据库：

```
cd /usr/local/mysql55/ 
\cp support-files/my-large.cnf /etc/my.cnf
\cp support-files/mysql.server /etc/init.d/mysqld 
chkconfig --add mysqld 
chkconfig --level 35 mysqld on
mkdir  -p  /data/mysql
useradd  mysql
/usr/local/mysql55/scripts/mysql_install_db --user=mysql --datadir=/data/mysql/ --basedir=/usr/local/mysql55/
ln  -s  /usr/local/mysql55/bin/* /usr/bin/
service  mysqld  restart

```

3.  PHP服务安装，PHP需与Apache、MySQL进行整合，如图12-3所示，参数命令如下：
```
cd /usr/src 
wget http://mirrors.sohu.com/php/php-5.3.28.tar.bz2 
tar jxf  php-5.3.28.tar.bz2 
cd php-5.3.28 ；
./configure --prefix=/usr/local/php5 --with-config-file-path=/usr/local/php5/etc   --with-apxs2=/usr/local/apache2/bin/apxs  --with-mysql=/usr/local/mysql55/
make
make  install
```

![图12-3 LAMP源码编译整合](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856662.png)

4.  Apache+PHP源码整合

为了能让Apache发布PHP页面，需要将PHP安装完成后的libphp5.so模块与Apache进行整合，vim httpd.conf编辑配置文件，加入如下代码：

```
LoadModule         php5_module modules/libphp5.so
AddType         application/x-httpd-php  .php
DirectoryIndex     index.php index.html index.htm
```

5.  测试Apache+PHP环境

创建PHP测试页面，在/usr/local/apache/htdocs目录下创建index.php测试页面，执行如下命令自动创建：

```
cat >/usr/local/apache/htdocs/index.php<<EOF 
<?php
phpinfo()；
?>
EOF
```

重新启动Apache服务，浏览器输入 Apache WEB的IP访问，如图12-4所示，即代表LAMP源码环境整合成功。

![图12-4 Apache+PHP测试页面](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856792.png)

6.  Discuz PHP论坛安装

LAMP源码整合完毕之后，Dicuz官网下载Discuz开源PHP软件包，将软件包解压并发布在Apache Htdocs发布目录，代码如下：
```
cd     /usr/src ；
wget  http://download.comsenz.com/DiscuzX/3.1/Discuz_X3.1_SC_UTF8.zip 
unzip  Discuz_X3.1_SC_UTF8.zip -d  /usr/local/apache/htdocs/ 
cd    /usr/local/apache/htdocs/;\mv upload/* .
chmod 757  -R  data/ uc_server/ config/ uc_client/
```

通过浏览器访问Apache WEB IP，如图12-5所示，选择“我同意”

![图12-5 Discuz安装界面一](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856794.png)

进入如图12-6界面，数据库安装，如果不存在则需要新建数据库并授权。

![图12-6 Discuz安装界面二](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856796.png)

MYSQL数据库命令行中创建PHP连接MYSQL的用户及密码，命令如下：
```
create database discuz charset=utf8;
grant all on discuz.* to root@'localhost' identified by "123456";
```

单击下一步，直至安装完成，浏览器自动跳转至如图12-7所示界面：

![图12-7 Discuz安装界面三](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856798.png)

## LAMP企业架构拓展实战

如上LAMP服务均安装至单台服务器，随着用户访问量不断的增加，单台服务器压力逐渐增加，那如何优化LAMP架构，如何拆分LAMP架构呢，怎么把Apache和MySQL分开放在不同的机器呢。

LAMP架构拆分的目的在于缓解单台服务器的压力，可以将PHP、MYSQL单独安装至多台服务器，本节将实现LAP+MySQL的架构，也即是把MYSQL单独拆分出去。部署方法有两种：

1.  YUM安装LAMP多机方案

在Apache WEB服务器只需只需如下代码：
`yum install httpd httpd-devel php-devel php php-mysql -y`

在MYSQL数据库服务器只需只需如下代码：
`yum install mysql-server mysql mysql-devel mysql-libs -y`

2.  源码安装LAMP多机方案

源码安装LAMP多机方式，Apache WEB服务与MYSQL数据库服务分别部署在不同的服务器即可，PHP与Apache服务部署在一台服务器，PHP编译参数时加入如下代码进行LAMP的整合，mysqlnd为PHP远程连接MYSQL数据库服务器的一种方式：
```
./configure --prefix=/usr/local/php5  \
--with-mysql=mysqlnd   --with-mysqli=mysqlnd   --with-pdo-mysql=mysqlnd  \
--with-apxs2=/usr/local/apache2/bin/apxs 
make 
make  install 
```

## LAMP+Redis企业实战

LAMP在企业生产环境中，除了将MYSQL单独部署在其他服务器、由于MYSQL数据库压力会很大，还会对MYSQL实现主从复制及读写分离，同时会对PHP网站进行调优，通常PHP的优化手段包括：PHP代码本身优化、PHP配置文件优化、为PHP添加缓存模块，将PHP网站数据存入缓存等。

### LAMP+Redis工作机制

LAMP+Redis工作机制：用户通过浏览器访问LAMP网站，并以用户名和密码登录到网站，默认Redis缓存中没有该用户名和密码对应列表，PHP程序会读取MYSQL数据库中的用户名和密码，然后将用户名和密码缓存至Redis中，下次用户通过浏览器再次使用同样的用户名和密码登录网站，PHP无需从数据库中读取该用户和密码信息，而是直接优先从Redis缓存中读取并返回，从而减轻MYSQL数据库的压力。

Redis除了可以缓存用户名、密码，还可以换成PHP论坛各种数据，例如用户帖子、用户动态等等，如图12-8所示：

![图12-8 LAMP+Redis架构流程图](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052856807.jpg)

要实现将LAMP PHP网站相关数据存入Redis，需要一台Redis服务器、PHP-redis连接驱动、PHP代码连接修改等。

### LAMP+Redis操作案例

LAMP PHP连接Redis，首先需安装Redis服务器，安装连接驱动，然后修改PHP网站配置文件，具体操作步骤如下：

1.  LAMP+Redis实战环境配置
```
LAMP服务器： 192.168.149.128 
Redis主库： 192.168.149.129 
Redis从库： 192.168.149.130
```

2.  192.168.149.129服务器安装部署Redis服务，代码如下
```
wget  	http://download.redis.io/releases/redis-2.8.13.tar.gz 
tar 	    zxf 			redis-2.8.13.tar.gz
cd 		redis-2.8.13
make  	PREFIX=/usr/local/redis  install
cp     	redis.conf     /usr/local/redis/
```

将/usr/local/redis/bin/目录加入至环境变量配置文件/etc/profile末尾，然后Shell终端执行source /etc/profile让环境变量生效。
`export PATH=/usr/local/redis/bin:\$PATH`

Nohup后台启动及停止Redis服务命令：
`nohup /usr/local/redis/bin/redis-server /usr/local/redis/redis.conf & /usr/local/redis/bin/redis-cli -p 6379 shutdown`

3.  安装PHP-Redis连接驱动
要确保PHP能够连接Redis缓存服务器，需添加PHP Redis扩展程序，也即是添加PHP安ext扩展模块，添加方法如下:
```
wget  https://github.com/phpredis/phpredis/archive/3.1.2.tar.gz 
tar   xzf  3.1.2.tar.gz
/usr/local/php5/bin/phpize
cd   phpredis-3.1.2/
./configure  --with-php-config=/usr/local/php5/bin/php-config  --enable-redis
make
make install
```

修改vim /usr/local/php5/lib/php.ini配置文件，添加redis.so模块，代码如下：
```
extension_dir = "/usr/local/php5/lib/php/extensions/no-debug-zts-20090626" 
extension=redis.so
```

重启Apache服务，写入phpinfo测试页面，通过浏览器访问，如图12-9所示，检查到存在Redis模块即可：

![图12-9 PHP Redis模块添加](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/Linux入门到精通企业实战/2020810/1597052857052.png)

4.  LAMP+Redis缓存测试

登录192.168.149.128 WEB服务器，修改Discuz PHP网站发布/usr/local/apache2/htdcos目录全局配置文件config_global.php，查找CONFIG MEMORY段，将redis server后改为Redis主服务器的IP 192.168.149.129即可，如图12-10所示：

![图12-10 PHP Redis配置文件修改](http://qiniu.imolili.com/小书匠/1594260794666.png)

通过浏览器访问Apache PHP论坛网站，同时登陆Redis服务器，执行命令redis-cli进入Redis命令行，运行命令KEYS \*，如图12-11所示，存在以IOKLAN开头的key，则证明Redis成功缓存LAMP+Discuz网站信息数据。

![图12-11 Redis缓存LAMP KEYS数据](http://qiniu.imolili.com/小书匠/1594260794669.png)

5.  测试Redis缓存是否生效

访问LAMP+Discuz网站，创建论坛测试用户jfedu666，密码jfedu666，此时用户数据第一次注册，用户名和密码会写入到MySQL数据库表中，同时会写入该数据也会写入到Redis缓存，如图12-12（a）、12-12（b）、12-12（c）所示：

![图12-12（a） 创建论坛用户和密码](http://qiniu.imolili.com/小书匠/1594260794672.png)

![图12-12（b） MySQL数据库用户查询](http://qiniu.imolili.com/小书匠/1594260794679.png)

![图12-12（c） Redis缓存测试案例](http://qiniu.imolili.com/小书匠/1594260794683.png)

将jfedu666从MySQL Discuz库pre_common_member中删除，通过该用户依然可以正常登录WEB网站，则证明此时数据读取的是Redis缓存服务器，如图12-13（a）、12-13（b）、12-13（c）所示：

![图12-13（a） 删除数据库用户和密码](http://qiniu.imolili.com/小书匠/1594260794686.png)

![图12-13（b） 用户名和密码登录discuz论坛](http://qiniu.imolili.com/小书匠/1594260794690.png)

![图12-13（c） 用户名和密码登录discuz论坛](http://qiniu.imolili.com/小书匠/1594260794693.png)

## LAMP企业架构读写分离

LAMP+Discuz+Redis缓解了MYSQL的部分压力，但是如果访问量非常大，Redis缓存中第一次没有缓存数据，会导致MYSQL数据库压力增大，此时可以基于分库、分表、分布式集群、或者读写分离来分担MYSQL数据库的压力，以读写分离为案例，来实现分担MYSQL数据库的压力。

MYSQL读写分离的原理其实就是让Master数据库处理事务性增、删除、修改、更新操作（CREATE、INSERT、UPDATE、DELETE），而让Slave数据库处理SELECT操作，MYSQL读写分离前提是基于MYSQL主从复制，这样可以保证在Master上修改数据，Slave同步之后，WEB应用可以读取到Slave端的数据。

实现MYSQL读写分离可以基于第三方插件，也可以通过开发修改代码实现，具体实现的读写分离的常见方式有如下四种：

-   MySQL-Proxy读写分离；
-   Amoeba读写分离；
-   Mycat读写分离；
-   基于程序读写分离(效率很高，实施难度大，开发改代码)

Amoeba是以MySQL为底层数据存储，并对WEB、APP应用提供MySQL协议接口的proxy。它集中地响应WEB应用的请求，依据用户事先设置的规则，将SQL请求发送到特定的数据库上执行，基于此可以实现负载均衡、[读写分离](http://baike.baidu.com/view/3372624.htm)、高可用性等需求。

Amoeba相当于一个SQL请求的[路由器](http://baike.baidu.com/view/1360.htm)，目的是为负载均衡、读写分离、高可用性提供机制，而不是完全实现它们。用户需要结合使用MySQL的Replication等机制来实现副本同步等功能。 

Mysql-Proxy是MySQL官方提供的mysql中间件服务，支持无数客户端连接，同时后端可连接若干台Mysql-Server服务器，MYSQL-Proxy自身基于MySQL协议，连接MYSQL-Proxy的客户端无需修改任何设置，跟正常连接MYSQL Server没有区别，无需修改程序代码。

MySQL Proxy是App应用（客户端）与MYSQL Server之间的一个连接代理，MySQL Proxy负责将APP应用的SQL请求根据转发规则，转发至相应的后端数据库，基于lua脚本，可以实现复杂的连接控制和过滤，从而实现数据读写分离和负载均衡的需求。

Mysql-Proxy允许用户指定Lua脚本对SQL请求进行拦截，对请求进行分析与修改，还允许用户指定Lua脚本对服务器的返回结果进行修改，加入一些结果集或者去除一些结果集，对SQL的请求通常为读请求、写请求，基于Lua脚本，可以实现将SQL读请求转发至后端Slave服务器，将SQL写请求转发至后端Master服务器。

如图12-16所示，为MYSQL-PROXY读写分离架构图，通过架构图可以清晰看到SQL请求整个流向的过程。

![图12-16 MYSQL-Proxy读写分离流程](http://qiniu.imolili.com/小书匠/1594199450287.jpg)

Mysql-Proxy读写分离架构实战配置，如图12-17所示，两台WEB通过MYSQL-Proxy连接后端1.14和1.15 的MYSQL服务器。

![图12-17 MYSQL-Proxy实施架构图](http://qiniu.imolili.com/小书匠/1594260794704.png)

构建Mysql读写分离架构首先需要将两台MYSQL服务器配置为主从复制（前文已存在，此处省略配置），配置完毕后，在192.168.1.16服务器上安装Mysql-Proxy服务即可，配置步骤如下：

1.  下载MYSQL-Proxy软件版本，解压并重命名至/usr/local/mysql-proxy，命令如下：
```
wget http://ftp.ntu.edu.tw/pub/MySQL/Downloads/MySQL-Proxy/mysql-proxy-0.8.4-linux-el6-x86-64bit.tar.gz  
useradd  -r  mysql-proxy
tar  zxvf  mysql-proxy-0.8.4-linux-el6-x86-64bit.tar.gz  -C  /usr/local
mv  /usr/local/mysql-proxy-0.8.4-linux-el6-x86-64bit  /usr/local/mysql-proxy
```

2.  环境变量配置文件/etc/profile中加入如下代码保存退出，然后执行source   /etc/profile使环境变量配置生效即可：
`export PATH=\$PATH:/usr/local/mysql-proxy/bin/`

3.  启动MYSQL-Proxy中间件，命令如下：
```
mysql-proxy --daemon --log-level=debug --user=mysql-proxy --keepalive --log-file=/var/log/mysql-proxy.log --plugins="proxy" --proxy-backend-addresses="192.168.1.162:3306" --proxy-read-only-backend-addresses="192.168.1.163:3306" --proxy-lua-script="/usr/local/mysql-proxy/share/doc/mysql-proxy/rw-splitting.lua" --plugins=admin --admin-username="admin" --admin-password="admin" --admin-lua-script="/usr/local/mysql-proxy/lib/mysql-proxy/lua/admin.lua"
```

4.  Mysql-Proxy的相关参数详解如下：
```
--help-all   				         ：获取全部帮助信息；
--proxy-address=host:port 	         ：代理服务监听的地址和端口，默认为4040；
--admin-address=host:port  	         ：管理模块监听的地址和端口，默认为4041；
--proxy-backend-addresses=host:port   ：后端mysql服务器的地址和端口；
--proxy-read-only-backend-addresses=host:port ：后端只读mysql服务器的地址和端口；
--proxy-lua-script=file_name          ：完成mysql代理功能的Lua脚本；
--daemon  						 ：以守护进程模式启动mysql-proxy；
--keepalive 					 	 ：在mysql-proxy崩溃时尝试重启之；
--log-file=/path/to/log_file_name 	     ：日志文件名称；
--log-level=level 					 ：日志级别；
--log-use-syslog 					 ：基于syslog记录日志；
--plugins=plugin					 ：在mysql-proxy启动时加载的插件；
--user=user_name  				 ：运行mysql-proxy进程的用户；
--defaults-file=/path/to/conf_file_name ：默认使用的配置文件路径，其配置段使用[mysql-proxy]标识；
--proxy-skip-profiling 				 ：禁用profile；
--pid-file=/path/to/pid_file_name 	     ：进程文件名；
```

5.  MYSQL-Proxy启动后，在服务器端查看端口，其中4040为proxy代理端口用于WEB应用连接，4041位管理端口用于SA或者DBA管理，如图12-48所示：

![图12-48 MYSQL-Proxy启动端口](http://qiniu.imolili.com/小书匠/1594260794741.png)

6.  基于4041端口MySQL-Proxy查看读写分离状态，登录4041管理端口，命令如下：
`mysql -h192.168.1.16 -uadmin -p -P 4041`

7.  以4041管理口登录，然后执行select命令，如图12-18所示state均为up状态，type类型为rw、ro，则证明读写分离状态成功。如果状态为unknown未知状态，可以4040端口登录执行：show databases；命令，直到state变成up状态为止。
`select * from backends;`

![图12-18 MYSQL-Proxy读写分离状态](http://qiniu.imolili.com/小书匠/1594260794752.png)

8.  读写分离数据测试，以3306端口登录到从库，进行数据写入和测试，在丛库上创建jfedu_test测试库，并写入内容，如图12-19所示：

![图12-19 MYSQL-Proxy读写分离测试](http://qiniu.imolili.com/小书匠/1594260794754.png)

9.  读写分离数据测试，以4040代理端口登录，执行如下命令，可以查看到数据即证明读写分离成功。
`mysql -h 192.168.1.16 -uroot -p 123456 -P 4040 -e "select * from jfedu_test.t1；"`

10.  登录Apache WEB服务器，修改Discuz     PHP网站发布/usr/local/apache2/htdcos目录全局配置文件config_global.php，查找dbhost段，将192.168.1.16     改成192.168.1.16:40404，如图12-20所示：

![图12-20 MYSQL-Proxy读写分离测试](http://qiniu.imolili.com/小书匠/1594260794794.png)

# 第十章 CentOS7实战Kickstart批量系统部署

## Kickstart使用背景介绍

随着公司业务不断增加，经常需要采购新服务器，并要求安装Linux系统，并且要求Linux版本要一致，方便以后的维护和管理，每次人工安装linux系统会浪费掉更多时间，如果我们有办法能节省一次一次的时间岂不更好呢？

大中型互联网公司一次采购服务器上百台,如果采用人工手动一台一台的安装,一个人得搞坏N张光盘,得多少个加班加点才能完成这项”艰巨”的任务呢,我们可以看到全人工来完成这样的工作太浪费人力了,有没有自动化安装平台呢,通过一台已存在的系统然后克隆或者复制到新的服务器呢。Kickstart可以毫不费力的完成这项工作。

PXE(preboot execute environment，预启动执行环境)是由[Intel公司](http://baike.baidu.com/view/8364.htm)开发的最新技术，工作于Client/Server的网络模式，支持[工作站](http://baike.baidu.com/view/7977.htm)通过网络从远端服务器下载映像，并由此支持通过网络启动[操作系统](http://baike.baidu.com/view/880.htm)，在启动过程中，终端要求服务器分配[IP](http://baike.baidu.com/view/8370.htm)地址，再用[TFTP](http://baike.baidu.com/view/23881.htm)（trivial file transfer protocol）协议下载一个启动[软件](http://baike.baidu.com/view/37.htm)包到本机内存中执行。

要使用Kickstart安装平台，包括的完整架构为：Kickstart+DHCP+NFS(HTTP)+TFTP+PXE，从架构可以看出，大致需要安装的服务，例如dhcp、tftp、httpd、kickstart/pxe等。

## Kickstart企业实战配置

基于YUM安装DHCP、TFTP、HTTPD服务，指令如下：
`yum install  httpd httpd-devel tftp-server xinetd dhcp* -y`

配置tftp服务，开启tftp服务；
```
cat>/etc/xinetd.d/tftp<<EOF
service tftp
{
disable = no
socket_type = dgram
protocol = udp
wait = yes
user = root
server = /usr/sbin/in.tftpd
server_args = -u nobody -s /tftpboot
per_source = 11
cps = 100 2
flags = IPv4
}
EOF
```

只需要把disable = yes改成disable = no即可，基于sed命令也可以实现：
`sed -i ‘/disable/s/yes/no/g’/etc/xinetd.d/tftp`

## TFTP+PXE配置

要实现远程安装系统，需要在TFTPBOOT目录指定相关PXE内核模块及相关参数，配置步骤如下：

#挂载本地光盘
`mount     /dev/cdrom    /mnt`

#安装syslinux必备文件
`yum install syslinux syslinux-devel -y`

#软链接至/根系统下；
```
ln -s  /var/lib/tftpboot  /
mkdir -p /var/lib/tftpboot/pxelinux.cfg/
\cp /mnt/isolinux/isolinux.cfg /var/lib/tftpboot/pxelinux.cfg/default
\cp /usr/share/syslinux/vesamenu.c32 /var/lib/tftpboot/
\cp /mnt/images/pxeboot/vmlinuz /var/lib/tftpboot/
\cp /mnt/images/pxeboot/initrd.img /var/lib/tftpboot/
\cp /usr/share/syslinux/pxelinux.0 /var/lib/tftpboot/
chmod 644 /var/lib/tftpboot/pxelinux.cfg/default
```

## 配置TFTPBOOT引导案例

```
cat>/tftpboot/pxelinux.cfg/default<<EOF
default vesamenu.c32
timeout 10
display boot.msg
menu clear
menu background splash.png
menu title CentOS Linux 7
label linux
  menu label ^Install CentOS Linux 7
  menu default
  kernel vmlinuz
  append initrd=initrd.img inst.repo=http://192.168.0.131/centos7 quiet ks=http://192.168.0.131/ks.cfg
label check
  menu label Test this ^media & install CentOS Linux 7
  kernel vmlinuz
  append initrd=initrd.img inst.stage2=hd:LABEL=CentOS\x207\x20x86_64 rd.live.check quiet
EOF
```

配置文件详解：

- 192.168.0.131是kickstart服务器 
- /centos7是HTTPD共享linux镜像的目录，即linux存放安装文件的路径：
- ks.cfg是kickstart主配置文件;
- 设置timeout 10 /\*超时时间为10S \*/;
- ksdevice=ens33代表当我们有多块网卡的时候，要实现自动化需要设置从ens33安装。
- TFTP配置完毕，由于是TFTP是非独立服务，需要依赖xinetd服务来启动，启动命令为：
`chkconfig    tftp  --level 35 on  && service  xinetd  restart `

## HTTPD+KICKSTART配置 

远程系统安装，客户端需要下载系统所需的软件包，所以需要使用NFS或者httpd把镜像文件共享出来。
```
mkdir -p /var/www/html/centos7/
mount /dev/cdrom /var/www/html/centos7/
#cp /dev/cdrom/\* /var/www/html/centos7/ （可选配置）
```

配置kickstart，可以使用system-kickstart系统软件包来配置，ks.cfg配置文件内容如下：
```
cat>/var/www/html/ks.cfg<<EOF
install
text
keyboard 'us'
rootpw www.jfedu.net
timezone Asia/Shanghai 
url --url=http://192.168.0.131/centos7
reboot
lang zh_CN 
firewall --disabled 
network  --bootproto=dhcp --device=ens33
auth  --useshadow  --passalgo=sha512
firstboot --disable
selinux   disabled 
bootloader --location=mbr
clearpart --all --initlabel
part /boot --fstype="ext4" --size=300
part / --fstype="ext4" --grow
part swap --fstype="swap" --size=512
%packages
@base
@core
%end
EOF
```

## DHCP服务配置演练

DHCP服务配置文件代码如下：
```
cat>/etc/dhcp/dhcpd.conf<<EOF
ddns-update-style interim;
ignore client-updates;
next-server 192.168.0.131;
filename "pxelinux.0";
allow booting;
allow bootp;
subnet 192.168.0.0 netmask 255.255.255.0 {
#default gateway
option routers          192.168.0.1;
option subnet-mask      255.255.255.0;
range dynamic-bootp 192.168.0.180 192.168.0.200;
host ns {
hardware ethernet  00:1a:a0:2b:38:81;
fixed-address 192.168.0.101;}
}
EOF
```

重启各个服务，启动新的客户端验证测试：
```
service httpd restart
service dhcpd restart
service xinetd restart
```

![](http://qiniu.imolili.com/小书匠/1594260794797.png)

## 开启新虚拟机，BIOS以网卡启动

![](http://qiniu.imolili.com/小书匠/1594260794800.png)

![](http://qiniu.imolili.com/小书匠/1594260794881.png)

![](http://qiniu.imolili.com/小书匠/1594260794885.png)

如果安装时报错如下：

![](http://qiniu.imolili.com/小书匠/1594260794888.png)

需要调整客户端虚拟机的内存设置为2G+；

![](http://qiniu.imolili.com/小书匠/1594260794892.png)

## Kickstart企业生产环境扩展

在真实环境中，通常我们会发现一台服务器好几块硬盘，做完raid，整个硬盘有等10T，如果来使用kickstart自动安装并分区呢；一般服务器硬盘超过2T，如何来使用kickstart安装配置呢？这里就不能使用MBR方式来分区，需要采用GPT格式来引导并分区。需要在ks.cfg末尾添加如下命令来实现需求：
```
%pre  
parted -s /dev/sdb mklabel gpt  
%end
```
为了实现kickstart安装完系统后，自动初始化系统等等工作，我们可以在系统安装完后，自动执行定制的脚本，需要在ks.cfg末尾加入如下配置：
```
%post
mount -t nfs 192.168.0.79:/centos/init /mnt
cd /mnt/ ;/bin/sh auto_init.sh
%end
```

KICKSTART所有配置就此告一段落，真实环境需要注意，新服务器跟kickstart最后独立在一个网络，不要跟办公环境或者服务器机房网络混在一起，如果别的机器以网卡就会把它的系统重装成Linux系统。

# 第十一章 Zabbix分布式监控企业实战

企业服务器对用户提供服务，作为运维工程师最重要的事情就是保证该网站正常稳定的运行，需要实时监控网站、服务器的运行状态，并且有故障及时去处理。

监控网站无需人工时刻去访问WEB网站或者登陆服务器去检查，可以借助开源监控软件例如Zabbix、Cacti、Nagios、Ganglia等来实现对网站的7x24小时的监控，并且做到有故障及时报警通知SA解决。

本章向读者介绍企业级分布式监控Zabbix入门、Zabbix监控原理、最新版本Zabbix安装实战、Zabbix批量监控客户端、监控MYSQL、WEB关键词及微信报警等。

## Zabbix监控系统入门简介

Zabbix是一个基于WEB界面的提供分布式系统监控的企业级的开源解决方案，Zabbix能监视各种网络参数，保证服务器系统的安全稳定的运行，并提供灵活的通知机制以让SA快速定位并解决存在的各种问题。Zabbix分布式监控系统的优点如下：

-   支持自动发现服务器和网络设备；
-   支持底层自动发现；
-   分布式的监控体系和集中式的WEB管理；
-   支持主动监控和被动监控模式；
-   服务器端支持多种操作系统：Linux, Solaris, HP-UX, AIX, FreeBSD, OpenBSD, MAC等；
-   Agent客户端支持多种操作系统：Linux, Solaris, HP-UX, AIX, FreeBSD,Windows等；
-   基于SNMP、IPMI接口方式、Agent方式；
-   安全的用户认证及权限配置；
-   基于WEB的管理方法，支持自由的自定义事件和邮件、短信发送；
-   高水平的业务视图监控资源，支持日志审计，资产管理等功能；
-   支持高水平API二次开发、脚本监控、自Key定义、自动化运维整合调用。

## Zabbix监控平台部署

Zabbix Server端和Zabbix Agent执行如下代码： Zabbix监控平台部署，至少需要安装四个组件，分别是Zabbix_Server、Zabbix_Web、Databases、Zabbix_Agent，如下为Zabbix监控平台安装配置详细步骤:

1.  系统环境
Server端：192.168.149.128
Agent端：192.168.149.129

2.  下载zabbix版本，各个版本之间安装方法相差不大，可以根据实际情况选择安装版本，本文版本为Zabbix-3.2.6.tar.gz。
```
wget https://jaist.dl.sourceforge.net/project/zabbix/ZABBIX%20Latest%20Stable/3.2.6/zabbix-3.2.6.tar.gz
yum -y install curl curl-devel net-snmp net-snmp-devel perl-DBI
groupadd zabbix
useradd -g zabbix zabbix
usermod -s /sbin/nologin zabbix
```

3.  Zabbix Server端配置

创建zabbix数据库，执行授权命令：
```
create  database  zabbix  charset=utf8；
grant all on zabbix.* to zabbix@localhost identified by '123456'；
flush privileges；
```
解压zabbix软件包并将Zabbix基础SQL文件导入数据至Zabbix数据库：
```
tar   zxvf  zabbix-3.2.6.tar.gz
cd   zabbix-3.2.6
mysql -uzabbix -p123456 zabbix <database/mysql/schema.sql
mysql -uzabbix -p123456 zabbix <database/mysql/images.sql
mysql -uzabbix -p123456 zabbix < database/mysql/data.sql

```

切换至Zabbix解压目录，执行如下代码，安装Zabbix_server：
```
./configure --prefix=/usr/local/zabbix/ --enable-server --with-mysql --enable-ipv6 --with-net-snmp  --with-libcurl
make
make install
ln -s /usr/local/zabbix/sbin/zabbix_*  /usr/local/sbin/
```

Zabbix server安装完毕，cd /usr/local/zabbix/etc/目录，如图13-3所示：

![图13-3 Zabbix监控流程图](http://qiniu.imolili.com/小书匠/1594260794895.png)

备份Zabbix server配置文件，代码如下：
`cp zabbix_server.conf zabbix_server.conf.bak`

将zabbix_server.conf配置文件中代码设置为如下：
```
LogFile=/tmp/zabbix_server.log
DBHost=localhost
DBName=zabbix
DBUser=zabbix
DBPassword=123456
```

同时cp zabbix_server启动脚本至/etc/init.d/目录，启动zabbix_server,
Zabbix_server默认监听端口为10051。
```
cd  zabbix-3.2.6
cp  misc/init.d/tru64/zabbix_server  /etc/init.d/zabbix_server
chmod  o+x  /etc/init.d/zabbix_server
```

配置Zabbix interface Web页面，安装HTTP WEB服务器，将Zabbix WEB代码发布至Apache默认发布目录，由于Zabbix3.2+ 的 PHP版本需要使用PHP5.4.0版本，请将本机PHP版本升级至5.4.0+，PHP5.3升级至PHP5.6，代码如下：
```
rpm -Uvh http://repo.webtatic.com/yum/el6/latest.rpm
yum remove php*
yum install php56w.x86_64 php56w-cli.x86_64 php56w-common.x86_64 php56w-gd.x86_64 php56w-ldap.x86_64 php56w-mbstring.x86_64 php56w-mcrypt.x86_64 php56w-mysql.x86_64 php56w-pdo.x86_64  -y
yum   install  httpd  httpd-devel  httpd-tools  -y
cp -a   /root/zabbix-3.2.6/frontends/php/*    /var/www/html/
sed    -i   '/date.timezone/i date.timezone = PRC'   /etc/php.ini

```

重新启动Zabbix Server、HTTP、MYSQL服务，代码如下：
```
/etc/init.d/zabbix_server restart 
/etc/init.d/httpd   restart 
/etc/init.d/mysqld restart
```

4.  Zabbix WEB GUI安装配置

通过浏览器Zabbix_WEB验证，通过浏览器访问 `http://192.168.149.128/` ，如图13-4所示：

![图13-4 Zabbix WEB安装界面](http://qiniu.imolili.com/小书匠/1594260794900.png)

单击下一步，出现如图13-5所示，如果有错误提示，需要把错误依赖解决完，方可进行下一步操作。

![图13-5 Zabbix WEB安装错误提示](http://qiniu.imolili.com/小书匠/1594260794903.png)

如上异常错误解决方法代码如下，安装缺失的软包，并修改php.ini对应参数的值即可，如图13-6所示：
```
yum  install  php-mbstring  php-bcmath  php-gd  php-xml  -y
yum  install  gd  gd-devel  -y
sed   -i '/post_max_size/s/8/16/g;/max_execution_time/s/30/300/g;/max_input_time/s/60/300/g;s/\;date.timezone.*/date.timezone \= PRC/g;s/\;always_populate_raw_post_data/always_populate_raw_post_data/g'  /etc/php.ini
service  httpd  restart
```

![图13-6 Zabbix WEB测试安装环境](http://qiniu.imolili.com/小书匠/1594260794907.png)

单击下一步，如图13-7所示，配置数据库连接，输入数据库名、用户、密码，单击Test connection，显示OK，单击下一步即可。

![图13-7 Zabbix WEB数据库配置](http://qiniu.imolili.com/小书匠/1594260794911.png)

继续单击下一步出现如图13-8所示，填写Zabbix Title显示，可以为空，可以输入自定义的名称。

![图13-8 Zabbix WEB详细信息](http://qiniu.imolili.com/小书匠/1594260794915.png)

单击下一步，如图13-9所示，需修创建zabbix.conf.php文件，执行如下命令，或者单击“[Download the configuration file](http://192.168.149.128/setup.php?save_config=1)”下载zabbix.conf.php文件，并将该文件上传至/var/www/html/conf/，并设置可写权限，刷新WEB页面，zabbix.conf.php内容代码如下，最后单击Finish即可：
```
<?php
// Zabbix GUI configuration file.
global $DB；
$DB['TYPE']     = 'MYSQL'；
$DB['SERVER']   = 'localhost'；
$DB['PORT']     = '0'；
$DB['DATABASE'] = 'zabbix'；
$DB['USER']     = 'zabbix'；
$DB['PASSWORD'] = '123456'；
// Schema name. Used for IBM DB2 and PostgreSQL.
$DB['SCHEMA'] = ''；
$ZBX_SERVER      = 'localhost'；
$ZBX_SERVER_PORT = '10051'；
$ZBX_SERVER_NAME = '京峰教育-分布式监控系统'；
$IMAGE_FORMAT_DEFAULT = IMAGE_FORMAT_PNG；
```

![图13-9 Zabbix WEB配置文件测试](http://qiniu.imolili.com/小书匠/1594260794918.png)

登录Zabbix WEB界面，默认用户名和密码为：admin/zabbix，如图13-10（a）、13-10（b）所示：

![图13-10（a） Zabbix WEB登录界面](http://qiniu.imolili.com/小书匠/1594260794922.png)

![图13-10（b） Zabbix WEB后台界面](http://qiniu.imolili.com/小书匠/1594260794996.png)

5.  Agent客户端安装配置

解压zabbix-3.2.6.tar.gz源码文件，切换至解压目录，编译安装Zabbix，命令如下：
```
./configure  --prefix=/usr/local/zabbix --enable-agent 
make 
make install 
ln -s /usr/local/zabbix/sbin/zabbix_* /usr/local/sbin/
```

修改zabbix_agentd.conf客户端配置文件，执行如下命令，zabbix_agentd.conf内容，指定server IP，同时设置本地Hostname为本地IP地址或者DNS名称： CPU、内存、负载、网卡、磁盘、IO、应用服务、端口、登录用户、
```
LogFile=/tmp/zabbix_agentd.log
Server=192.168.149.128
ServerActive=192.168.149.128
Hostname = 192.168.149.129
```

同时cp zabbix_agentd启动脚本至/etc/init.d/目录，启动zabbix_agentd服务即可， Zabbix_agentd默认监听端口为10050。
```
cd zabbix-3.2.6
cp misc/init.d/tru64/zabbix_agentd /etc/init.d/zabbix_agentd
chmod o+x /etc/init.d/zabbix_agentd
/etc/init.d/zabbix_agentd  start
```

6.  Zabbix监控客户端

Zabbix服务端和客户端安装完毕之后，需通过Zabbix Server添加客户端监控，Zabbix WEB界面添加客户端监控的操作步骤如下，如图13-11所示：

Zabbix-WEB -> configuration ->  hosts -> 
Create host ->  Host name和Agent interfaces，
同时选择添加templates模板 -> 选择Add ->  勾选Template OS Linux-选择Add提交； 

> 注\*此处Host name名称与Agentd.conf配置文件中Hostname保持一致，否则会报错。

![图13-11 Zabbix 添加客户端监控](http://qiniu.imolili.com/小书匠/1594260794998.png)

将客户端主机链接至“Template OS Linux”，启用模板完成主机默认监控，单击Add，继续单击Update即可，如图13-12所示：

![图13-12 Zabbix 为客户端监控添加模板](http://qiniu.imolili.com/小书匠/1594260795002.png)

单击Zabbix WEBMonitoringGraphsGroupHostGraph，监控图像如图13-13（a）、13-13（b）所示：

![图13-13（a） Zabbix客户端监控图像](http://qiniu.imolili.com/小书匠/1594260795005.png)

![图13-13（b） Zabbix客户端监控图像](http://qiniu.imolili.com/小书匠/1594260795009.png)

如果无法监控到客户端，可以在Zabbix Server端，执行命令获取Agent的items KEY值是否有返回，例如system.uname为返回客户端的uname信息，监测命令如下：
`/usr/local/zabbix/bin/zabbix_get -s 192.168.149.130 -k system.uname`

## Zabbix自动发现及注册

熟练通过Zabbix监控平台监控单台客户端之后，企业中有成千上万台服务器，如果手工添加会非常耗时间，造成大量的人力成本的浪费，有没有什么好的自动化添加客户端的方法呢？

Zabbix自动发现就是为了解决批量监控而设计的功能之一，什么是自动发现呢，简单来说就是Zabbix Server端可以基于设定的规则，自动批量的去发现局域网若干服务器，并自动把服务器添加至Zabbix监控平台，省去人工手动频繁的添加，节省大量的人力成本。

Zabbix相对于Nagios、Cacti监控来说，如果要想批量监控，Nagios、Cacti需要手动单个添加设备、分组、项目、图像，也可以使用脚本，但是不能实现自发方式添加。

Zabbix最大的特点之一就是可以批量自动主机并监控，利用发现(Discovery)模块，实现自动发现主机、自动将主机添加到主机组、自动加载模板、自动创建项目（Items）、自动创建监控图像，操作步骤如下：

1.  Configuration -> discovery ->  Create discovery rule，如图13-14所示：

![图13-14 创建客户端发现规则](http://qiniu.imolili.com/小书匠/1594260795013.png)

```
Name： 		   规则名称；
Discovery by proxy : 通过代理探索；
IP range : 	zabbix_server 探索区域的IP范围；
Delay : 	    搜索一次的时间间隔；
Checks : 	检测方式，如用ping方式去发现主机，zabbix_server需安装fping，此处使用Agent方式发现；
Device uniqueness criteria: 以IP地址作为被发现主机的标识。
```

2.  Zabbix客户端安装Agent

由于发现规则里选择checks方式为Agent，所以需在所有被监控的服务器安装zabbix Agent，安装的方法可以手动安装，也可以使用Shell脚本，附Zabbix客户端安装脚本，脚本运行方法：`sh auto_install_zabbix.sh`。

```
#!/bin/bash
#auto install zabbix
#by jfedu.net 2019
#############
ZABBIX_SOFT="zabbix-3.2.6.tar.gz"
INSTALL_DIR="/usr/local/zabbix/"
SERVER_IP="192.168.149.128"
IP=`ifconfig|grep Bcast|awk '{print $2}'|sed 's/addr://g'`
AGENT_INSTALL(){
yum -y install curl curl-devel net-snmp net-snmp-devel perl-DBI
groupadd zabbix ；useradd -g zabbix zabbix；usermod -s /sbin/nologin zabbix
tar -xzf $ZABBIX_SOFT；cd `echo $ZABBIX_SOFT|sed 's/.tar.*//g'`
./configure  --prefix=/usr/local/zabbix  --enable-agent&&make install
if [ $? -eq 0 ]；then
	ln -s /usr/local/zabbix/sbin/zabbix_* /usr/local/sbin/
fi
cd - ；cd zabbix-3.2.6
cp  misc/init.d/tru64/zabbix_agentd  /etc/init.d/zabbix_agentd ；chmod o+x /etc/init.d/zabbix_agentd
#config zabbix agentd
cat >$INSTALL_DIR/etc/zabbix_agentd.conf<<EOF
LogFile=/tmp/zabbix_agentd.log
Server=$SERVER_IP
ServerActive=$SERVER_IP
Hostname = $IP 
EOF
#start zabbix agentd
/etc/init.d/zabbix_agentd restart
/etc/init.d/iptables stop
setenforce 0
}
AGENT_INSTALL
```

3.  创建发现Action

Zabbix发现规则创建完毕，客户端Agent安装完后，被发现的IP主机不会自动添加至Zabbix监控列表，需要添加发现动作，添加方法如下：

Configuration -> Actions -> Event source(选择Discovery) -> Create action 

添加规则时，系统默认存在一条发现规则，可以新建规则，也可以编辑默认规则，如图13-15（a）、13-15（b）、13-15（c）所示，编辑默认发现规则，单击Operations设置发现操作，分别设置Add host、Add to host groups、Link to templates，最后启用规则即可：

![图13-15（a） 创建客户端发现动作](http://qiniu.imolili.com/小书匠/1594260795095.png)

![图13-15（b） 客户端发现自动添加至Zabbix](http://qiniu.imolili.com/小书匠/1594260795098.png)

![图13-15（c） 客户端发现自动添加至Zabbix](http://qiniu.imolili.com/小书匠/1594260795101.png)

MontoringDiscovery，查看通过发现规则找到的服务器IP列表，如图13-16所示：

![图13-16 被发现的客户端列表](http://qiniu.imolili.com/小书匠/1594260795104.png)

ConfigurationHosts，查看4台主机是否被自动监控至Zabbix监控平台，如图13-17所示：

![图13-17 自动发现的主机被添加至Hosts列表](http://qiniu.imolili.com/小书匠/1594260795108.png)

MonitoringGraphs，监控图像查看，如图13-18（a）、13-18（b）所示，可以选择Host、Graph分别查看各种的监控图像：

![图13-18（a） 客户端监控图像](http://qiniu.imolili.com/小书匠/1594260795111.png)

![图13-18（b） 客户端监控图像](http://qiniu.imolili.com/小书匠/1594260795115.png)

## Zabbix日常问题汇总

Zabbix 可以设置中文汉化，如果出现乱码解决办法，如果访问zabbix出现如下历史记录乱码， WEB界面乱码，原因是因为数据库导入前不是UTF-8字符集，需要修改为UTF-8模式，如图13-28所示：

![图13-28 数据库原字符集latin1](http://qiniu.imolili.com/小书匠/1594260795118.png)

MYSQL数据库修改字符集方法，vim /etc/my.cnf在配置段加入如下代码：
```
[mysqld]
character-set-server= utf8
[client]
default-character-set = utf8
[mysql]
default-character-set = utf8
```

备份zabbix数据库，并删除原数据库，重新创建，再导入备份的数据库，修改导入的zabbix.sql文件里面的latin1为utf8，然后再导入到zabbix库，乱码问题解决。
`sed -i 's/latin1/utf8/g' zabbix.sql`

如果在查看graphs监控图像界面的时候时候出现乱码，如图13-29所示：

![图13-29 Graphs图像乱码](http://qiniu.imolili.com/小书匠/1594260795121.png)

从windows下控制面板 -> 字体 -> 选择一种中文字库，例如“楷体”，如图13-30所示：

![图13-30 上传Windows简体中文字体](http://qiniu.imolili.com/小书匠/1594260795125.png)

将字体文件cp至zabbix服务dauntfonts目录下，/var/www/html/zabbix/fonts，并且将STKAITI.TTF重命名为DejaVuSans.ttf，最好刷新Graph图像，乱码问题解决，如图13-31（a）、13-31（b）所示：

![图13-31（a） 上传Windows简体中文字体](http://qiniu.imolili.com/小书匠/1594260795128.png)

![图13-31（b） Graph图像乱码问题解决](http://qiniu.imolili.com/小书匠/1594260795198.png)

## Zabbix触发命令及脚本

Zabbix监控在对服务或者设备进行监控的时候，如果被监控客户端服务异常，满足触发器，默认可以发送邮件报警、短信报警及微信报警。Zabbix还可以远程执行命令或者脚本对部分故障实现自动修复。具体可以执行的任务包括：

-   重启应用程序，例如Apache、Nginx、MySQL、Tomcat服务等；
-   通过IPMI接口重启服务器；
-   删除服务器磁盘空间及数据；
-   执行脚本及资源调度管理；
-   远程命令最大长度为255字符；
-   同时支持多个远程命令；
-   Zabbix代理不支持远程命令。

使用Zabbix远程执行命令，首先需在zabbix客户端配置文件开启对远程命令的支持，在zabbix_agentd.conf行尾加入如下代码，并重启服务，如图13-32所示：
`EnableRemoteCommands = 1`

![图13-32 客户端配置远程命令支持](http://qiniu.imolili.com/小书匠/1594260795201.png)

创建Action，ConfigurationActionsTriggers，如图13-33（a）、13-33（b）所示，类型选择“Remote Command”，steps表示执行命令1-3次， step duration设置每次命令间隔时间的5秒执行一次，执行命令方式选择Zabbix agent，基于sudo执行命令即可：

![图13-33（a） 客户端触发器满足条件](http://qiniu.imolili.com/小书匠/1594260795204.png)

![图13-33（b） Operations类型选择Remote Command](http://qiniu.imolili.com/小书匠/1594260795207.png)

Zabbix客户端Sudoer配置文件中添加zabbix用户拥有执行权限且无需密码登录:
```
Defaults:zabbix        !requiretty
zabbix  ALL=(ALL)     NOPASSWD: ALL
```

Zabbix客户端/data/sh/，创建auto_clean_disk.sh，脚本代码如下：

```
#!/bin/bash
#auto clean disk space
#2019年6月21日10:12:18
#by author jfedu.net
rm -rf /boot/test.img
find /boot/ -name "*.log" -size +100M -exec rm -rf {} \；
```

将192.168.149.129服务器/boot目录，临时写满，然后满足触发器，实现远程命令执行，查看问题事件命令执行结果，如图13-34（a）、13-34（b）所示：

![图13-34（a） Remote Command执行成功](http://qiniu.imolili.com/小书匠/1594260795211.png)

![图13-34（b） Remote Command执行磁盘清理成功](http://qiniu.imolili.com/小书匠/1594260795214.png)

如果Zabbix客户端脚本或者命令没有执行成功，http服务没有停止,可以在Zabbix server端执行如下命令，如图13-35所示：
`/usr/local/zabbix/bin/zabbix_get -s 192.168.149.129 -k "system.run[sudo /etc/init.d/httpd restart]"`

![图13-35 测试Remote Command命令](http://qiniu.imolili.com/小书匠/1594260795285.png)

## Zabbix分布式监控实战

Zabbix是一个分布式监控系统，它可以以一个中心点、多个分节点的模式运行，使用Proxy能大大的降低Zabbix Server的压力，Zabbix Proxy可以运行在独立的服务器上，如图13-36所示：

![图13-36 Zabbix Proxy网络拓扑图](https://markdown.xiaoshujiang.com/img/spinner.gif "[[[1594261554057]]]" )

安装Zabbix Proxy，基于Zabbix-3.2.6.tar.gz软件包，同时需要导入zabbix基本框架库，具体实现方法如下：

1.  下载Zabbix软件包，代码如下：
`wget http://sourceforge.net/projects/zabbix/files/ZABBIX%20Latest%20Stable/3.2.6/zabbix-3.2.6.tar.gz/download`

2.  Zabbix Proxy上执行如下代码：
```
yum -y install curl curl-devel net-snmp net-snmp-devel perl-DBI groupadd zabbix ；
useradd -g zabbix zabbix；
usermod -s /sbin/nologin zabbix
```

3.  Zabbix Proxy端配置
创建zabbix数据库，执行授权命令：
```
create  database  zabbix_proxy  charset=utf8;
grant all on zabbix_proxy.* to zabbix@localhost identified by '123456';
flush privileges;
```

解压zabbix软件包并将Zabbix基础SQL文件导入数据至Zabbix数据库：
```
tar   zxvf  zabbix-3.2.6.tar.gz
cd   zabbix-3.2.6
mysql -uzabbix -p123456 zabbix_proxy <database/mysql/schema.sql
mysql -uzabbix -p123456 zabbix_proxy <database/mysql/images.sql
```

切换至Zabbix解压目录，执行如下代码，安装Zabbix_server：
```
./configure --prefix=/usr/local/zabbix/ --enable-proxy --enable-agent --with-mysql --enable-ipv6 --with-net-snmp --with-libcurl
make
make install
ln -s /usr/local/zabbix/sbin/zabbix_*  /usr/local/sbin/
```

Zabbix Proxy安装完毕，cd /usr/local/zabbix/etc/目录，如图13-37所示：

![图13-37 Zabbix Proxy安装目录](http://qiniu.imolili.com/小书匠/1594260795288.png)

4.  备份Zabbix Proxy配置文件，代码如下：
`cp zabbix_proxy.conf zabbix_proxy.conf.bak`

5.  将zabbix_proxy.conf配置文件中代码设置为如下：
```
Server=192.168.149.128
Hostname=192.168.149.130
LogFile=/tmp/zabbix_proxy.log
DBName=zabbix_proxy
DBUser=zabbix
DBPassword=123456
Timeout=4
LogSlowQueries=3000
DataSenderFrequency=30
HistoryCacheSize=128M
CacheSize=128M
```

6.  Zabbix客户端安装Agent，同时配置Agent端Server设置为Proxy服务器的IP地址或者主机名，zabbix_agentd.conf配置文件代码：
```
LogFile=/tmp/zabbix_agentd.log
Server=192.168.149.130
ServerActive=192.168.149.130
Hostname = 192.168.149.131
```

7.  Zabbix Server WEB端添加Proxy，实现集中管理和分布式添加监控，如图13-38（a）、13-38（b）、13-38（c）所示：

![图13-38（a） Zabbix Proxy WEB添加](http://qiniu.imolili.com/小书匠/1594260795292.png)

![图13-38（b） Zabbix Proxy监控客户端](http://qiniu.imolili.com/小书匠/1594260795295.png)

![图13-38（c） Zabbix Proxy监控客户端图像](http://qiniu.imolili.com/小书匠/1594260795299.png)

## Zabbix监控网站关键词

随着公司网站系统越来越多,不能通过人工每天手动去刷新网站来检查网站代码及页面是否被传该,通过zabbix监控可以实现自动去检查WEB网站是否被串改,例如监控某个客户端网站页面中关键词“ATM”是否被修改，通过脚本监控的方法如下：

1.  Agent端编写Shell脚本监控网站关键词,/data/sh/目录Shell脚本内容如下，如图13-49所示:
```
#!/bin/bash
#2019年5月24日09:49:48
#by author jfedu.net
###################
WEBSITE="http://192.168.149.131/"
NUM=`curl  -s  $WEBSITE|grep -c "ATM"`
echo $NUM
```

![图13-49 Zabbix 客户端脚本内容](http://qiniu.imolili.com/小书匠/1594260795302.png)

2.  客户端Zabbix_agentd.conf内容中加入如下代码，并重启Agentd服务即可，如图13-50所示：
`UserParameter=check_http_word,sh /data/sh/check_http_word.sh`

![图13-50 Zabbix 客户端脚本执行结果](http://qiniu.imolili.com/小书匠/1594260795306.png)

3.  服务器端获取客户端的关键词KEY，输入1，则表示ATM关键词存在，如果不为1则表示ATM关键词被串改。
`/usr/local/zabbix/bin/zabbix_get -s 192.168.149.131 -k check_http_word`

4.  Zabbix WEB端添加客户端的items监控项，如图13-51所示：

![图13-51 Zabbix 客户端KEY添加](http://qiniu.imolili.com/小书匠/1594260795309.png)

5.  创建check_http_word监控Graphs图像，如图13-52（a）、13-52（b）所示：

![图13-52（a） Zabbix 客户端添加Graphs](http://qiniu.imolili.com/小书匠/1594260795313.png)

![图13-52（b） Zabbix 客户端添加Graphs](http://qiniu.imolili.com/小书匠/1594260795317.png)

6.  创建check_http_word触发器，如图13-53（a）、13-53（b）所示：

![图13-53（a） Zabbix 客户端创建触发器](http://qiniu.imolili.com/小书匠/1594260795320.png)

![图13-53（b） Zabbix 客户端创建触发器](http://qiniu.imolili.com/小书匠/1594260795392.png)

7.  查看Zabbix客户端监控图像，如图13-54（a）、13-54（b）所示：

![图13-54（a） Zabbix Http word monitor监控图](http://qiniu.imolili.com/小书匠/1594260795400.png)

![图13-55（b） Zabbix Http word monitor触发器微信报警](http://qiniu.imolili.com/小书匠/1594260795403.png)

除了使用如上Shell脚本方法，还可以通过Zabbix WEB界面配置Http URL监控，方法如下：

1.  Configuration -> Hosts -> WEB，创建WEB监控场景，基于Chrome38.0访问HTTP WEB页面，如图13-55（a）、13-55（b）、13-55（c）、13-55（d）、13-55（e）所示：

![图13-55（a）Zabbix WEB场景配置](http://qiniu.imolili.com/小书匠/1594260795406.png)

![图13-55（b）Zabbix WEB场景配置](http://qiniu.imolili.com/小书匠/1594260795409.png)

![图13-55（c）Zabbix WEB场景配置](http://qiniu.imolili.com/小书匠/1594260795413.png)

![图13-55（d）Zabbix WEB监控图](http://qiniu.imolili.com/小书匠/1594260795523.png)

![图13-55（e）Zabbix WEB监控图](http://qiniu.imolili.com/小书匠/1594260795526.png)

# 第十二章 Shell企业编程企业实战

说到Shell编程，很多从事Linux运维工作的朋友都不陌生，都对Shell有基本的了解，读者可能刚开始接触Shell的时候，有各种想法，感觉编程非常困难，SHELL编程是所有编程语言中最容易上手，最容易学习的编程脚本语言。

本章向读者介绍Shell编程入门、Shell编程变量、If、While、For、Case、Select基本语句案例演练及Shell编程四剑客Find、Grep、Awk、Sed深度剖析等。

## SHELL编程入门简介

曾经有人说过，学习Linux不知道Shell编程，那就是不懂Linux，现在细细品味确实是这样。Shell是[操作系统](http://baike.baidu.com/view/880.htm)的最外层，Shell可以合并编程语言以控制进程和文件，以及启动和控制其它程序。

Shell 通过提示您输入，向[操作系统](http://baike.baidu.com/view/880.htm)解释该输入，然后处理来自操作系统的任何结果输出，简单来说Shell就是一个用户跟操作系统之间的一个命令解释器。

Shell是用户与Linux操作系统之间沟通的桥梁，用户可以输入命令执行，又可以利用 Shell脚本编程去运行，如图17-1所示：

![图17-1 Shell、用户及Kernel位置关系](http://qiniu.imolili.com/小书匠/1594260795529.png)

![](http://qiniu.imolili.com/小书匠/1594260795532.png)

Linux Shell种类非常多，常见的SHELL如下：

-   Bourne Shell（/usr/bin/sh或/bin/sh）
-   Bourne Again Shell（/bin/bash）
-   C Shell（/usr/bin/csh）
-   K Shell（/usr/bin/ksh）
-   Shell for Root（/sbin/sh）

不同的Shell语言的语法有所不同，一般不能交换使用，最常用的shell是Bash，也就是Bourne Again Shell。Bash由于易用和免费，在日常工作中被广泛使用，也是大多数Linux操作系统默认的Shell环境。

Shell、Shell编程、Shell脚本、Shell命令之间都有什么区别呢？简单来说Shell是一个整体的概念，Shell编程与Shell脚本统称为Shell编程，Shell命令是Shell编程底层具体的语句和实现方法。

## SHELL脚本及Hello World

要熟练掌握Shell编程语言，需要大量的练习，初学者可以用Shell打印“Hello World”字符，寓意着开始新的启程！

Shell脚本编程需要如下几个事项：

-   Shell脚本名称命名一般为英文、大写、小写；
-   不能使用特殊符号、空格来命名；
-   Shell脚本后缀以.sh结尾；
-   不建议Shell命名为纯数字，一般以脚本功能命名。
-   Shell脚本内容首行需以 #! /bin/bash开头；
-   Shell脚本中变量名称尽量使用大写字母，字母间不能使用“-”，可以使用 “\_”；
-   Shell脚本变量名称不能以数字、特殊符号开头。

如下为第一个Shell编程脚本，脚本名称为：first_shell.sh，代码内容如下：
```
#!/bin/bash
#This is my First shell
#By author jfedu.net 2019
echo  “Hello  World ”
```

Shell脚本编写完毕，如果运行该脚本，运行用户需要有执行权限，可以使用 `chmod o+x first_shell.sh` 赋予可执行权限。然后./first_shell.sh执行即可，还可以直接使用命令执行: /bin/sh first_shell.sh直接运行脚本，不需要执行权限，最终脚本执行显示效果一样。

初学者学习Shell编程，可以将在Shell终端运行的各种命令依次写入到脚本内容中，可以把Shell脚本当成是Shell命令的堆积。

## Shell编程之变量详解

Shell是非类型的解释型语言，不像C++、JAVA语言编程时需要事先声明变量，Shell给一个变量赋值，实际上就是定义了变量，在Linux支持的所有shell中，都可以用赋值符号(=)为变量赋值，Shell变量为弱类型，定义变量不需要声明类型，但在使用时需要明确变量的类型，可以使用Declare指定类型，Declare常见参数有：

```
+/-  "-"可用来指定变量的属性，"+"为取消变量所设的属性；
-f 　仅显示函数；
r 　将变量设置为只读；
x 　指定的变量会成为环境变量，可供shell以外的程序来使用；
i 　指定类型为数值，字符串或运算式。
```

Shell编程中变量分为三种，分别是系统变量、环境变量和用户变量，Shell变量名在定义时，首个字符必须为字母（a-z，A-Z），不能以数字开头，中间不能有空格，可以使用下划线（\_），不能使用（-），也不能使用标点符号等。

例如定义变量A=jfedu.net，定义这样一个变量，A为变量名，jfedu.net是变量的值，变量名有格式规范，变量的值可以随意指定。变量定义完成，如需要引用变量，可以使用\$A。

如下脚本var.sh脚本内容如下：
```
#!/bin/bash
#By author jfedu.net 2019
A=123
echo  “Printf variables is $A.”
```

执行该Shell脚本，结果将会显示：Printf variables is jfedu.net。

## Shell编程之环境变量

Shell常见的变量之二环境变量，主要是在程序运行时需要设置，环境变量详解如下：
```
PATH  							命令所示路径，以冒号为分割；
HOME  						打印用户家目录；
SHELL 							显示当前Shell类型；
USER  							打印当前用户名；
ID    							打印当前用户id信息；
PWD   							显示当前所在路径；
TERM  							打印当前终端类型；
HOSTNAME      				显示当前主机名。
```


## Shell编程之用户变量

Shell常见的变量之三用户变量，用户变量又称为局部变量，主要用在Shell脚本内部或者临时局部使用，系统变量详解如下：
```
A=jfedu.net  					    自定义变量A；
N_SOFT=nginx-1.12.0.tar.gz  		自定义变量N_SOFT；
BACK_DIR=/data/backup/      	    自定义变量BACK_DIR；
IP1=192.168.1.11					自定义变量IP1；
IP2=192.168.1.12					自定义变量IP2。
```

创建Echo打印菜单Shell脚本，脚本代码如下：
```
#!/bin/bash
#auto install httpd 
#By author jfedu.net 2019
echo -e '\033[32m-----------------------------\033[0m'
FILE=httpd-2.2.31.tar.bz2
URL=http://mirrors.cnnic.cn/apache/httpd/
PREFIX=/usr/local/apache2/
echo -e "\033[36mPlease Select Install Menu:\033[0m"
echo
echo "1)官方下载Httpd文件包."
echo "2)解压apache源码包."
echo "3)编译安装Httpd服务器."
echo "4)启动HTTPD服务器."
echo -e '\033[32m-----------------------------\033[0m'
sleep 20
```

运行脚本，执行结果如图17-2所示：

![图17-2 Echo打印菜单脚本](http://qiniu.imolili.com/小书匠/1594260795536.png)

## If条件语句实战

Linux Shell编程中，if、for、while、case等条件流程控制语句用的非常多，熟练掌握以上流程控制语句及语法的实验，对编写Shel脚本有非常大的益处。

If条件判断语句，通常以if开头，fi结尾。也可加入else或者elif进行多条件的判断，if表达式如下：
```
if  (表达式) 
	语句1
else
	语句2
fi
```

If语句Shell脚本编程案例如下：

1.  比较两个整数大小。
```
#!/bin/bash
#By author jfedu.net 2019
NUM=100
if  (( $NUM > 4 )) ；then 
	echo “The  Num  $NUM  more  than 4.”
else
	echo “The  Num  $NUM  less   than 4.”
fi
```

2.  判断系统目录是否存在。
```
#!/bin/bash
#judge DIR or Files
#By author jfedu.net 2019
if  [  !  -d  /data/20140515  -a  !  -d  /tmp/2019/  ]；then 
	mkdir  -p  /data/20140515
fi
```

3.  if多个条件测试分数判断。
```
#!/bin/bash
#By author jfedu.net 2019
scores=$1
if  [[ $scores -eq 100 ]]； then
    echo "very good!"；
elif [[ $scores -gt 85 ]]； then
    echo "good!"；
elif [[ $scores -gt 60 ]]； then
    echo "pass!"；
elif [[ $scores -lt 60 ]]； then
    echo "no pass!"
fi

```

## For循环语句实战

for循环语句主要用于对某个数据域进行循环读取、对文件进行遍历，通常用于需要循环某个文件或者列表。其语法格式以for…do开头，done结尾。语法格式如下：
```
For  var  in  （表达式）
do
	语句1
done
```

For循环语句Shell脚本编程案例如下：

1.  循环打印BAT企业官网：
```
#!/bin/bash
#By author jfedu.net 2019
for  website  in  www.baidu.com www.taobao.com www.qq.com
do
	echo  $website
done
```

2.  循环打印1至100数字，seq表示列出数据范围：
```
#!/bin/bash
#By author jfedu.net 2019
for   i   in  `seq 1 100`
do
	echo  “NUM is $i”
done
```

3.  For循环求1-100的总和：
```
#!/bin/bash
#By author jfedu.net 2019
#auto sum 1 100
j=0
for  ((i=1；i<=100；i++))
do
     j=`expr $i + $j`
done
echo $j
```

4.  对系统日志文件进行分组打包：
```
#!/bin/bash
#By author jfedu.net 2019
for   i   in  `find /var/log  -name “*.log”`
do
	tar  -czf  2019_log$i.tgz  $i
done
```

5.  For循环批量远程主机文件传输：
```
#!/bin/bash
#auto scp files for client
#By author jfedu.net 2019
for i in `seq 100 200`
do
scp -r /tmp/jfedu.txt root@192.168.1.$i:/data/webapps/www
done
```

6.  For循环批量远程主机执行命令：
```
#!/bin/bash
#auto scp files for client
#By author jfedu.net 2019
for i in `seq 100 200`
do
       ssh -l  root 192.168.1.$i ‘ls /tmp’
done
```

7.  For循环打印10秒等待提示：
```
for ((j=0；j<=10；j++))
do 
	 echo  -ne  "\033[32m-\033[0m"
	 sleep 1 
done
echo
```

## Shell编程实战系统备份脚本

日常企业运维中，需要备份Linux操作系统中重要的文件，例如/etc、/boot分区、重要网站数据等，在备份数据时，由于数据量非常大，需要指定高效的备份方案，如下为常用的备份数据方案：

-   每周日进行完整备份，周一至周六使用增量备份；
-   每周六进行完整备份，周日至周五使用增量备份。

企业备份数据的工具主要有：tar、cp、rsync、scp、sersync、dd等工具。如下为基于开源tar工具实现系统数据备份方案：

Tar工具手动全备份网站，-g参数指定新的快照文件：
`tar -g /tmp/snapshot -czvf /tmp/2019_full_system_data.tar.gz /data/sh/`

Tar工具手动增量备份网站，-g参数指定全备已生成的快照文件，后续增量备份基于上一个增量备份快照文件：
`tar -g /tmp/snapshot -czvf /tmp/2014_add01_system_data.tar.gz /data/sh/`

Tar工具全备、增量备份网站，Shell脚本实现自动打包备份编写思路如下：

-   系统备份数据按每天存放；
-   创建完整备份函数块；
-   创建增量备份函数块；
-   根据星期数判断完整或增量；
-   将脚本加入Crontab实现自动备份；

Tar工具全备、增量备份网站，Shell脚本实现自动打包备份，代码如下：
Crontab任务计划中添加如下语句，每天凌晨1点整执行备份脚本即可：
`0 1 * * * /bin/sh /data/sh/auto_backup.sh /boot /etc/ >> /tmp/back.log 2>&1`

## 基于SHELL编程开发Linux系统初始化脚本

-   Linux系统安装完成，自动初始化系统；
-   关闭不必要的端口；
-   关闭不必要的服务；
-   添加同步时间任务计划；
-   优化相关Linux内核参数。

## Shell编程实战收集服务器信息

在企业上产环境中，经常会对服务器资产进行统计存档，单台服务器可以手动去统计服务器的CPU型号、内存大小、硬盘容量、网卡流量等，如果服务器数量超过百台、千台，使用手工方式就变得非常吃力。

基于Shell脚本实现自动化服务器硬件信息的收集，并将收集的内容存放在数据库，能更快、更高效的实现对服务器资产信息的管理。Shell脚本实现服务器信息自动收集，编写思路如下：

-   创建数据库和表存储服务器信息；
-   基于Shell四剑客awk、find、sed、grep获取服务器信息；
-   将获取的信息写成SQL语句；
-   定期对SQL数据进行备份；
-   将脚本加入Crontab实现自动备份；

# 第十三章 Puppet自动运维企业实战

Puppet是目前互联网主流三大自动化运维工具（Puppet、Ansible、Saltstack）之一，Puppet是一种Linux、Unix平台的集中配置管理系统，所谓配置管理系统，就是管理机器里面诸如文件、用户、进程、软件包等资源，其设计目标是简化对这些资源的管理以及妥善处理资源间的依赖关系。

本章向读者介绍Puppet工作原理、Puppet安装配置、企业资源案例讲解、Puppet高可用集群配置、Puppet批量更新部署网站、Puppet+SVN实现代码自动部署等。

## Puppet入门简介

Puppet使用一种描述性语言来定义配置项，配置项中被称为”资源”，描述性语言可以声明你的配置的状态，比如声明一个软件包应该被安装或者一个服务应该被启动用。

Puppet可以运行一台服务器端，每个客户端通过ssl证书连接服务器，得到本机器的配置列表，然后更加列表的来完成配置工作，所以如果硬件性能比较高，维护个管理上千上万台机器是非常轻松的，前提是客户端机器的配置、服务器路径、软件需要保持一致。

在企业级大规模的生成环境中，如果只有一台puppet master压力会非常大，因为puppet是用ruby语言编写，ruby是解析型语言，每个客户端来访问都要解析一次，当客户端服务器很多，会操作服务器端压力很多，所以需要扩展成一个服务器集群组。

Puppet master可以看作一个web服务器，实际上也是由ruby提供的web服务器模块来做的。因此可以利用web代理软件来配合puppet master做集群设置，一般使用Nginx+Puppet Master整合构建大型企业自动化运维管理工具，puppet项目主要开发者是Luke Kanies，目前为puppet labs CEO，Puppet遵循GPLv2版权协议。

从1997年开始Kanies参与UNIX的系统管理工作，Puppet的开发源于这些经验。因为对已有的配置工具不甚满意，从2001年到2005年间，Kanies开始在Reductive实验室从事工具的开发。很快Reductive实验室发布了他们新的旗舰产品。

Puppet是开源的基于Ruby的系统配置管理工具，Puppet工作流程为：puppet是一个C/S结构，所有的puppet客户端同一个服务器端的puppet通讯，每个puppet客户端每半小时(可以设置)连接一次服务器端，下载最新的配置文件，并且严格按照配置文件来配置服务器，配置完成以后puppet客户端可以反馈给服务器端一个消息，如果报错会给服务器端反馈一个消息。

## Puppet工作原理

要熟练掌握Puppet在企业生产环境中的应用，需要深入理解Puppet服务端与客户端详细的工作流程及原理，如图20-1（a）、20-1（b）所示，为Puppet Master与Agent完整工作流程图：

![图20-1（a） Puppet工作原理图](http://qiniu.imolili.com/小书匠/1594260795539.png)

![图20-1（b） Puppet工作原理图](http://qiniu.imolili.com/小书匠/1594260795544.jpg)

Puppet工作原理详解如下：
-   客户端puppetd调用本地facter，facter会探测出该主机的常用变量，例如主机名、内存大小、IP地址等。然后puppetd把这些信息发送到Puppet服务端。
-   Puppet服务端检测到客户端的主机名，然后会检测manifest中对应的node配置，并对这段内容进行解析，facter发送过来的信息可以作为变量进行处理。
-   Puppet服务端匹配Puppet客户端相关联的代码才进行解析，其它的代码不解析，解析分几个过程：语法检查、然后会生成一个中间的伪代码，然后再把伪代码发给Puppet客户端。
-   Puppet客户端接收到伪代码之后就会执行，执行完后会将执行的结果发送给Puppet服务端。
-   Puppet服务端再把客户端的执行结果写入日志。

## Puppet安装配置

由于Puppet为C/S模式，构建Puppet平台需安装Puppet Sserver端和Client端，安装之前准备好系统环境，如下：
```
操作系统版本：CentOS 6.5 x64
服务端ip 192.168.149.128  hostname：192-168-149-128-jfedu.net
客户端ip 192.168.149.130  hostname：192-168-149-130-jfedu.net
```

1.  Puppet服务端安装

由于Puppet主要是基于hostname来检测的，所以Puppet服务器端需修改主机名称为：192-168-149-128-jfedu.net，并且在hosts文件添加主机名和本机IP的对应关系，如果本地局域网有DNS服务器，可以无需修改hosts文件，修改主机名及配置hosts代码如下：
```
hostname `ifconfig eth0 |grep Bcast|awk '{print $2}'|cut -d:  -f  2 |sed 's/\./\-/g'`-jfedu.net
cat >>/etc/hosts<<EOF  
192.168.149.128 192-168-149-128-jfedu.net  
192.168.149.130 192-168-149-130-jfedu.net
EOF
```

Puppet服务端除了需要安装Puppet-server外，还需要Ruby的支持，需要安装Ruby相关软件包，默认YUM安装Puppet Server，会自动下载并安装Ruby相关软件，如图20-2所示：
```
rpm -Uvh http://yum.puppetlabs.com/el/6/products/x86_64/puppetlabs-release-6-1.noarch.rpm  
yum  install  puppet-server -y 
/etc/init.d/puppetmaster  start  
/etc/init.d/iptables      stop  
sed -i  '/SELINUX/S/enforce/disabled/' /etc/selinux/config
setenforce  0
```

![图20-2 Puppet-server服务端安装](http://qiniu.imolili.com/小书匠/1594260795548.png)

2.  Puppet客户端安装

Puppet主要是基于hostname来检测的，所以Puppet客户端也需要修改主机名称为：192-168-149-130-jfedu.net，并且在hosts文件添加主机名和本机IP的对应关系，如果本地局域网有DNS服务器，可以无需修改hosts文件，修改主机名及配置hosts代码如下：
```
hostname `ifconfig eth0 |grep Bcast|awk '{print $2}'|cut -d:  -f  2 |sed 's/\./\-/g'`-jfedu.net
cat >>/etc/hosts<<EOF  
192.168.149.128 192-168-149-128-jfedu.net  
192.168.149.130 192-168-149-130-jfedu.net
EOF
```

Puppet客户端除了需要安装puppet外，还需要Ruby的支持，需要安装Ruby相关软件包，默认YUM安装Puppet，会自动下载并安装Ruby相关软件，如图20-3所示：
```
rpm -Uvh http://yum.puppetlabs.com/el/6/products/x86_64/puppetlabs-release-6-1.noarch.rpm  
yum  install  puppet -y 
/etc/init.d/puppetmaster  start  
/etc/init.d/iptables      stop  
sed -i  '/SELINUX/S/enforce/disabled/' /etc/selinux/config
setenforce  0
```

![图20-3 Puppet客户端服务安装](http://qiniu.imolili.com/小书匠/1594260795551.png)

3.  Puppet客户端申请证书

由于Puppet客户端与Puppet服务端是通过SSL隧道通信的，客户端安装完成后，首次使用需向服务器端申请Puppet通信证书，Puppet客户端第一次连接服务器端会发起证书申请，在Puppet客户端执行命令如下，返回结果如图20-4所示：
`puppet agent --server 192-168-149-128-jfedu.net --test`

![图20-4 Puppet客户端发起证书申请](http://qiniu.imolili.com/小书匠/1594260795555.png)

4.  Puppet服务端颁发证书

Puppet客户端向服务器发起证书申请，服务器端必须审核证书，如果不审核，客户端与服务器端无法进行后续正常通信，Puppet服务端颁发证书命令代码如下，返回结果如图20-5所示：

```
puppet  cert  --list             查看申请证书的客户端主机名；
puppet  cert  -s  192-168-149-130-jfedu.net  颁发证书给客户端； 
puppet  cert  -s              为特定的主机颁发证书；
puppet  cert  -s  and  -a      给所有的主机颁发证书；
puppet  cert  --list   --all      查看已经颁发的所有证书。
```

![图20-5 Puppet服务端颁发证书](http://qiniu.imolili.com/小书匠/1594260795559.png)

## Puppet企业案例演示

Puppet是基于C/S架构，服务器端保存着所有对客户端服务器的配置代码，在puppet服务端该配置文件叫manifest，客户端下载manifest之后，可以根据manifest对客户端进行配置，例如软件包管理、用户管理、文件管理、命令管理、脚本管理等，Puppet主要基于各种资源或者模块来管理客户端。

默认Puppet服务器端manifest目录在/etc/puppet/manifests/下，只需要在该目录下创建一个site.pp文件，然后写入相应的配置代码，Puppet客户端跟Puppet服务端同步时，会检查客户端node配置文件，匹配之后会将该代码下载至客户端，对代码进行解析，然后在客户端执行。

如下为在Puppet客户端创建test.txt文件，并在该文件中写入测试内容，操作方法如下：

1.  Puppet服务端创建node代码，创建或者编辑 `vi /etc/puppet/manifests/site.pp` 文件，在文件中加入如下代码：
```
node  default {  
file  { 
"/tmp/test.txt":
 content => "Hello World，jfedu.net  2017"；  
   } 
}
```

manifests site.pp配置文件代码详解如下：
```
node  default     新建node节点，default表示所有主机，可修改为特定主机名；
file              基于file资源模块管理客户端文件或者目录操作；            
"/tmp/test.txt":     需在客户端文件创建的文件名；
content          客户端服务器文件内容。
```
2.  客户端执行同步命令，获取Puppet服务端node配置，代码如下，如图20-6所示，执行报错：
`puppet agent --server=192-168-149-128-jfedu.net --test`

![图20-6 Puppet客户端同步服务端配置](http://qiniu.imolili.com/小书匠/1594260795730.png)

报错原因是因为服务器端与客户端时间不同步导致，需要同步时间，然后再次执行puppet agent命令，如图20-7所示：
`ntpdate pool.ntp.org puppet agent --server=192-168-149-128-jfedu.net --test`

![图20-7 Puppet客户端获取服务端node配置](http://qiniu.imolili.com/小书匠/1594260795758.png)

Puppet客户端执行同步效果，执行日志如下，会在/tmp/目录创建test.txt文件，内容为：“Hello World，jfedu.net”，即证明Puppet客户端成功获取服务端node配置。

```
Info: Caching certificate_revocation_list for ca
Warning: Unable to fetch my node definition, but the agent run will continue:
Warning: undefined method `include?' for nil:NilClass
Info: Retrieving pluginfacts
Info: Retrieving plugin
Info: Caching catalog for 192-168-149-130-jfedu.net
Info: Applying configuration version '1496805041'
Notice: /Stage[main]/Main/Node[default]/File[/tmp/test.txt]/ensure: defined content as '{md5}d1c2906ad0b249a330e936e3bc1d38d9'
Info: Creating state file /var/lib/puppet/state/state.yaml
Notice: Finished catalog run in 0.04 seconds
```

## Puppet常见资源及模块

Puppet主要基于各种资源模块管理客户端，目前企业主流Puppet管理客户端资源模块如下：

```
file						主要负责管理文件；
package					软件包的安装管理；
service					系统服务的管理；
cron						配置自动任务计划；
exec						远程执行运行命令。
```

通过命令puppet describe -l可以查看puppet支持的所有资源和模块，如图20-8（a）、20-8（b）所示：

![图20-8（a） Puppet支持的资源及模块](http://qiniu.imolili.com/小书匠/1594260795782.png)

![图20-8（b） Puppet支持的资源及模块](http://qiniu.imolili.com/小书匠/1594260795809.png)

通过命令puppet describe -s file可以查看puppet file资源所有的帮助信息，如图20-9（a）、20-9（b）所示：

![图20-9（a） Puppet file资源模块详情](http://qiniu.imolili.com/小书匠/1594260795833.png)

![图20-9（b） Puppet file资源模块详情](http://qiniu.imolili.com/小书匠/1594260795857.png)

## Puppet file资源案例

Puppet file资源主要用于管理客户端文件，包括文件的内容、所有权和权限，其可管理的文件类型包括：普通文件、目录以及符号链接等。

类型应在“确保”属性中指定，如果是文件内容可以直接用'content属性来管理，或者使用source属性从远程源下载；后者也可以用recurse服务目录（当recurse属性设置为“true”或“local”。Puppet file资源支持参数如下：
```
ensure 					默认为文件或目录； 
backup 					通过filebucket备份文件； 
checksum				检查文件是否被修改的方法； 
ctime 					只读属性，文件的更新时间； 
mtime 					只读属性，文件的修改时间； 
content 				    文件的内容，与source和target互斥 ；
force 					强制执行删除文件、软链接机目录的操作； 
owner 					用户名或用户ID；
group 					指定文加年的用户组或组id；
link 					    软链接；
mode 					文件权限配置，通常采用数字符号；
path 					文件路径；
Parameters
    backup, checksum, content, ctime, ensure, force, group, ignore, links,
    mode, mtime, owner, path, purge, recurse, recurselimit, replace,
    selinux_ignore_defaults, selrange, selrole, seltype, seluser, show_diff,
    source, source_permissions, sourceselect, target, type, validate_cmd,
    validate_replacement
Providers：
posix, windows
```

1.  从Puppet服务器下载nginx.conf文件至客户端/tmp目录，首先需要将nginx.conf文件cp至/etc/puppet/files目录，然后在/etc/puppet/fileserver.conf中添加如下三行代码，并重启Puppetmaster即可：
```
[files]
path  /etc/puppet/files/
allow *
```

创建site.pp文件，文件代码如下：
```
node  default {
file  {
        '/tmp/nginx.conf':
        mode => '644',
        owner => 'root',
        group => 'root',
        source => 'puppet://192-168-149-128-jfedu.net/files/nginx.conf',
   }
}
```

客户端同步配置，如图20-10所示：

![图20-10 Puppet file资源远程下载文件](http://qiniu.imolili.com/小书匠/1594260795904.png)

2.  从Puppet服务器下载sysctl.conf，如果客户端该文件存在则备份为sysctl.conf.bak，然后再覆盖原文件，site.pp代码如下，如图20-11所示：
```
node  default {
file {
        "/etc/sysctl.conf":
        source => "puppet://192-168-149-128-jfedu.net/files/sysctl.conf",
        backup => ".bak_$uptime_seconds",
   }
}
```

![图20-11 Puppet file资源备份文件](http://qiniu.imolili.com/小书匠/1594260796030.png)

3.  在Agent上创建/export/docker的软连接为/var/lib/docker/，site.pp代码如下，如图20-12所示：
```
node  default {
file {
        "/var/lib/docker":
        ensure => link,
        target => "/export/docker",
  }
```

![图20-12 Puppet file资源备份文件](http://qiniu.imolili.com/小书匠/1594260796032.png)

4.  在Agent上创建目录/tmp/20501212，site.pp代码如下，如图20-13所示：
```
node  default {
file {
        "/tmp/20501212":
        ensure => directory;
        }
}
```

![图20-13 Puppet file创建目录](http://qiniu.imolili.com/小书匠/1594260796055.png)

## Puppet package资源案例

Puppet package资源主要用于管理客户端服务器的软件包，yum源为/etc/yum.repo.d/安装和升级操作，通过puppet基于yum自动安装软件包，所以需要先配置好yum源。

常见的操作可以对软件包进行安装、卸载以及升级操作。Puppet package资源支持参数如下：
```
Parameters
    adminfile, allow_virtual, allowcdrom, category, configfiles,
    description, ensure, flavor, install_options, instance, name,
    package_settings, platform, responsefile, root, source, status,
    uninstall_options, vendor
Providers
    aix, appdmg, apple, apt, aptitude, aptrpm, blastwave, dpkg, fink,
    freebsd, gem, hpux, macports, msi, nim, openbsd, opkg, pacman, pip, pkg,
    pkgdmg, pkgin, pkgutil, portage, ports, portupgrade, rpm, rug, sun,
sunfreeware, up2date, urpmi, windows, yum, zipper
ensure => {installed|absent|pureged|latest} 
present  			检查软件是否存在，不存在则安装；
installed			    表示安装软件；
absent   			删除（无依赖），当别的软件包依赖时，不可删除；
pureged  			删除所有配置文件和依赖包，有潜在风险，慎用；
latest   			    升级到最新版本；
version  			    指定安装具体的某个版本号。
```

1.  客户端安装ntpdate及screen软件，代码如下，执行结果如图20-14所示：
```
node  default {
package { 
 ["screen","ntp"]:  
 ensure => "installed"; 
}
```

![图20-14 Puppet package安装软件](http://qiniu.imolili.com/小书匠/1594260796075.png)

2.  客户端卸载ntpdate及screen软件，代码如下，执行结果如图20-15所示：
```
node  default {
package { 
 ["screen","ntp"]:  
 ensure => "absent"; 
}
```

![图20-15 Puppet package卸载软件](http://qiniu.imolili.com/小书匠/1594260796096.png)

## Puppet service资源案例

Puppet service资源主要用于启动、重启和关闭客户端的守护进程，同时可以监控进程的状态，还可以将守护进程加入到自启动中。Puppet service资源支持参数如下：

```
Parameters
    binary, control, enable, ensure, flags, hasrestart, hasstatus, manifest,
    name, path, pattern, restart, start, status, stop

Providers
    base, bsd, daemontools, debian, freebsd, gentoo, init, launchd, openbsd,
    openrc, openwrt, redhat, runit, service, smf, src, systemd, upstart,
windows
enable    				指定服务在开机的时候是否启动，可以设置true和false；
ensure    				是否运行服务，running表示运行，stopped表示停止服务；
name    				守护进程的名字；
path    					启动脚本搜索路径；
provider  				默认为init；
hasrestart				管理脚本是否支持restart参数,如果不支持,就用stop和start实现restart效果；
hasstatus 				管理脚本是否支持status参数，puppet用status参数来判断服务是否已经在运行了,如果不支持status参数,puppet利用查找运行进程列表里面是否有服务名来判断服务是否在运行。
```

1.  启动Agent httpd服务，停止nfs服务，代码如下，结果如图20-16（a）、20-16（b）所示：
```
node  default {
service {
        "httpd":
        ensure => running;
        "nfs": 
        ensure => stopped;
  }
```

![图20-16（a） Puppet service重启服务](http://qiniu.imolili.com/小书匠/1594260796116.png)

![图20-16（b） Puppet service重启服务](http://qiniu.imolili.com/小书匠/1594260796119.png)

2.  启动Agent httpd服务并且开启启动，停止nfs服务，开启不启动，代码如下，结果如图20-17（a）、20-17（b）所示：
```
node  default {
service {
        "httpd":
        ensure => running,
        enable => true;
        "nfs":
        ensure => stopped,
        enable => false;
}
```

![图20-17（a） Puppet service开启启动](http://qiniu.imolili.com/小书匠/1594260796121.png)

![图20-17（b） Puppet service开启启动](http://qiniu.imolili.com/小书匠/1594260796123.png)

## Puppet exec资源案例

Puppet exec资源主要用于客户端远程执行命令或者软件安装等，相当于shell的调用，exec是一次性执行资源，在不同类里面exec名字可以相同。Puppet exec资源支持参数如下：
```
Parameters
    command, creates, cwd, environment, group, logoutput, onlyif, path,
    refresh, refreshonly, returns, timeout, tries, try_sleep, umask, unless,
    user
Providers
posix, shell, windows
command         			指定要执行的系统命令；
creates         			    指定命令所生成的文件；
cwd         				指定命令执行目录，如果目录不存在，则命令执行失败；        
group                       执行命令运行的账户组；
logoutput     				是否记录输出；
onlyif         				exec只会在onlyif设定的命令返回0时才执行；
path         				命令执行的搜索路径；
refresh =>true|false            刷新命令执行状态；
refreshonly =>true|false        该属性可以使命令变成仅刷新触发的，
returns         			    指定返回的代码；
timeout         			    命令运行的最长时间；
tries         				命令执行重试次数，默认为1；
try_sleep      				设置命令重试的间隔时间，单位为秒；
user         				指定执行命令的账户；
provider      				shell和windows；
environment   				为命令设定额外的环境变量；要注意的是如果设定PATH，PATH的属性会被覆盖。
```

1.  Agent服务器执行tar解压nginx软件包，代码如下，结果如图20-18所示：
```
node  default {
exec { 
	'Agent tar xzf nginx-1.12.0.tar.gz':
	path => ["/usr/bin","/bin"],
	user => 'root',
	group => 'root',
	timeout => '10',
	command => 'tar -xzf /tmp/nginx-1.12.0.tar.gz',
}
}
```

![图20-18 Puppet exec远程执行命令](http://qiniu.imolili.com/小书匠/1594260796130.png)

2.  Agent服务器远程执行auto_install_nginx.sh脚本，代码如下，结果如图20-19所示：
```
node  default {
file {
        "/tmp/auto_install_nginx.sh":
        source =>"puppet://192-168-149-128-jfedu.net/files/auto_install_nginx.sh",
        owner => "root",
        group => "root",
        mode => 755,
     }
exec {
        "/tmp/auto_install_nginx.sh":
        cwd => "/tmp",
        user => root,
        path => ["/usr/bin","/usr/sbin","/bin","/bin/sh"],
}
```

![图20-19 Puppet exec执行Nginx安装脚本](http://qiniu.imolili.com/小书匠/1594260796169.png)

3.  Agent服务器更新sysctl.conf，如果该文件发生改变，则执行命令sysctl -p，代码如下，结果如图20-20（a）、20-20（b）所示：
```
node  default {
file {
        "/etc/sysctl.conf":
        source =>"puppet://192-168-149-128-jfedu.net/files/sysctl.conf",
        owner => "root",
        group => "root",
        mode => 644,
     }
exec {
        "sysctl refresh kernel config":
        path => ["/usr/bin", "/usr/sbin", "/bin", "/sbin"],
        command  => "/sbin/sysctl -p",
        subscribe => File["/etc/sysctl.conf"],
        refreshonly => true
     }
}
```

![图20-20（a） Puppet exec更新执行触发命令](http://qiniu.imolili.com/小书匠/1594260796171.png)

![图20-20（b） Puppet exec更新执行触发命令](http://qiniu.imolili.com/小书匠/1594202798480.png)

## Puppet cron资源案例

Puppet cron资源主要用于安装和管理crontab计划任务，每一个cron资源需要一个command属性和user属性以及至少一个周期属性（hour，minute，month，monthday，weekday）。

Crontab计划任务的名字不是计划任务的一部分，它是puppet用来存储和检索该资源。假如你指定了一个除了名字其他的都和一个已经存在的计划任务相同，那么这两个计划任务被认为是等效的，并且新名字将会永久地与该计划任务相关联。Puppet cron资源支持参数如下：
```
Parameters
    command, ensure, environment, hour, minute, month, monthday, name,
    special, target, user, weekday
Providers
    crontab
user 					加某个用户的crontab任务，默认是运行puppet的用户；
command				要执行的命令或脚本路径，可不写，默认是title名称；
ensure      			    定该资源是否启用，可设置成true或false；
environment 			    crontab环境里面指定环境变量；
hour        			    设置crontab的小时，可设置成0-23；
minute     				指定crontab的分钟，可设置成0-59；
month       			指定crontab运行的月份，1-12；
monthday    			指定月的天数1-31；
name        			crontab的名字，区分不同的crontab；
provider    			    可用的provider有crontab默认的crontab程序；
target      			    crontab作业存放的位置；
weekday     			行crontab的星期数，0-7，周日是为0。
```

1.  Agent服务器添加ntpdate时间同步任务，代码如下，结果如图20-21所示：
```
node  default {
cron{
        "ntpdate":
        command => "/usr/sbin/ntpdate  pool.ntp.org",
        user => root,
        hour => 0,
        minute => 0,
  }
}
```

![图20-21 Puppet cron创建任务计划](http://qiniu.imolili.com/小书匠/1594260796194.png)

2.  Agent服务器删除ntpdate时间同步任务，代码如下，结果如图20-22所示：
```
node  default {
cron{
        "ntpdate":
        command => "/usr/sbin/ntpdate  pool.ntp.org",
        user => root,
        hour => 0,
        minute => 0,
        ensure => absent,
  }
}
```

![图20-22 Puppet cron删除任务计划](http://qiniu.imolili.com/小书匠/1594260796196.png)

## Puppet日常管理与配置

Puppet平台构建完毕，能够简单实用Puppet去管理客户端，对文件、服务、脚本、各种配置的变更，如果要管理批量服务器，还需要进行一些步骤的配置。

### Puppet自动认证

企业新服务器通过kickstart自动安装Linux操作系统，安装完毕，可以自动安装puppet相关软件包，Puppet客户端安装完毕，需向Puppet服务端请求证书，然后Puppet服务端颁发证书给客户端，默认需要手动颁发，可以通过配置让Puppet服务端自动颁发证书。

自动颁发证书前提是服务端与客户端能ping通彼此的主机名方可，配置自动颁发证书需Puppet服务器端的puppet.conf配置文件main段加入如下代码，如图20-23所示：
```
[main] 
autosign = true
```

![图20-23 Puppet 服务端添加自动颁发证书](http://qiniu.imolili.com/小书匠/1594260796198.png)

重启puppetmaster服务，并且删除192.168.149.130证书：
```
/etc/init.d/puppetmaster restart 
puppet cert --clean 192-168-149-130-jfedu.net
```

删除Puppet客户端SSL文件，重新生成SSL文件，执行如下命令自动申请证书：
```
rm -rf /var/lib/puppet/ssl/ 
puppet agent --server=192-168-149-128-jfedu.net --test
```

Puppet服务端会自动认证，即服务器端不必手动颁发证书，减轻人工的干预和操作，如图20-24所示：

![图20-24 Puppet客户端自动获取证书](http://qiniu.imolili.com/小书匠/1594260796200.png)

### Puppet客户端自动同步

Puppet客户端安装完，并且认证完之后，如果在Puppet服务端配置了node信息，客户端启动服务，默认30分钟自动与服务端同步信息，如何修改同步的时间频率呢，修改puppet客户端配置信息即可：

Puppet客户端配置puppet相关参数和同步时间，修改/etc/sysconfig/puppet配置文件，最终代码如下：
```
# The puppetmaster server
PUPPET_SERVER=192-168-149-128-jfedu.net
# If you wish to specify the port to connect to do so here
PUPPET_PORT=8140
# Where to log to. Specify syslog to send log messages to the system log.
PUPPET_LOG=/var/log/puppet/puppet.log
# You may specify other parameters to the puppet client here
PUPPET_EXTRA_OPTS=--waitforcert=500
```

/etc/sysconfig/puppet配置文件参数详解：
```
PUPPET_SERVER=192-168-149-128-jfedu.net 	指定Puppet master主机名；
PUPPET_PORT=8140						指定puppet master端口；
PUPPET_LOG=/var/log/puppet/puppet.log		puppet客户端日志路径；
PUPPET_EXTRA_OPTS=--waitforcert=500	获取Puppet master证书返回等待时间。
```

重启puppet客户端服务，户端会半个小时跟服务器同步一次配置信息：
`/etc/init.d/puppet restart`

可以修改与服务器端同步配置信息的时间，修改`vi /etc/puppet/puppet.conf`文件，在\[agent]段加入如下语句，表示60秒于puppet master同步一次配置信息，重启puppet，同步结果如图20-25所示：
```
[agent] 
runinterval = 60
```

![图20-25 Puppet客户端自动同步服务端配置](http://qiniu.imolili.com/小书匠/1594260796202.png)

### Puppet服务端主动推送

如上puppet客户端配置每60秒与服务端同步配置信息，如果服务器端更新了配置信息，想立刻让客户端同步，如何通知客户端来获取最新的配置信息呢，可以使用Puppet master主动推送的方式，让客户端更新服务端最新的配置信息。

Puppet服务器端使用puppet run命令可以给客户端发送一段信号，告诉客户端立刻跟服务器同步配置信息，配置方法如下：

修改Puppet客户端配置文件/etc/puppet/puppet.conf，在agent段加入如下代码：
```
[agent] 
listen = true
```

修改Puppet客户端配置文件/etc/sysconfig/puppet指定puppet master端主机名：
`PUPPET_SERVER=192-168-149-128-jfedu.net`

创建Puppet客户端配置文件namespaceauth.conf，写入如下代码：
```
[puppetrunner]
allow *
```

修改Puppet客户端配置文件auth.conf，在path /前添加如下代码：
```
path /run 
method save 
allow *
```

重启Puppet客户端： `/etc/init.d/puppet restart`

Puppet服务端执行如下命令，通知客户端来同步配置，也可以批量通知其他客户端，只需将客户端的主机名写入host.txt文件，如图20-26所示：
```
puppet kick -d 192-168-149-130-jfedu.net 
#puppet kick -d 'cat host.txt'
```

![图20-26 Puppet主动通知客户端同步配置](http://qiniu.imolili.com/小书匠/1594260796206.png)

## Puppet批量部署案例

随着IT行业的迅猛发展，传统的运维方式靠大量人力比较吃力，近几年自动化运维管理快速的发展，得到了很多IT运维人员的青睐，一个完整的自动化运维包括系统安装、配置管理、服务监控三个方面。如下为Puppet生成环境中应用案例。

某互联网公司新到100台硬件服务器，要求统一安装Linux系统，并部署上线以及后期的管理配置。对于Linux系统安装，需采用批量安装，批量安装系统主流工具为Kickstart和Cobbler，任选其一即可。

如果采用自动安装的话，我们可以自动初始化系统、内核简单优化、及常见服务、软件客户端等安装。当然puppet客户端也可以放在kickstart中安装并配置完毕。

当Linux操作系统安装完成后，需要对服务器进行相应的配置，方可在应对高并发网站，例如修改动态IP为静态IP、安装及创建Crontab任务计划、同步操作系统时间、安装Zabbix客户端软件、优化内核参数等，可以基于Puppet统一调整：

### Puppet批量修改静态IP案例

现需要修改100台Linux服务器原Dhcp动态获取的IP为Static IP地址，首先需有修改IP脚本，将该脚本推送到客户端，然后执行脚本并重启网卡即可，步骤如下：

1.  修改IP为静态IP的Shell脚本代码如下：
```
#!/bin/bash
#auto Change ip netmask gateway scripts 
#By author jfedu.net 2017
#Define Path variables
ETHCONF=/etc/sysconfig/network-scripts/ifcfg-eth0
DIR=/data/backup/`date +%Y%m%d`
IPADDR=`ifconfig|grep inet|grep 192|head -1|cut -d: -f2|awk '{print $1}'`
NETMASK=255.255.255.0
grep dhcp  $ETHCONF
if [ $? -eq 0 ];then
        sed -i 's/dhcp/static/g' $ETHCONF
        echo -e "IPADDR=$IPADDR\nNETMASK=$NETMASK\nGATEWAY=`echo $IPADDR|awk -F. '{print $1"."$2"."$3}'`.2" >>$ETHCONF
        echo "The IP configuration success. !"  
        service network restart
fi
```

2.  Puppet master 执行kick推送配置至Agent服务器远程，Puppet 客户端修改IP脚本代码如下，结果如图20-27（a）、20-27（b）所示：
```
node  default {
file {
        "/tmp/auto_change_ip.sh":
        source =>"puppet://192-168-149-128-jfedu.net/files/auto_change_ip.sh",
        owner => "root",
        group => "root",
        mode => 755,
     }
exec {
        "/tmp/auto_change_ip.sh":
        cwd => "/tmp/",
        user => root,
        path => ["/usr/bin","/usr/sbin","/bin","/bin/sh"],
}
}
```

![图20-27（a） Puppet主动通知客户端同步配置](http://qiniu.imolili.com/小书匠/1594203184663.png)

![图20-26 Puppet客户端IP自动配置为Static方式](http://qiniu.imolili.com/小书匠/1594260796234.png)

### Puppet批量配置NTP同步服务器

在100台Linux服务器上配置crontab任务，修改ntpdate与ntp服务端同步时间，操作步骤如下：

1.  Puppet master上创建客户端node配置，可以编写NTP模块，使用class可以定义模块分组，对不同业务进行分组管理，/etc/puppet/modules/ntp/manifests/init.pp配置文件代码如下，将原ntpdate同步时间从0:0分改成每5分钟同步一次时间，并且修改原pool.ntp.org服务器为本地局域网NTP时间服务器的IP地址：
```
class  ntp { 
Exec { path =>"/bin:/sbin:/bin/sh:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin"} 
exec { 
"auto change crontab ntp config": 
command =>"sed -i -e '/ntpdate/s/0/*\/5 /2'  -e 's/pool.ntp.org/10.1.1.21/' /var/spool/cron/root", 
 } 
} 
```

2.  在/etc/puppet/manifests目录创建两个文件，分别为modules.pp和nodes.pp，模块入口文件以及node配置段。 modules.pp配置文件内容如下：
`import "ntp"`

nodes.pp配置文件内容如下：
```
node default 
{
include ntp 
}
```
3.  在site.pp 中加载导入modules.pp 和nodes.pp名称，site.pp代码如下：
```
import "modules.pp"
import "nodes.pp"
```

4.  Puppet master 执行kick推送配置至Agent服务器远程，Puppet 客户端最终结果如图20-28（a）、20-28（b）所示：

![图20-28（a） Puppet服务端class模块配置](http://qiniu.imolili.com/小书匠/1594260796255.png)

![图20-28（b） Puppet主动通知客户端修改NTP同步配置](http://qiniu.imolili.com/小书匠/1594260796258.png)

当服务器分组之后，为了更好的管理和配置，可以使用正则表达式来进行定义node，在定义一个node节点时，要指定节点的名字，并使用单引号将名字引起来，然后在大括号中指定需要应用的配置。

客户端节点名字可以是主机名也可以是客户端的正式域名，目前Puppet版本还不能使用通配符来指定节点，例如不能用\*.jfedu.net，可以使用正则表达式，如下代码：
```
node /^Beijing-IDC-web0\d+\-jfedu\.net {
    include  ntp
}
```

如上规则会匹配所有在jfedu.net域并且主机名以Beijing-IDC开头，紧跟web01、web02、web03...web100...等节点，由此可以进行批量服务器的分组管理。

### Puppet自动部署及同步网站

企业生产环境100台服务器，所有服务器要求要求数据一致，可以采用rsync同步，配置rsync服务器端，客户端执行脚本命令即可，同样可以使用Puppet+Shell脚本来同步，这样比较快捷，也可以使用Puppet rsync模块。

1.  Puppet服务器端配置，/etc/puppet/modules/www/manifests/init.pp代码如下：
```
class  www  { 
Exec { path =>"/bin:/sbin:/bin/sh:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin"} 
file { 
"/data/sh/rsync_www_client.sh": 
source =>"puppet://192-9-117-162-tdt.com/files/www/rsync_www_client.sh", 
owner =>"root", 
group =>"root", 
mode =>"755", 
} 
file { 
"/etc/rsync.pas": 
source =>"puppet://192-9-117-162-tdt.com/files/www/rsync.pas", 
owner =>"root", 
group =>"root", 
mode =>"600", 
} 
exec { 
"auto  backup  www  data": 
command =>"mkdir -p /data/backup/`date +%Y%m%d`；mv /data/index /data/backup/www/`date +%Y%m%d` ； /bin/sh /data/sh/rsync_www_client.sh ", 
user =>"root", 
subscribe =>File["/data/sh/rsync_www_client.sh"],
refreshonly =>"true", 
 } 
} 
```

2.  在/etc/puppet/manifests目录创建两个文件，分别为modules.pp和nodes.pp，模块入口文件以及node配置段。modules.pp配置文件内容如下：
`import "www"`

nodes.pp配置文件内容如下：
```
node /^Beijing-IDC-web0\d+\-jfedu\.net {
include  www
}
```

3.  在site.pp 中加载导入modules.pp 和nodes.pp名称，site.pp代码如下：
```
import  "modules.pp"
import  "nodes.pp"
```

Puppet master端批量执行通知客户端来同步配置，命令如下：
```
puppet kick -d --host `cat hosts.txt`
```

4.  cat hosts.txt内容为需要同步的客户端的主机名：
```
Beijing-IDC-web01-jfedu.net 
Beijing-IDC-web02-jfedu.net 
Beijing-IDC-web03-jfedu.net 
Beijing-IDC-web04-jfedu.net 
```
