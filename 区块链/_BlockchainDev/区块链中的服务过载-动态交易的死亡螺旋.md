---
title: 区块链中的服务过载-动态交易的死亡螺旋
tags: 小书匠语法,技术
renderNumberedHeading: true
grammar_abbr: true
grammar_table: true
grammar_defList: true
grammar_emoji: true
grammar_footnote: true
grammar_ins: true
grammar_mark: true
grammar_sub: true
grammar_sup: true
grammar_checkbox: true
grammar_mathjax: true
grammar_flow: true
grammar_sequence: true
grammar_plot: true
grammar_code: true
grammar_highlight: true
grammar_html: true
grammar_linkify: true
grammar_typographer: true
grammar_video: true
grammar_audio: true
grammar_attachment: true
grammar_mermaid: true
grammar_classy: true
grammar_cjkEmphasis: true
grammar_cjkRuby: true
grammar_center: true
grammar_align: true
grammar_tableExtra: true
---

[toc]

时间来到了2020年8月14日,以太坊的gas price已经爬到了300gwei之上,甚至有些块需要在400gwei之上.

最近看到了疯狂,看到了暴雷,当行情来临的时候,就算不是参与者依然是很兴奋的,因为这会有很多新生的事物,可以被研究.

今天就想从这超高的gasprice衍生出来,谈谈当时开发eth相关项目时令人头疼的nonce和这里面可能的攻击手段.

 随着以太坊的价格节节高涨,DEFI项目的火爆,预言机使的区块链智能合约所能实现的业务的扩展,整个以太坊的交易越来越多
 
如果说没有被打包的交易 可以说是区块链交易的拥堵,那么更进一层可以说交易被完全卡住就是区块链内存池的拥堵

由此衍生出来想讨论的目标,mempool或者说是txpool的设计.

目前我们可以显而易见的看到,区块链网络中的大部分角色:
- 普通的操作者,有可能依托的只是钱包客户端进行交易,消息滞后,对核心技术并不敏感
- 去中心化DEFI项目的操作者,这一部分仅看作是自然人的交易,这些人是目前火爆的项目下的入场者
- 被动的机器人,只是按照设定的好的条件在达成时不知疲倦的产生交易
- 聪明的机器人,尝试着监控整个区块链的网络,以期占的一点先机,比如说先被打包提前出逃,或者是获得更高的收益
- 恶意的机器人,通过各种手段对区块链进行攻击,以达到特定的目的.
- 矿工 执行打包,或者说是提供了内存池容纳待打包的交易

从以太坊去区块链上的关键技术设计看,有如下的若干个关键点:
- 外部账户发起一个交易必须将交易发送到节点上才能被接受进而被打包到确定的区块中
- 外部账户发起的交易必须是按照nonce从0开始依次递增顺序被打包的,不能跳过,如果有空缺的nonce存在,则后续nonce的交易都不会被打包
- 区块链中的自动化调整都有着滞后性,以太坊的每个区块的gas总量是相对固定的,不能随意扩大缩小来应对交易数量的变更
- 矿工的物理设备时有性能限制的,即提供的内存池不是可以无线容纳的,他会排序,容纳或丢弃交易
- 外部的gasprice估算服务由于是估算若干个区块内进行打包,所以一般都会考虑内存池交易中gasprice的平均水平
- defi项目使得去中性化的交易变得无法被人为主动的阻止,即自动化动态交易的机器人占据了整个市场中本来就极重的份额
- 预言机的参与更是使得与链下的一些数据得以被彻底自动化,从而使一些人"放心"的运行了代码而忽视了未被察觉的不稳定因素

最后的最后,攻击的目的在于,将区块中的打包交易控制为自己想要达成的交易,而将一些账户的交易排挤开来.

这种条件的达成是非常非常有想象力的.想象一下,你可以控制绝大多数被打包的交易,而只有被打包的交易才是有效,所以整个网络中一段时间就相当只有你能改变状态.

那么我们就来剖析一下这到底有哪些因素影响之下达成的这个结果呢?

> 从我的个人观点来说,这并不像一个人或组织的布局,而更像是若干不同利息的势力相互作用之下形成的一个神仙局,很难被探测,很难被阻止,一旦到达的触发的起点,就无休无止直到整个网络回到冷静的共识中.但这种严重滞后的最终一致性已经在足够长的时间内达成了足够的破坏性.

-------------

首先需要一个契机,需要将整个网络中交易的被打包从一个按照顺序期望执行变成极度紧急.

也就是说,这里面其实也有一个平衡,理想的平衡时,大多数人的交易其实并不紧急,他们给出了较低的gasprice,而需要迫切的被打包的交易提高了gasprice.就算有较多的交易都提高了gasprice,那么gasprice也只是缓慢的递增,而相对来说一个区块中被打包的数目与产生的交易数量有相关并且不会相差的太大.即区块链网络尽可能的服务,满负荷的运行着.

而当一个契机出现的时候,情况就反过来了,绝大多数人想要尽快的完成交易,这时由于各种各样的原因导致,就算提高gasprice都无法被打包.

操作一将内存池充满.内存池的拥堵是必然的.正常的情况下内存池能够容纳未打包的交易,只有的确给的太低的gasprice才会被丢弃.而这里需要拥堵到让矿工必须选择应该打包哪些交易,而哪些交易必须被抛弃的程度.即一个被丢弃的交易比例的问题.即内存池中可上链部分(矿工们认为gasprice给的足够高有可能被打包)的比例大幅下降,这就可以引起实际打包的手续费快速的上升.

简单的来说就是想要的交易使用极高的手续费填满整个block的gas limit,然后用大量的低gasprice充满内存池,一方面排挤其他的有效交易,一方面拖延外部gas price的估算服务让外面难以察觉.

攻击者可以以一个刚刚够达到节点的最低手续费率,以不同的数据反复的发送相同nonce的交易,以达到就算之前的交易被丢弃后又非常快速的被加入到内存池中以排挤其他的交易

这里面有几点是要着重提及的:
- 一个区块中被打包的大部分交易都是由机器人产生的,即自动化产生的,而不是由人手动操作的,自动化的交易系统只会加剧这种拥堵状况
- 拥堵发生的时候,简单的从explorer是很难判定的,上文已经提过,只是gas price的上升会让极其或人简单的提高gas price而不会想到内存池中的问题.更不用说攻击者可以用虚假的情况来欺骗gas price估算服务
- 这种行为很难追踪,起码单独的一个节点仅靠自己内存池中的数据很难卓总,更别说explorer上成功打包的数据看出来了.
- 内存池的操作是一直不断,转瞬即逝的,并且一般的客户端和用户对内存池都经常被忽略或者说是不受重视
- 交易拥堵一般会维持在一个相对平衡的位置,即一边慢慢的提高区块的gaslimit应对增多的交易.一方面会提高gasprice来决定每个区块打包的交易,然后在一个特定的阈值达成滞后被瞬间击溃成一个混乱的情况
- 矿工节点对整个网络中的情况无法完整准确的预估,但是他对自己节点的资源是很清楚的,他会做出删除和拒绝部分交易的行为.于是交易池会用最低手续费门槛来选择放弃哪些交易。虽说这些被丢掉的交易并没在整个网络中 “完全丢失”，但被丢掉的交易可能会遭遇显著的时延，直至网络条件回归正常。
- 在这个过程中可想而知,由于节点同步的够快够及时,就会导致在某些账户完全不之情的情况下丢掉了某个nonce的交易,导致这个账户后续大量的交易被卡住,就算一些相对聪明的机器人会进行重发交易,但是由于难以获得真正能被打包的gas price,这些交易只是重复的被丢弃而已,反而还加重了整个网络的拥堵情况,这是一个令人绝望的情况.或者说令机器人绝望的情况.
- 与此同时，网络的堵塞导致进入内存池的 Gas Price 门槛随之迅速提高，因此最初的一些交易现在会因为 Gas Price 太低而被拒绝。而且，因为之前被删除的交易不能回到交易池中来，交易的 nonce 空缺问题又变得更严重了。事实上，一些节点实现会在一段时间内主动无视掉这些被拒绝的交易，以保护自己不受点对点网络中的泛滥攻击（spamming）影响。所以， nonce 空缺实际上会锁住这些受影响的地址，使得他们无法完成新的交易。
- 卡壳交易更有可能影响会发出许多新交易的地址，包括自动化交易系统、支付网络，甚至交易所。这些系统想回到正轨，但通常会加剧拥堵，因为越来越多交易被推迟处理。

简单的来说,就是攻击者对内存池发起了切实存在的攻击.使得内存池中极度拥堵,迫使矿工丢弃了之前的低gasprice交易.
同时又用不停的相同nonce的相对低gas price交易重发填满内存池.这一方面组织了相对较低手续费的交易进入内存池,同时也欺骗了外部的gas price估算服务,延缓了情况被发现的时机.

矿工们为了保护资源,只能提高gas limit 和 最低gas price,这就会导致相当一部分之前的低 gas price和提交了一大批交易过来但是gas price不够的交易被抛弃,却完全不会对外反馈

于是外部对技术不关注,或者咨询滞后的人们的交易无法被确认.
被动的交易机器人发出的交易都被卡住,无法被确认.
聪明的交易机器人由于错误的gas price设置也无法被确认,同时还增加了网络的拥堵情况

于是现在只有真正看到这个状况的人,用此时真实能被打包的gas price发出的交易才能被确认打包.

-------------

为什么我之前说这有点像一个神仙局,就是这里看似进行攻击的机器人你很难说他是真的在执行攻击.还是说只是在做聪明的交易机器人执行重发交易.
因为由于交易池中虽然能够被当时区块打包的交易手续费的确很高,但是整体进入内存池的交易的手续费率平均下来依然不是非常高的,即这里面产生了上链所需的gas价格和进入内存池的交易价格之间的偏离.
这是会导致外部的gas price服务失效,因为增加gas price的行为总是会追不上真实被打包的gas price上涨的速度,处于一个追赶的情况,这也是去中心化调整滞后性的一个体现

这个情况直接导致的现象就是交易池完全失真,只有真正高费率的交易被正好打包.剩下来的都是低费率充斥在内存池却刚好卡住矿工收入内存池的线上,对外欺骗了其他人没有提高费用或者卡住其他账户就算提高了费用,但没有觉察到自己的交易已经有被丢弃nonce所卡住.

不过我觉得这里的攻击行为依然是可以得到确认的,因为从blocknative上一篇对2020.312大瀑布的盘点文章上分析,这些交易都没有提高过gas price而反复不停的发送相同的交易或仅仅改变了些许内容以生成不同的txhash.因为我们都直到,内存池对bumpfee是要求提高gas price有一个 thresholds,必须提高 10%才行.那么他们怎么能把这些交易打到内存池中的呢?答案很简单：异常高的交易丢弃率导致节点 “失忆”,他们只是预估节点们应该由于手续费低已经被之前的交易给排除掉了,所以就应该会接受这个新的交易.这很容易都能实现 反正最后都不期待被打包,所以这些交易并不是交易,而只是一种工具.也许只有在整个网络被动的从崩溃中回复,即想要逃离的用户缓慢的反应过来,在支付了极高的gasprice撤离之后,攻击者也达到了其特定的目的后,慢慢平复下来的网络才有能对这些交易进行一次最终的打包,一般也就一笔.攻击的成本极其低廉.

有没有解决办法？你得主动发现自己何时开始遭遇卡壳。这可能有点难，因为你的交易可能仅在某些节点处是卡壳的，但并不是在所有节点处都面临卡壳。因此，你必须确定第一笔被丢弃、导致 nonce 空缺的交易，然后立即用可以得到打包的 Gas Price [加速](https://blog.blocknative.com/blog/speed-up-transactions)让这笔交易上链。最后，你还得继续监控一开始发现卡壳的交易，确保它从不能处理的队列中移回到了交易池的待打包部分中，并成功上链。如果你的交易还是卡壳，重复上述加速步骤，直到你可以确认所有导致 nonce 空缺的交易都已成功上链。

有没有办法察觉? 你得关注着内存池,这很困难,因为一个节点不行,一个地区也不行.得要有大范围得节点群一起检测才能行之有效.
简单得来说若干个指标
- 实际打包得交易gas price和内存池中的gas price偏差加大
- 内存池被充满而开始被迫丢弃交易得时候

--------------------------

**这里引用了 Blocknative 对 2020年3.12的暴跌事件的盘点,我的总结也得益于这篇文章所提供的数据和分析**

我们可以看到这种攻击的成果是极其有效的.而且产生的影响和可能的后果是极其富有想象力的

从整体上来看，虽然进入交易池的交易数量急剧增加，交易池中还是有很大一个比例的交易 Gas Price 被人为压低了。

![6.png](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/区块链中的服务过载-动态交易的死亡螺旋/2020814/1597400755051.jpg)

<center>- 从 UTC 时间 8 点到 10 点间的交易 Gas Price 箱型图（按分钟划分）。蓝线表示最终上链的交易的情形。橙线表示从未上链过的交易的情形。-</center>

拿出一笔 Hammerbot 交易作为例子（我们用的是一笔 nonce 值为 3070 的交易），可能有说明价值。这里是最终的交易哈希值：[0x5b00c13020b82c9e8a098393564feca976dbbd2e8da6c54263f6e492be56fbfb](https://etherscan.io/tx/0x5b00c13020b82c9e8a098393564feca976dbbd2e8da6c54263f6e492be56fbfb)。

仅仅用你惯用的区块浏览器检视这笔交易并不能给出除了其区块确认信息以外的洞见。表面上来看，这笔交易平平无奇。但 Blocknative 的交易池数据平台检测到了这笔交易上链之前使用这个 nonce 值的 418 笔独特交易。这些交易都是在一个小时内出现的，也就是这些置换交易平均每 6.86 秒重发一次，而某些置换交易之间的时间差不超过 0.1 秒。

![7.png](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/区块链中的服务过载-动态交易的死亡螺旋/2020814/1597400755058.jpg)

<center>- 地址 0x5cf2fa4e0c84e71fd2e4fa86d2fa64b7a50a6fc0 从 UTC 时间 9 点开始在相连的 4 个 nonce 上发起的置换交易次数（按分钟计）-</center>

大多数置换交易都使用同样高的 Gas Price，都是因为节点的交易丢弃机制才作为 “新” 交易成功进入到节点的交易池内。只有最后一笔想要上链的置换交易才需要给出更高的 Gas Price，然后被打包到区块内。

![8.png](https://raw.githubusercontent.com/OliverRen/olili_blog_img/master/区块链中的服务过载-动态交易的死亡螺旋/2020814/1597400755059.jpg)

<center>- 地址 0x5cf2fa4e0c84e71fd2e4fa86d2fa64b7a50a6fc0 从 UTC 时间 9 点开始在相连的 4 个 nonce 上的平均 Gas Price（按分钟作平均化）-</center>

这种模式使我们很难说这些 Hammerbot 交易到底是有心还是无意的。实际上，我们的系统在一分钟之内记录下了超过 20 个从 UTC 时间 9：05 开始活跃的可能的 Hammerbot 地址：

| 地址 | Nonce | 一分钟之内的置换交易笔数 |
| --- | --- | --- |
| 0xdd3b6ae71ff420375fefaa2448046a37beeed800 | 9211 | 22 |
| 0x704bf43e578b2b912584495467c3a2210deaec11 | 7307 | 20 |
| 0x56f0bdbdf48556ed41248021fbc8027f69c41f27 | 5004 | 19 |
| 0x4a1351523071ed88d20afd1d10cda75d1b34f4e7 | 6644 | 19 |
| 0x2a7139e98f47c2fc65aec0de9a3adb8ffd46206a | 10712 | 19 |
| 0x602bf7ba827a61d708614eb35284e79654c7e58f | 8458 | 18 |
| 0xe6919901cef07c15373feac6871046848efd4212 | 2745 | 17 |
| 0x58500f55ac86a3022703806a7415cac321cce2a1 | 2587 | 16 |
| 0x6861d397f7ff510a1ab4bb60434d8a9c4dd01240 | 5837 | 16 |
| 0x5cf2fa4e0c84e71fd2e4fa86d2fa64b7a50a6fc0 | 3067 | 15 |
| 0x3a711e39640b802d201391d14d5f2d3159f07957 | 2279 | 14 |
| 0x4769ad67bce2779d1374675069a3b78b8dafbea6 | 2671 | 14 |
| 0x97e7ba1f2db224dac7e0a812a071474e7c60819a | 9715 | 14 |
| 0x124f58b41fd43a498fe7041bc2d9d5813c4f80d7 | 2379 | 13 |
| 0x124f58b41fd43a498fe7041bc2d9d5813c4f80d7 | 2379 | 13 |
| 0x82b1e33c6465a9bedefd4af8a2c1cfc1c874bfbe | 2516 | 13 |
| 0x3a711e39640b802d201391d14d5f2d3159f07957 | 2354 | 12 |
| 0x95227df275141c9bbf679f695668a838a31459fc | 2435 | 12 |
| 0x5e4f7ce2607c39f4ec08355e2ea48e50f6f77bff | 9208 | 12 |
| 0x3046a9743a1b8d967f2ddb014e341b0eca41c191 | 6193 | 10 |
| 0xb123a59c4e3ff44e57b3113234fa6ebe804e996d | 2223 | 8 |
| 0xc1bfbc44536200b02f92aec4dee08ea390fa0535 | 2187 | 6 |

注意：这些特征明显的、使用同样的 Gas Price 重发被丢弃交易的 Hammerbot 行为，也可能跟最近大家讨论的 “backrunning” 行为有关。见[此处](https://twitter.com/PhABCD/status/1285170944160522241)和[此处](https://github.com/ethereum/go-ethereum/issues/21350)。

**交易池漏洞对 MakerDAO 的影响**

MakerDAO 的[担保债仓](https://blog.makerdao.com/say-goodbye-to-cdps-and-hello-to-maker-vaults/)（CDP）是用户生成稳定币 DAI 时托管被锁定的担保品 ETH 的智能合约。因为 ETH 的价格有波动，而 DAI 希望能保持 1 美元的价格，所以维持一个开放的 CDP 所需的担保品数量是不断变动的。

当 3 月 12 日 ETH 价格暴跌时，大量的 CDP 立即变成了担保不足的状态，需要被[强制清算](https://community-development.makerdao.com/makerdao-scd-faqs/scd-faqs/liquidation)。系统为保证担保品清算时可以获得竞争性的市场价格，安排了折价机制：参与清算者可以以折价买到担保品 ETH；这就使得许多人都愿意运营多种多样的 [Keeper 机器人](https://developer.makerdao.com/keepers/)。清算活动的表现形式为[拍卖](https://github.com/makerdao/auction-keeper)。

任何 Keeper（看护者）都可以用 _链上_ 出价参与拍卖，而一个看护者出价之后，另一个看护者想要与之竞争必须在 10 分钟之内发送竞拍价更高的交易。每当有新的竞拍交易到达，都会刷新 10 分钟的竞拍窗口期。如果 10 分钟之内系统没有收到更高的出价，则拍卖结束，最高出价者胜出。_[注意：在 “黑色星期四” 下午，MakerDAO 把竞拍窗口期从 10 分钟提高到了 6 小时。]_

**但是，当矿工节点因为网络哟难度和交易池压缩而以异常高的比例丢弃交易时，许多看护者的交易都被卡住了，因此根本没能及时让清算 CDP 的竞拍交易成功上链。**结果就是看护者们无法在由 0 价格竞拍交易开启的窗口中可靠地开展竞争，即使看护机器人正确地发现了 0 价格拍卖并发送出了更高出价的交易也没用。

最终，因为拥堵和实际手续费的混淆，看护者无法恰当地解读出 Gas Price 的实际上涨幅度，看护者的交易也因此被节点丢弃。接下来是产生 nonce 空缺、交易在使用默认交易池设置的节点处卡壳。**遭遇此种情形的看护者机器人为其他拍卖发出的所有后续竞拍交易会全部被卡住，让该看护者根本无法在 10 分钟的竞拍窗口内参与交易，最终让 0 价格竞拍交易得逞**。

下面我们用 1866 号拍卖作为例子来说明上述过程：

1.  一个 “0 价格竞拍机器人” 在 UTC 时间 15:59:50 时以 200 Gwei 的价格发送一笔 0 价格竞拍交易。该交易在 26 秒后成功上链，10 分钟倒计时就此开始。
2.  一个 “诚信看护者机器人” 在 16:08:01 时以 450 Gwei 的 Gas Price 发送一笔竞价交易。这笔交易是在 10 分钟内发出的 —— 之隔了 8 分 11 秒 —— 而且 Gas 价格还是最初那笔 0 价格竞拍交易的 2.5 倍。如果能在接下来的 1 分 49 秒内被打包到区块中，1866 号拍卖就会像大家预期的那样进行。但是，这笔竞拍交易因为这个好机器人之前发送的一笔交易被丢弃（也就是产生了 nonce 空缺）而被卡住了。
3.  这个好机器人在 16:15:31 又发出一笔 4500 Gwei 的竞价交易。但是哪怕 Gas Price 提高了 10 倍也无济于事，因为这个地址被 nonce 空缺锁死了。再然后，等到竞价交易不再被卡的时候，已经过了 10 分钟的窗口期，交易自然就失败了。

上述模式可能重复了一整天，最终导致总计 832 万美元的担保品被 0 价格拍走。值得指出的是，大多数 Hammerbot 的活动似乎都在当天较早的时候发生，这样就造成了后来影响到 Keeper 机器人交易的拥堵情况。

Gas Price 的迅速上升、导致 Gas 价格估计失灵的交易池压缩，同样对其它价格信息传输机制造成了负面影响。这导致了定价方面的混乱，也有可能使得面临清算风险的 CDP 持有者推迟了添加担保品的决定。

**总结**

总结一下，我们对 “黑色星期四” 交易池状况的事后检验暗示了下述情况：

1.  多种 Hammerbot 的活动导致挖矿节点的交易池饱和。这推高了以太坊网络的拥堵程度并使之不断上升。
2.  发送许多以同样的 Gas Price 发出的置换交易在点对点 gossip 层和节点本身产生了巨大的开销。
3.  正常交易的传播受到阻碍，大量的交易被挖矿节点丢弃或者拒绝。
4.  这又反过来提高了出现 nonce 空缺和卡壳交易的几率，还扭曲了对 Gas Price 的估计。
5.  虽然自动化的交易系统通常被设计成会自动提高交易的 Gas Price，许多交易系统并不能很好地处理 nonce 空缺问题 —— 甚至是完全束手无策。

以上就是我们在研究过程中的发现。我们的数据集可能还能揭示出更多的证据 以及/或者 新的发现来支持或证否我们的结论。

为加速这个发现过程，我们现在把那两天的交易池存档数据开放给社区，我们希望这能促进对交易池在 “黑色星期四” 及以太坊网络其它类似事件中所扮演的角色的研究。

**建议：保护好你自己，以及你的用户**

交易池是区块链生态系统非常关键的一环，虽然它瞬息万变，常常被忽略。因此，交易池中藏着很多开发者和用户 “完全无知的未知之物”。

现在，我们并不知道有多少人在开发这样的利用交易池弱点的技术 —— 只是显然有人在利用交易池的特点。我们也不知道有多少这样的弱点存在 —— 只是那些复杂的利用方法似乎已经在现实中证明了其有效性。

**因此，我们建议所有交易、所有协议、所有钱包供应商和交易员：**

1.  **持续监控交易池的情况**，注意（1）发现交易池开始变得拥堵的时机；（2）交易丢弃率和拒绝率的变化。
2.  **理解交易 nonce 排序的细微差别**。即使合理构造的交易也可能被卡在网络的某个角落。
3.  **主动观察被卡壳的交易**，并且要知道加速先前的哪一笔交易能使发送交易的地址脱困。
4.  **基于交易池中对矿工有吸引力的部分来计算 Gas Price**。还需要知道你所依赖的 Gas Price 报告服务所用的算法。
5.  **在高度拥堵期间，不要假设交易待打包的情形是可以预测的**。先防范，你要监控每一笔交易，了解每一个细节，包括 Gas 是否充分，交易是不是被丢弃、被卡壳，会不会被人抢跑（front-running），等等。