---
title: 20_管理存储交易
tags: 
---

[toc]

#### Lotus miner 管理交易

这里把交易的内容抽离出来的主要原因是在 filecoin 整个网络的初期特别是小矿工压根是不会牵扯到存储和检索的交易的,并且就算没有存储和检索的交易,单纯的对垃圾数据进行seal也可以增长有效存力,进行出块.

存储交易的几个主要的阶段分别是 
- 数据传输 (transfer 用于在线交易) 或数据导入 (import 用于离线交易); 
- 矿工对带有交易数据的sector进行密封; 
- 矿工每24小时不间断的在订单时间内对 sector 进行时空证明

1. 启用和禁用存储交易

miner对交易的启用和禁用可以有两种方法:
	- 配置法,修改 $LOTUS_MINER_PATH/config.toml 文件下的 `[DealMaking]`,然后重新启动 miner
	- 命令法,由于修改配置需要重启 miner,所以较为推荐使用命令法来进行修改,同时命令也会修改文件中的值,如果后续真的重新了矿机,其配置也是生效的

要禁用存储交易 `lotus-miner storage-deals selection reject --online --offline`

要启用存储交易 `lotus-miner storage-deals selection reset`

你可以使用命令 `lotus-miner storage-deals selection list` 来进行校验

2. 设定存储交易的要价

达成存储交易一方面需要有需求,另外一方面就是矿工的价格和条件了.

这是由矿工进行设置的,只要达成条件,那么矿工就可以自动的接受.

这是由命令 `lotus-miner storage-deals set-ask` 来设置的. 举例如下:

``` shell
lotus-miner storage-deals set-ask \
  --price 100000000000 \
  --verified-price  100000000000 \
  --min-piece-size 128MiB \
  --max-piece-size 32GB
```

上述例子即矿工将交易价格设置为 每GiB每epoch的价格为 100000000000 attoFIL(即100 nanoFIL).

所以如果客户需要存储 5GiB的数据一周,那么就需要支付 

`5GiB * 100nanoFIL/GiB_Epoch * 20160 Epochs = 10080 microFIL`.

矿工可以使用命令 `lotus-miner storage-deals get-ask` 查看自己的要价

使用命令 `lotus-miner storage-deals list -v` 来查看当前正在进行的交易 

相对的客户可以使用 `lotus client query-ask <minerID>` 来查询指定矿工的要价.

3. 使用过滤器限制交易

这主要是通过配置文件中 `[DealMaking]` 中的 `Filter` 来实现的

他可以通过一个外部程序或者脚本返回 true 来接受交易,否则就拒绝.

如果要禁止接单直接把 lotusminer 下 config.toml 的  `Filter = ""` 改成  `Filter = "false"` 重启miner 就可以了

4. 封锁内容

如果有一些内容不是很好,黄色啊之类的,那么可以通过cid进行阻止他们传入.下列命令接受一个文件,文件内容应该每行包括一个cid.

`lotus-miner storage-deals set-blocklist blocklist-file.txt`

可以使用命令 `lotus-miner storage-deals get-blocklist` 查看阻止列表 

或使用命令 `lotus-miner storage-deals reset-blocklist` 来清除列表

5. 在sector中接受多个交易,操作效率就更高,这减少了密封和验证的操作.这主要是由配置中的 `[Sealing]` 的 `WaitDealsDelay` 来控制的,即等待多少时间.

6. 离线交易的数据导入,使用命令 `lotus-miner deals import-data <dealCid> <filePath>`

7. 检索交易的文档暂缺







#### 使用Lotus存储数据

术语解释 CAR文件 : [Specification : Content Addressable aRchives](https://github.com/ipld/specs/blob/master/block-layer/content-addressable-archives.md)

- 数据必须打包到一个CAR文件中,这里可以使用以下命令
	
	`lotus client generate-car <input path> <output path>` </br>
	`lotus client import <file path>`
	
- 列出本地已经导入或者创建car的文件
	
	`lotus client local`
	
- 数据必须切割到指定的扇区大小,如果你自己创建了car文件,确保使用--czr标志来进行导入	
- 查询矿工,询问价格,开始存储交易(在线交易)
	
	`lotus state list-miners` </br>
	`lotus client query-ask <miner>` </br>
	`lotus client deal` 
	
- 扇区文件可以存储的容量,首先计算使用的是1024而不是1000,同时对于每256位 bits,需要保留2位作为证明之需.即32GB的sector可以存储的容量是 2^30\*254\/256 字节
- 离线交易,生成car,然后生成对应所选矿工的piece块的CID,然后提出离线交易
	
	`lotus client generate-car <input path>	<output path>` </br>
	`client commP <inputCAR filepath> <miner>` </br>
	`lotus client deal --manual-piece-cid=CID --manual-piece-size=datasize <Data CID> <miner> <piece> <duration>` </br>
	`lotus-miner deals import-data <dealCID> <filepath>`
	
- 从IPFS中导入数据,首先需要在lotus配置中打开 UseIpfs,然后可以直接将ipfs中的文件进行在线交易
	
	`lotus client deal QmSomeData t0100 0 100`
	
#### 使用Lotus检索交易

- 查询自己的数据被哪些矿工存储
	
	`lotus client find <Data CID>`
	
- 进行检索交易
	
	`lotus client retrieve <Data CID> <out file>`
	

